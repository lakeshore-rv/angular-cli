"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const crypto = require("crypto");
const fs = require("fs");
const path = require("path");
const ts = require("typescript");
const glob = require('glob');
const distRoot = path.join(__dirname, '../dist');
const { packages: monorepoPackages } = require('../.monorepo.json');
const hashCache = {};
function _getHashOf(pkg) {
    if (!(pkg.name in hashCache)) {
        hashCache[pkg.name] = null;
        const md5Stream = crypto.createHash('md5');
        // Update the stream with all files content.
        const files = glob.sync(path.join(pkg.root, '**'), { nodir: true });
        files.forEach(filePath => {
            md5Stream.write(`\0${filePath}\0`);
            md5Stream.write(fs.readFileSync(filePath));
        });
        // Update the stream with all versions of upstream dependencies.
        pkg.dependencies.forEach(depName => {
            md5Stream.write(`\0${depName}\0${_getHashOf(exports.packages[depName])}\0`);
        });
        md5Stream.end();
        hashCache[pkg.name] = md5Stream.read().toString('hex');
    }
    const value = hashCache[pkg.name];
    if (!value) {
        // Protect against circular dependency.
        throw new Error('Circular dependency detected between the following packages: '
            + Object.keys(hashCache).filter(key => hashCache[key] == null).join(', '));
    }
    return value;
}
function loadPackageJson(p) {
    const root = require('../package.json');
    const pkg = require(p);
    for (const key of Object.keys(root)) {
        switch (key) {
            // Keep the following keys from the package.json of the package itself.
            case 'bin':
            case 'description':
            case 'dependencies':
            case 'name':
            case 'main':
            case 'peerDependencies':
            case 'optionalDependencies':
            case 'typings':
            case 'version':
                continue;
            // Remove the following keys from the package.json.
            case 'devDependencies':
            case 'scripts':
                delete pkg[key];
                continue;
            // Merge the following keys with the root package.json.
            case 'keywords':
                const a = pkg[key] || [];
                const b = Object.keys(root[key].concat(a).reduce((acc, curr) => {
                    acc[curr] = true;
                    return acc;
                }, {}));
                pkg[key] = b;
                break;
            // Overwrite the package's key with to root one.
            default:
                pkg[key] = root[key];
        }
    }
    return pkg;
}
function _findAllPackageJson(dir, exclude) {
    const result = [];
    fs.readdirSync(dir)
        .forEach(fileName => {
        const p = path.join(dir, fileName);
        if (exclude.test(p)) {
            return;
        }
        else if (fileName == 'package.json') {
            result.push(p);
        }
        else if (fs.statSync(p).isDirectory()) {
            result.push(..._findAllPackageJson(p, exclude));
        }
    });
    return result;
}
const tsConfigPath = path.join(__dirname, '../tsconfig.json');
const tsConfig = ts.readConfigFile(tsConfigPath, ts.sys.readFile);
const pattern = '^('
    + tsConfig.config.exclude
        .map(ex => path.join(path.dirname(tsConfigPath), ex))
        .map(ex => '('
        + ex
            .replace(/[\-\[\]{}()+?./\\^$|]/g, '\\$&')
            .replace(/(\\\\|\\\/)\*\*/g, '((\/|\\\\).+?)?')
            .replace(/\*/g, '[^/\\\\]*')
        + ')')
        .join('|')
    + ')($|/|\\\\)';
const excludeRe = new RegExp(pattern);
// Find all the package.json that aren't excluded from tsconfig.
const packageJsonPaths = _findAllPackageJson(path.join(__dirname, '..'), excludeRe)
    // Remove the root package.json.
    .filter(p => p != path.join(__dirname, '../package.json'));
let gitShaCache;
function _getSnapshotHash(_pkg) {
    if (!gitShaCache) {
        gitShaCache = child_process_1.execSync('git log --format=%h -n1').toString().trim();
    }
    return gitShaCache;
}
// All the supported packages. Go through the packages directory and create a map of
// name => PackageInfo. This map is partial as it lacks some information that requires the
// map itself to finish building.
exports.packages = packageJsonPaths
    .map(pkgPath => ({ root: path.dirname(pkgPath) }))
    .reduce((packages, pkg) => {
    const pkgRoot = pkg.root;
    const packageJson = loadPackageJson(path.join(pkgRoot, 'package.json'));
    const name = packageJson['name'];
    if (!name) {
        // Only build the entry if there's a package name.
        return packages;
    }
    const bin = {};
    Object.keys(packageJson['bin'] || {}).forEach(binName => {
        let p = path.resolve(pkg.root, packageJson['bin'][binName]);
        if (!fs.existsSync(p)) {
            p = p.replace(/\.js$/, '.ts');
        }
        bin[binName] = p;
    });
    packages[name] = {
        build: path.join(distRoot, pkgRoot.substr(path.dirname(__dirname).length)),
        dist: path.join(distRoot, name),
        root: pkgRoot,
        relative: path.relative(path.dirname(__dirname), pkgRoot),
        main: path.resolve(pkgRoot, 'src/index.ts'),
        private: packageJson.private,
        tar: path.join(distRoot, name.replace('/', '_') + '.tgz'),
        bin,
        name,
        packageJson,
        snapshot: !!monorepoPackages[name].snapshotRepo,
        snapshotRepo: monorepoPackages[name].snapshotRepo,
        get snapshotHash() {
            return _getSnapshotHash(this);
        },
        dependencies: [],
        hash: '',
        dirty: false,
        version: monorepoPackages[name] && monorepoPackages[name].version || '0.0.0',
    };
    return packages;
}, {});
// Update with dependencies.
for (const pkgName of Object.keys(exports.packages)) {
    const pkg = exports.packages[pkgName];
    const pkgJson = require(path.join(pkg.root, 'package.json'));
    pkg.dependencies = Object.keys(exports.packages).filter(name => {
        return name in (pkgJson.dependencies || {})
            || name in (pkgJson.devDependencies || {});
    });
}
// Update the hash values of each.
for (const pkgName of Object.keys(exports.packages)) {
    exports.packages[pkgName].hash = _getHashOf(exports.packages[pkgName]);
    if (!monorepoPackages[pkgName] || exports.packages[pkgName].hash != monorepoPackages[pkgName].hash) {
        exports.packages[pkgName].dirty = true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFja2FnZXMuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2VybmllZGF2aXMvQ29kZS9hbmd1bGFyLWNsaS8iLCJzb3VyY2VzIjpbImxpYi9wYWNrYWdlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVNBLGlEQUF5QztBQUN6QyxpQ0FBaUM7QUFDakMseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3QixpQ0FBaUM7QUFFakMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzdCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ2pELE1BQU0sRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQTJCcEUsTUFBTSxTQUFTLEdBQW9DLEVBQUUsQ0FBQztBQUN0RCxvQkFBb0IsR0FBZ0I7SUFDbEMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxTQUFTLENBQUMsRUFBRTtRQUM1QixTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztRQUMzQixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNDLDRDQUE0QztRQUM1QyxNQUFNLEtBQUssR0FBYSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQzlFLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDdkIsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLFFBQVEsSUFBSSxDQUFDLENBQUM7WUFDbkMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENB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QyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsZ0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxnQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksSUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUU7UUFDMUYsZ0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0tBQ2hDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8taW1wbGljaXQtZGVwZW5kZW5jaWVzXG5pbXBvcnQgeyBKc29uT2JqZWN0IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgZXhlY1N5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5jb25zdCBnbG9iID0gcmVxdWlyZSgnZ2xvYicpO1xuY29uc3QgZGlzdFJvb3QgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vZGlzdCcpO1xuY29uc3QgeyBwYWNrYWdlczogbW9ub3JlcG9QYWNrYWdlcyB9ID0gcmVxdWlyZSgnLi4vLm1vbm9yZXBvLmpzb24nKTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIFBhY2thZ2VJbmZvIHtcbiAgbmFtZTogc3RyaW5nO1xuICByb290OiBzdHJpbmc7XG4gIGJpbjogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nfTtcbiAgcmVsYXRpdmU6IHN0cmluZztcbiAgbWFpbjogc3RyaW5nO1xuICBkaXN0OiBzdHJpbmc7XG4gIGJ1aWxkOiBzdHJpbmc7XG4gIHRhcjogc3RyaW5nO1xuICBwcml2YXRlOiBib29sZWFuO1xuICBwYWNrYWdlSnNvbjogSnNvbk9iamVjdDtcbiAgZGVwZW5kZW5jaWVzOiBzdHJpbmdbXTtcblxuICBzbmFwc2hvdDogYm9vbGVhbjtcbiAgc25hcHNob3RSZXBvOiBzdHJpbmc7XG4gIHNuYXBzaG90SGFzaDogc3RyaW5nO1xuXG4gIGRpcnR5OiBib29sZWFuO1xuICBoYXNoOiBzdHJpbmc7XG4gIHZlcnNpb246IHN0cmluZztcbn1cbmV4cG9ydCB0eXBlIFBhY2thZ2VNYXAgPSB7IFtuYW1lOiBzdHJpbmddOiBQYWNrYWdlSW5mbyB9O1xuXG5cbmNvbnN0IGhhc2hDYWNoZToge1tuYW1lOiBzdHJpbmddOiBzdHJpbmcgfCBudWxsfSA9IHt9O1xuZnVuY3Rpb24gX2dldEhhc2hPZihwa2c6IFBhY2thZ2VJbmZvKTogc3RyaW5nIHtcbiAgaWYgKCEocGtnLm5hbWUgaW4gaGFzaENhY2hlKSkge1xuICAgIGhhc2hDYWNoZVtwa2cubmFtZV0gPSBudWxsO1xuICAgIGNvbnN0IG1kNVN0cmVhbSA9IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgc3RyZWFtIHdpdGggYWxsIGZpbGVzIGNvbnRlbnQuXG4gICAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gZ2xvYi5zeW5jKHBhdGguam9pbihwa2cucm9vdCwgJyoqJyksIHsgbm9kaXI6IHRydWUgfSk7XG4gICAgZmlsZXMuZm9yRWFjaChmaWxlUGF0aCA9PiB7XG4gICAgICBtZDVTdHJlYW0ud3JpdGUoYFxcMCR7ZmlsZVBhdGh9XFwwYCk7XG4gICAgICBtZDVTdHJlYW0ud3JpdGUoZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoKSk7XG4gICAgfSk7XG4gICAgLy8gVXBkYXRlIHRoZSBzdHJlYW0gd2l0aCBhbGwgdmVyc2lvbnMgb2YgdXBzdHJlYW0gZGVwZW5kZW5jaWVzLlxuICAgIHBrZy5kZXBlbmRlbmNpZXMuZm9yRWFjaChkZXBOYW1lID0+IHtcbiAgICAgIG1kNVN0cmVhbS53cml0ZShgXFwwJHtkZXBOYW1lfVxcMCR7X2dldEhhc2hPZihwYWNrYWdlc1tkZXBOYW1lXSl9XFwwYCk7XG4gICAgfSk7XG5cbiAgICBtZDVTdHJlYW0uZW5kKCk7XG5cbiAgICBoYXNoQ2FjaGVbcGtnLm5hbWVdID0gKG1kNVN0cmVhbS5yZWFkKCkgYXMgQnVmZmVyKS50b1N0cmluZygnaGV4Jyk7XG4gIH1cblxuICBjb25zdCB2YWx1ZSA9IGhhc2hDYWNoZVtwa2cubmFtZV07XG4gIGlmICghdmFsdWUpIHtcbiAgICAvLyBQcm90ZWN0IGFnYWluc3QgY2lyY3VsYXIgZGVwZW5kZW5jeS5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NpcmN1bGFyIGRlcGVuZGVuY3kgZGV0ZWN0ZWQgYmV0d2VlbiB0aGUgZm9sbG93aW5nIHBhY2thZ2VzOiAnXG4gICAgICArIE9iamVjdC5rZXlzKGhhc2hDYWNoZSkuZmlsdGVyKGtleSA9PiBoYXNoQ2FjaGVba2V5XSA9PSBudWxsKS5qb2luKCcsICcpKTtcbiAgfVxuXG4gIHJldHVybiB2YWx1ZTtcbn1cblxuXG5mdW5jdGlvbiBsb2FkUGFja2FnZUpzb24ocDogc3RyaW5nKSB7XG4gIGNvbnN0IHJvb3QgPSByZXF1aXJlKCcuLi9wYWNrYWdlLmpzb24nKTtcbiAgY29uc3QgcGtnID0gcmVxdWlyZShwKTtcblxuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhyb290KSkge1xuICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICAvLyBLZWVwIHRoZSBmb2xsb3dpbmcga2V5cyBmcm9tIHRoZSBwYWNrYWdlLmpzb24gb2YgdGhlIHBhY2thZ2UgaXRzZWxmLlxuICAgICAgY2FzZSAnYmluJzpcbiAgICAgIGNhc2UgJ2Rlc2NyaXB0aW9uJzpcbiAgICAgIGNhc2UgJ2RlcGVuZGVuY2llcyc6XG4gICAgICBjYXNlICduYW1lJzpcbiAgICAgIGNhc2UgJ21haW4nOlxuICAgICAgY2FzZSAncGVlckRlcGVuZGVuY2llcyc6XG4gICAgICBjYXNlICdvcHRpb25hbERlcGVuZGVuY2llcyc6XG4gICAgICBjYXNlICd0eXBpbmdzJzpcbiAgICAgIGNhc2UgJ3ZlcnNpb24nOlxuICAgICAgICBjb250aW51ZTtcblxuICAgICAgLy8gUmVtb3ZlIHRoZSBmb2xsb3dpbmcga2V5cyBmcm9tIHRoZSBwYWNrYWdlLmpzb24uXG4gICAgICBjYXNlICdkZXZEZXBlbmRlbmNpZXMnOlxuICAgICAgY2FzZSAnc2NyaXB0cyc6XG4gICAgICAgIGRlbGV0ZSBwa2dba2V5XTtcbiAgICAgICAgY29udGludWU7XG5cbiAgICAgIC8vIE1lcmdlIHRoZSBmb2xsb3dpbmcga2V5cyB3aXRoIHRoZSByb290IHBhY2thZ2UuanNvbi5cbiAgICAgIGNhc2UgJ2tleXdvcmRzJzpcbiAgICAgICAgY29uc3QgYSA9IHBrZ1trZXldIHx8IFtdO1xuICAgICAgICBjb25zdCBiID0gT2JqZWN0LmtleXMoXG4gICAgICAgICAgcm9vdFtrZXldLmNvbmNhdChhKS5yZWR1Y2UoKGFjYzoge1trOiBzdHJpbmddOiBib29sZWFufSwgY3Vycjogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBhY2NbY3Vycl0gPSB0cnVlO1xuXG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgIH0sIHt9KSk7XG4gICAgICAgIHBrZ1trZXldID0gYjtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIC8vIE92ZXJ3cml0ZSB0aGUgcGFja2FnZSdzIGtleSB3aXRoIHRvIHJvb3Qgb25lLlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcGtnW2tleV0gPSByb290W2tleV07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBrZztcbn1cblxuXG5mdW5jdGlvbiBfZmluZEFsbFBhY2thZ2VKc29uKGRpcjogc3RyaW5nLCBleGNsdWRlOiBSZWdFeHApOiBzdHJpbmdbXSB7XG4gIGNvbnN0IHJlc3VsdDogc3RyaW5nW10gPSBbXTtcbiAgZnMucmVhZGRpclN5bmMoZGlyKVxuICAgIC5mb3JFYWNoKGZpbGVOYW1lID0+IHtcbiAgICAgIGNvbnN0IHAgPSBwYXRoLmpvaW4oZGlyLCBmaWxlTmFtZSk7XG5cbiAgICAgIGlmIChleGNsdWRlLnRlc3QocCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIGlmIChmaWxlTmFtZSA9PSAncGFja2FnZS5qc29uJykge1xuICAgICAgICByZXN1bHQucHVzaChwKTtcbiAgICAgIH0gZWxzZSBpZiAoZnMuc3RhdFN5bmMocCkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICByZXN1bHQucHVzaCguLi5fZmluZEFsbFBhY2thZ2VKc29uKHAsIGV4Y2x1ZGUpKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbmNvbnN0IHRzQ29uZmlnUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi90c2NvbmZpZy5qc29uJyk7XG5jb25zdCB0c0NvbmZpZyA9IHRzLnJlYWRDb25maWdGaWxlKHRzQ29uZmlnUGF0aCwgdHMuc3lzLnJlYWRGaWxlKTtcbmNvbnN0IHBhdHRlcm4gPSAnXignXG4gICsgKHRzQ29uZmlnLmNvbmZpZy5leGNsdWRlIGFzIHN0cmluZ1tdKVxuICAgIC5tYXAoZXggPT4gcGF0aC5qb2luKHBhdGguZGlybmFtZSh0c0NvbmZpZ1BhdGgpLCBleCkpXG4gICAgLm1hcChleCA9PiAnKCdcbiAgICAgICsgZXhcbiAgICAgICAgLnJlcGxhY2UoL1tcXC1cXFtcXF17fSgpKz8uL1xcXFxeJHxdL2csICdcXFxcJCYnKVxuICAgICAgICAucmVwbGFjZSgvKFxcXFxcXFxcfFxcXFxcXC8pXFwqXFwqL2csICcoKFxcL3xcXFxcXFxcXCkuKz8pPycpXG4gICAgICAgIC5yZXBsYWNlKC9cXCovZywgJ1teL1xcXFxcXFxcXSonKVxuICAgICAgKyAnKScpXG4gICAgLmpvaW4oJ3wnKVxuICArICcpKCR8L3xcXFxcXFxcXCknO1xuY29uc3QgZXhjbHVkZVJlID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcblxuLy8gRmluZCBhbGwgdGhlIHBhY2thZ2UuanNvbiB0aGF0IGFyZW4ndCBleGNsdWRlZCBmcm9tIHRzY29uZmlnLlxuY29uc3QgcGFja2FnZUpzb25QYXRocyA9IF9maW5kQWxsUGFja2FnZUpzb24ocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJyksIGV4Y2x1ZGVSZSlcbiAgLy8gUmVtb3ZlIHRoZSByb290IHBhY2thZ2UuanNvbi5cbiAgLmZpbHRlcihwID0+IHAgIT0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3BhY2thZ2UuanNvbicpKTtcblxuXG5sZXQgZ2l0U2hhQ2FjaGU6IHN0cmluZztcbmZ1bmN0aW9uIF9nZXRTbmFwc2hvdEhhc2goX3BrZzogUGFja2FnZUluZm8pOiBzdHJpbmcge1xuICBpZiAoIWdpdFNoYUNhY2hlKSB7XG4gICAgZ2l0U2hhQ2FjaGUgPSBleGVjU3luYygnZ2l0IGxvZyAtLWZvcm1hdD0laCAtbjEnKS50b1N0cmluZygpLnRyaW0oKTtcbiAgfVxuXG4gIHJldHVybiBnaXRTaGFDYWNoZTtcbn1cblxuXG4vLyBBbGwgdGhlIHN1cHBvcnRlZCBwYWNrYWdlcy4gR28gdGhyb3VnaCB0aGUgcGFja2FnZXMgZGlyZWN0b3J5IGFuZCBjcmVhdGUgYSBtYXAgb2Zcbi8vIG5hbWUgPT4gUGFja2FnZUluZm8uIFRoaXMgbWFwIGlzIHBhcnRpYWwgYXMgaXQgbGFja3Mgc29tZSBpbmZvcm1hdGlvbiB0aGF0IHJlcXVpcmVzIHRoZVxuLy8gbWFwIGl0c2VsZiB0byBmaW5pc2ggYnVpbGRpbmcuXG5leHBvcnQgY29uc3QgcGFja2FnZXM6IFBhY2thZ2VNYXAgPVxuICBwYWNrYWdlSnNvblBhdGhzXG4gICAgLm1hcChwa2dQYXRoID0+ICh7IHJvb3Q6IHBhdGguZGlybmFtZShwa2dQYXRoKSB9KSlcbiAgICAucmVkdWNlKChwYWNrYWdlczogUGFja2FnZU1hcCwgcGtnKSA9PiB7XG4gICAgICBjb25zdCBwa2dSb290ID0gcGtnLnJvb3Q7XG4gICAgICBjb25zdCBwYWNrYWdlSnNvbiA9IGxvYWRQYWNrYWdlSnNvbihwYXRoLmpvaW4ocGtnUm9vdCwgJ3BhY2thZ2UuanNvbicpKTtcbiAgICAgIGNvbnN0IG5hbWUgPSBwYWNrYWdlSnNvblsnbmFtZSddO1xuICAgICAgaWYgKCFuYW1lKSB7XG4gICAgICAgIC8vIE9ubHkgYnVpbGQgdGhlIGVudHJ5IGlmIHRoZXJlJ3MgYSBwYWNrYWdlIG5hbWUuXG4gICAgICAgIHJldHVybiBwYWNrYWdlcztcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJpbjoge1tuYW1lOiBzdHJpbmddOiBzdHJpbmd9ID0ge307XG4gICAgICBPYmplY3Qua2V5cyhwYWNrYWdlSnNvblsnYmluJ10gfHwge30pLmZvckVhY2goYmluTmFtZSA9PiB7XG4gICAgICAgIGxldCBwID0gcGF0aC5yZXNvbHZlKHBrZy5yb290LCBwYWNrYWdlSnNvblsnYmluJ11bYmluTmFtZV0pO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMocCkpIHtcbiAgICAgICAgICBwID0gcC5yZXBsYWNlKC9cXC5qcyQvLCAnLnRzJyk7XG4gICAgICAgIH1cbiAgICAgICAgYmluW2Jpbk5hbWVdID0gcDtcbiAgICAgIH0pO1xuXG4gICAgICBwYWNrYWdlc1tuYW1lXSA9IHtcbiAgICAgICAgYnVpbGQ6IHBhdGguam9pbihkaXN0Um9vdCwgcGtnUm9vdC5zdWJzdHIocGF0aC5kaXJuYW1lKF9fZGlybmFtZSkubGVuZ3RoKSksXG4gICAgICAgIGRpc3Q6IHBhdGguam9pbihkaXN0Um9vdCwgbmFtZSksXG4gICAgICAgIHJvb3Q6IHBrZ1Jvb3QsXG4gICAgICAgIHJlbGF0aXZlOiBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShfX2Rpcm5hbWUpLCBwa2dSb290KSxcbiAgICAgICAgbWFpbjogcGF0aC5yZXNvbHZlKHBrZ1Jvb3QsICdzcmMvaW5kZXgudHMnKSxcbiAgICAgICAgcHJpdmF0ZTogcGFja2FnZUpzb24ucHJpdmF0ZSxcbiAgICAgICAgdGFyOiBwYXRoLmpvaW4oZGlzdFJvb3QsIG5hbWUucmVwbGFjZSgnLycsICdfJykgKyAnLnRneicpLFxuICAgICAgICBiaW4sXG4gICAgICAgIG5hbWUsXG4gICAgICAgIHBhY2thZ2VKc29uLFxuXG4gICAgICAgIHNuYXBzaG90OiAhIW1vbm9yZXBvUGFja2FnZXNbbmFtZV0uc25hcHNob3RSZXBvLFxuICAgICAgICBzbmFwc2hvdFJlcG86IG1vbm9yZXBvUGFja2FnZXNbbmFtZV0uc25hcHNob3RSZXBvLFxuICAgICAgICBnZXQgc25hcHNob3RIYXNoKCkge1xuICAgICAgICAgIHJldHVybiBfZ2V0U25hcHNob3RIYXNoKHRoaXMpO1xuICAgICAgICB9LFxuXG4gICAgICAgIGRlcGVuZGVuY2llczogW10sXG4gICAgICAgIGhhc2g6ICcnLFxuICAgICAgICBkaXJ0eTogZmFsc2UsXG4gICAgICAgIHZlcnNpb246IG1vbm9yZXBvUGFja2FnZXNbbmFtZV0gJiYgbW9ub3JlcG9QYWNrYWdlc1tuYW1lXS52ZXJzaW9uIHx8ICcwLjAuMCcsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gcGFja2FnZXM7XG4gICAgfSwge30pO1xuXG5cbi8vIFVwZGF0ZSB3aXRoIGRlcGVuZGVuY2llcy5cbmZvciAoY29uc3QgcGtnTmFtZSBvZiBPYmplY3Qua2V5cyhwYWNrYWdlcykpIHtcbiAgY29uc3QgcGtnID0gcGFja2FnZXNbcGtnTmFtZV07XG4gIGNvbnN0IHBrZ0pzb24gPSByZXF1aXJlKHBhdGguam9pbihwa2cucm9vdCwgJ3BhY2thZ2UuanNvbicpKTtcbiAgcGtnLmRlcGVuZGVuY2llcyA9IE9iamVjdC5rZXlzKHBhY2thZ2VzKS5maWx0ZXIobmFtZSA9PiB7XG4gICAgcmV0dXJuIG5hbWUgaW4gKHBrZ0pzb24uZGVwZW5kZW5jaWVzIHx8IHt9KVxuICAgICAgICB8fCBuYW1lIGluIChwa2dKc29uLmRldkRlcGVuZGVuY2llcyB8fCB7fSk7XG4gIH0pO1xufVxuXG5cbi8vIFVwZGF0ZSB0aGUgaGFzaCB2YWx1ZXMgb2YgZWFjaC5cbmZvciAoY29uc3QgcGtnTmFtZSBvZiBPYmplY3Qua2V5cyhwYWNrYWdlcykpIHtcbiAgcGFja2FnZXNbcGtnTmFtZV0uaGFzaCA9IF9nZXRIYXNoT2YocGFja2FnZXNbcGtnTmFtZV0pO1xuICBpZiAoIW1vbm9yZXBvUGFja2FnZXNbcGtnTmFtZV0gfHwgcGFja2FnZXNbcGtnTmFtZV0uaGFzaCAhPSBtb25vcmVwb1BhY2thZ2VzW3BrZ05hbWVdLmhhc2gpIHtcbiAgICBwYWNrYWdlc1twa2dOYW1lXS5kaXJ0eSA9IHRydWU7XG4gIH1cbn1cbiJdfQ==