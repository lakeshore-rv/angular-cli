"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// tslint:disable:no-any non-null-operator no-big-function
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const registry_1 = require("./registry");
describe('CoreSchemaRegistry', () => {
    it('works asynchronously', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = {}; // tslint:disable-line:no-any
        registry
            .compile({
            properties: {
                bool: { type: 'boolean' },
                str: { type: 'string', default: 'someString' },
                obj: {
                    properties: {
                        num: { type: 'number' },
                        other: { type: 'number', default: 0 },
                    },
                },
                tslint: {
                    $ref: 'http://json.schemastore.org/tslint#',
                },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
            expect(data.obj.num).toBeUndefined();
            expect(data.tslint).not.toBeUndefined();
        }))
            .toPromise().then(done, done.fail);
    });
    it('supports pre transforms', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = {}; // tslint:disable-line:no-any
        registry.addPreTransform((data, ptr) => {
            if (ptr == '/') {
                return { str: 'string' };
            }
            return data;
        });
        registry
            .compile({
            properties: {
                bool: { type: 'boolean' },
                str: { type: 'string', default: 'someString' },
                obj: {
                    properties: {
                        num: { type: 'number' },
                        other: { type: 'number', default: 0 },
                    },
                },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            const data = result.data;
            expect(result.success).toBe(true);
            expect(data.str).toBe('string');
            expect(data.obj.num).toBeUndefined();
        }))
            .toPromise().then(done, done.fail);
    });
    it('supports local references', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { numbers: { one: 1 } };
        registry
            .compile({
            properties: {
                numbers: {
                    type: 'object',
                    additionalProperties: { '$ref': '#/definitions/myRef' },
                },
            },
            definitions: {
                myRef: { type: 'integer' },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
            expect(data.numbers.one).not.toBeUndefined();
        }))
            .toPromise().then(done, done.fail);
    });
    it('fails on invalid additionalProperties', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { notNum: 'foo' };
        registry
            .compile({
            properties: {
                num: { type: 'number' },
            },
            additionalProperties: false,
        }).pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(false);
            expect(result.errors && result.errors[0].message).toContain('should NOT have additional properties');
        }))
            .toPromise().then(done, done.fail);
    });
    it('fails on invalid additionalProperties async', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { notNum: 'foo' };
        registry
            .compile({
            $async: true,
            properties: {
                num: { type: 'number' },
            },
            additionalProperties: false,
        }).pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(false);
            expect(result.errors && result.errors[0].message).toContain('should NOT have additional properties');
            expect(result.errors && result.errors[0].keyword).toBe('additionalProperties');
        }))
            .toPromise().then(done, done.fail);
    });
    // Synchronous failure is only used internally.
    // If it's meant to be used externally then this test should change to truly be synchronous
    // (i.e. not relyign on the observable).
    it('works synchronously', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = {}; // tslint:disable-line:no-any
        let isDone = false;
        registry
            .compile({
            properties: {
                bool: { type: 'boolean' },
                str: { type: 'string', default: 'someString' },
                obj: {
                    properties: {
                        num: { type: 'number' },
                        other: { type: 'number', default: 0 },
                    },
                },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
            expect(data.obj.num).toBeUndefined();
        }))
            .subscribe(() => {
            isDone = true;
        }, done.fail);
        expect(isDone).toBe(true);
        done();
    });
    it('supports sync format', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { str: 'hotdog' };
        const format = {
            name: 'is-hotdog',
            formatter: {
                async: false,
                validate: (str) => str === 'hotdog',
            },
        };
        registry.addFormat(format);
        registry
            .compile({
            properties: {
                str: { type: 'string', format: 'is-hotdog' },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
        }))
            .toPromise().then(done, done.fail);
    });
    it('supports async format', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { str: 'hotdog' };
        const format = {
            name: 'is-hotdog',
            formatter: {
                async: true,
                validate: (str) => rxjs_1.of(str === 'hotdog'),
            },
        };
        registry.addFormat(format);
        registry
            .compile({
            $async: true,
            properties: {
                str: { type: 'string', format: 'is-hotdog' },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
        }))
            .toPromise().then(done, done.fail);
    });
    it('shows dataPath and message on error', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = { hotdot: 'hotdog', banana: 'banana' };
        const format = {
            name: 'is-hotdog',
            formatter: {
                async: false,
                validate: (str) => str === 'hotdog',
            },
        };
        registry.addFormat(format);
        registry
            .compile({
            properties: {
                hotdot: { type: 'string', format: 'is-hotdog' },
                banana: { type: 'string', format: 'is-hotdog' },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(false);
            expect(result.errors && result.errors[0]).toBeTruthy();
            expect(result.errors && result.errors[0].keyword).toBe('format');
            expect(result.errors && result.errors[0].dataPath).toBe('.banana');
            expect(result.errors && result.errors[0].params.format).toBe('is-hotdog');
        }))
            .toPromise().then(done, done.fail);
    });
    it('supports smart defaults', done => {
        const registry = new registry_1.CoreSchemaRegistry();
        const data = {
            arr: [{}],
        };
        registry.addSmartDefaultProvider('test', (schema) => {
            expect(schema).toEqual({
                $source: 'test',
            });
            return true;
        });
        registry.addSmartDefaultProvider('test2', (schema) => {
            expect(schema).toEqual({
                $source: 'test2',
                blue: 'yep',
            });
            return schema['blue'];
        });
        registry.addSmartDefaultProvider('test3', (schema) => {
            return [1, 2, 3];
        });
        registry
            .compile({
            properties: {
                bool: {
                    $ref: '#/definitions/example',
                },
                arr: {
                    items: {
                        properties: {
                            'test': {
                                $ref: '#/definitions/other',
                            },
                        },
                    },
                },
                arr2: {
                    $ref: '#/definitions/test3',
                },
                obj: {
                    properties: {
                        deep: {
                            properties: {
                                arr: {
                                    $ref: '#/definitions/test3',
                                },
                            },
                        },
                    },
                },
            },
            definitions: {
                example: {
                    type: 'boolean',
                    $default: {
                        $source: 'test',
                    },
                },
                other: {
                    type: 'string',
                    $default: {
                        $source: 'test2',
                        blue: 'yep',
                    },
                },
                test3: {
                    type: 'array',
                    $default: {
                        $source: 'test3',
                    },
                },
            },
        })
            .pipe(operators_1.mergeMap(validator => validator(data)), operators_1.map(result => {
            expect(result.success).toBe(true);
            expect(data.bool).toBe(true);
            expect(data.arr[0].test).toBe('yep');
            expect(data.arr2).toEqual([1, 2, 3]);
            expect(data.obj.deep.arr).toEqual([1, 2, 3]);
        }))
            .toPromise().then(done, done.fail);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0cnlfc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvZXJuaWVkYXZpcy9Db2RlL2FuZ3VsYXItY2xpLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvY29yZS9zcmMvanNvbi9zY2hlbWEvcmVnaXN0cnlfc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7R0FNRztBQUNILDBEQUEwRDtBQUMxRCwrQkFBMEM7QUFDMUMsOENBQStDO0FBQy9DLHlDQUFnRDtBQUdoRCxRQUFRLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFO0lBQ2xDLEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsRUFBRTtRQUNoQyxNQUFNLFFBQVEsR0FBRyxJQUFJLDZCQUFrQixFQUFFLENBQUM7UUFDMUMsTUFBTSxJQUFJLEdBQVEsRUFBRSxDQUFDLENBQUUsNkJBQTZCO1FBRXBELFFBQVE7YUFDTCxPQUFPLENBQUM7WUFDUCxVQUFVLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRTtnQkFDekIsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFO2dCQUM5QyxHQUFHLEVBQUU7b0JBQ0gsVUFBVSxFQUFFO3dCQUNWLEdBQUcsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUU7d0JBQ3ZCLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRTtxQkFDdEM7aUJBQ0Y7Z0JBQ0QsTUFBTSxFQUFFO29CQUNOLElBQUksRUFBRSxxQ0FBcUM7aUJBQzVDO2FBQ0Y7U0FDRixDQUFDO2FBQ0QsSUFBSSxDQUNILG9CQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDdEMsZUFBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ1gsTUFBTSxDQUFDLE1BQU0s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RUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUNIO2FBQ0EsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbi8vIHRzbGludDpkaXNhYmxlOm5vLWFueSBub24tbnVsbC1vcGVyYXRvciBuby1iaWctZnVuY3Rpb25cbmltcG9ydCB7IG9mIGFzIG9ic2VydmFibGVPZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBtZXJnZU1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvcmVTY2hlbWFSZWdpc3RyeSB9IGZyb20gJy4vcmVnaXN0cnknO1xuXG5cbmRlc2NyaWJlKCdDb3JlU2NoZW1hUmVnaXN0cnknLCAoKSA9PiB7XG4gIGl0KCd3b3JrcyBhc3luY2hyb25vdXNseScsIGRvbmUgPT4ge1xuICAgIGNvbnN0IHJlZ2lzdHJ5ID0gbmV3IENvcmVTY2hlbWFSZWdpc3RyeSgpO1xuICAgIGNvbnN0IGRhdGE6IGFueSA9IHt9OyAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcblxuICAgIHJlZ2lzdHJ5XG4gICAgICAuY29tcGlsZSh7XG4gICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICBib29sOiB7IHR5cGU6ICdib29sZWFuJyB9LFxuICAgICAgICAgIHN0cjogeyB0eXBlOiAnc3RyaW5nJywgZGVmYXVsdDogJ3NvbWVTdHJpbmcnIH0sXG4gICAgICAgICAgb2JqOiB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAgIG51bTogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgICAgICAgICAgICBvdGhlcjogeyB0eXBlOiAnbnVtYmVyJywgZGVmYXVsdDogMCB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHRzbGludDoge1xuICAgICAgICAgICAgJHJlZjogJ2h0dHA6Ly9qc29uLnNjaGVtYXN0b3JlLm9yZy90c2xpbnQjJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgICAgIGV4cGVjdChkYXRhLm9iai5udW0pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgICBleHBlY3QoZGF0YS50c2xpbnQpLm5vdC50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4oZG9uZSwgZG9uZS5mYWlsKTtcbiAgfSk7XG5cbiAgaXQoJ3N1cHBvcnRzIHByZSB0cmFuc2Zvcm1zJywgZG9uZSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZGF0YTogYW55ID0ge307ICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuXG4gICAgcmVnaXN0cnkuYWRkUHJlVHJhbnNmb3JtKChkYXRhLCBwdHIpID0+IHtcbiAgICAgIGlmIChwdHIgPT0gJy8nKSB7XG4gICAgICAgIHJldHVybiB7IHN0cjogJ3N0cmluZycgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSk7XG5cbiAgICByZWdpc3RyeVxuICAgICAgLmNvbXBpbGUoe1xuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgYm9vbDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgICAgICAgICBzdHI6IHsgdHlwZTogJ3N0cmluZycsIGRlZmF1bHQ6ICdzb21lU3RyaW5nJyB9LFxuICAgICAgICAgIG9iajoge1xuICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICBudW06IHsgdHlwZTogJ251bWJlcicgfSxcbiAgICAgICAgICAgICAgb3RoZXI6IHsgdHlwZTogJ251bWJlcicsIGRlZmF1bHQ6IDAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgICAucGlwZShcbiAgICAgICAgbWVyZ2VNYXAodmFsaWRhdG9yID0+IHZhbGlkYXRvcihkYXRhKSksXG4gICAgICAgIG1hcChyZXN1bHQgPT4ge1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXN1bHQuZGF0YSBhcyBhbnk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgICAgIGV4cGVjdChkYXRhLnN0cikudG9CZSgnc3RyaW5nJyk7XG4gICAgICAgICAgZXhwZWN0KGRhdGEub2JqLm51bSkudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC50b1Byb21pc2UoKS50aGVuKGRvbmUsIGRvbmUuZmFpbCk7XG4gIH0pO1xuXG4gIGl0KCdzdXBwb3J0cyBsb2NhbCByZWZlcmVuY2VzJywgZG9uZSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZGF0YSA9IHsgbnVtYmVyczogeyBvbmU6IDEgfSB9O1xuXG4gICAgcmVnaXN0cnlcbiAgICAgIC5jb21waWxlKHtcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIG51bWJlcnM6IHtcbiAgICAgICAgICAgIHR5cGU6ICdvYmplY3QnLFxuICAgICAgICAgICAgYWRkaXRpb25hbFByb3BlcnRpZXM6IHsgJyRyZWYnOiAnIy9kZWZpbml0aW9ucy9teVJlZicgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBkZWZpbml0aW9uczoge1xuICAgICAgICAgIG15UmVmOiB7IHR5cGU6ICdpbnRlZ2VyJyB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgICAgIGV4cGVjdChkYXRhLm51bWJlcnMub25lKS5ub3QudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICB9KSxcbiAgICApXG4gICAgICAudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnZmFpbHMgb24gaW52YWxpZCBhZGRpdGlvbmFsUHJvcGVydGllcycsIGRvbmUgPT4ge1xuICAgIGNvbnN0IHJlZ2lzdHJ5ID0gbmV3IENvcmVTY2hlbWFSZWdpc3RyeSgpO1xuICAgIGNvbnN0IGRhdGEgPSB7IG5vdE51bTogJ2ZvbycgfTtcblxuICAgIHJlZ2lzdHJ5XG4gICAgICAuY29tcGlsZSh7XG4gICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICBudW06IHsgdHlwZTogJ251bWJlcicgfSxcbiAgICAgICAgfSxcbiAgICAgICAgYWRkaXRpb25hbFByb3BlcnRpZXM6IGZhbHNlLFxuICAgICAgfSkucGlwZShcbiAgICAgICAgbWVyZ2VNYXAodmFsaWRhdG9yID0+IHZhbGlkYXRvcihkYXRhKSksXG4gICAgICAgIG1hcChyZXN1bHQgPT4ge1xuICAgICAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcnMgJiYgcmVzdWx0LmVycm9yc1swXS5tZXNzYWdlKS50b0NvbnRhaW4oXG4gICAgICAgICAgICAnc2hvdWxkIE5PVCBoYXZlIGFkZGl0aW9uYWwgcHJvcGVydGllcycpO1xuICAgICAgICB9KSxcbiAgICApXG4gICAgICAudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnZmFpbHMgb24gaW52YWxpZCBhZGRpdGlvbmFsUHJvcGVydGllcyBhc3luYycsIGRvbmUgPT4ge1xuICAgIGNvbnN0IHJlZ2lzdHJ5ID0gbmV3IENvcmVTY2hlbWFSZWdpc3RyeSgpO1xuICAgIGNvbnN0IGRhdGEgPSB7IG5vdE51bTogJ2ZvbycgfTtcblxuICAgIHJlZ2lzdHJ5XG4gICAgICAuY29tcGlsZSh7XG4gICAgICAgICRhc3luYzogdHJ1ZSxcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIG51bTogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgICAgICB9LFxuICAgICAgICBhZGRpdGlvbmFsUHJvcGVydGllczogZmFsc2UsXG4gICAgICB9KS5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKTtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LmVycm9ycyAmJiByZXN1bHQuZXJyb3JzWzBdLm1lc3NhZ2UpLnRvQ29udGFpbihcbiAgICAgICAgICAgICdzaG91bGQgTk9UIGhhdmUgYWRkaXRpb25hbCBwcm9wZXJ0aWVzJyk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcnMgJiYgcmVzdWx0LmVycm9yc1swXS5rZXl3b3JkKS50b0JlKCdhZGRpdGlvbmFsUHJvcGVydGllcycpO1xuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC50b1Byb21pc2UoKS50aGVuKGRvbmUsIGRvbmUuZmFpbCk7XG4gIH0pO1xuXG5cbiAgLy8gU3luY2hyb25vdXMgZmFpbHVyZSBpcyBvbmx5IHVzZWQgaW50ZXJuYWxseS5cbiAgLy8gSWYgaXQncyBtZWFudCB0byBiZSB1c2VkIGV4dGVybmFsbHkgdGhlbiB0aGlzIHRlc3Qgc2hvdWxkIGNoYW5nZSB0byB0cnVseSBiZSBzeW5jaHJvbm91c1xuICAvLyAoaS5lLiBub3QgcmVseWlnbiBvbiB0aGUgb2JzZXJ2YWJsZSkuXG4gIGl0KCd3b3JrcyBzeW5jaHJvbm91c2x5JywgZG9uZSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZGF0YTogYW55ID0ge307ICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLWFueVxuICAgIGxldCBpc0RvbmUgPSBmYWxzZTtcblxuICAgIHJlZ2lzdHJ5XG4gICAgICAuY29tcGlsZSh7XG4gICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICBib29sOiB7IHR5cGU6ICdib29sZWFuJyB9LFxuICAgICAgICAgIHN0cjogeyB0eXBlOiAnc3RyaW5nJywgZGVmYXVsdDogJ3NvbWVTdHJpbmcnIH0sXG4gICAgICAgICAgb2JqOiB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAgIG51bTogeyB0eXBlOiAnbnVtYmVyJyB9LFxuICAgICAgICAgICAgICBvdGhlcjogeyB0eXBlOiAnbnVtYmVyJywgZGVmYXVsdDogMCB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgICAgIGV4cGVjdChkYXRhLm9iai5udW0pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgaXNEb25lID0gdHJ1ZTtcbiAgICAgIH0sIGRvbmUuZmFpbCk7XG5cbiAgICBleHBlY3QoaXNEb25lKS50b0JlKHRydWUpO1xuICAgIGRvbmUoKTtcbiAgfSk7XG5cbiAgaXQoJ3N1cHBvcnRzIHN5bmMgZm9ybWF0JywgZG9uZSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZGF0YSA9IHsgc3RyOiAnaG90ZG9nJyB9O1xuICAgIGNvbnN0IGZvcm1hdCA9IHtcbiAgICAgIG5hbWU6ICdpcy1ob3Rkb2cnLFxuICAgICAgZm9ybWF0dGVyOiB7XG4gICAgICAgIGFzeW5jOiBmYWxzZSxcbiAgICAgICAgdmFsaWRhdGU6IChzdHI6IHN0cmluZykgPT4gc3RyID09PSAnaG90ZG9nJyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHJlZ2lzdHJ5LmFkZEZvcm1hdChmb3JtYXQpO1xuXG4gICAgcmVnaXN0cnlcbiAgICAgIC5jb21waWxlKHtcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIHN0cjogeyB0eXBlOiAnc3RyaW5nJywgZm9ybWF0OiAnaXMtaG90ZG9nJyB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC50b1Byb21pc2UoKS50aGVuKGRvbmUsIGRvbmUuZmFpbCk7XG4gIH0pO1xuXG4gIGl0KCdzdXBwb3J0cyBhc3luYyBmb3JtYXQnLCBkb25lID0+IHtcbiAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBDb3JlU2NoZW1hUmVnaXN0cnkoKTtcbiAgICBjb25zdCBkYXRhID0geyBzdHI6ICdob3Rkb2cnIH07XG4gICAgY29uc3QgZm9ybWF0ID0ge1xuICAgICAgbmFtZTogJ2lzLWhvdGRvZycsXG4gICAgICBmb3JtYXR0ZXI6IHtcbiAgICAgICAgYXN5bmM6IHRydWUsXG4gICAgICAgIHZhbGlkYXRlOiAoc3RyOiBzdHJpbmcpID0+IG9ic2VydmFibGVPZihzdHIgPT09ICdob3Rkb2cnKSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHJlZ2lzdHJ5LmFkZEZvcm1hdChmb3JtYXQpO1xuXG4gICAgcmVnaXN0cnlcbiAgICAgIC5jb21waWxlKHtcbiAgICAgICAgJGFzeW5jOiB0cnVlLFxuICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgc3RyOiB7IHR5cGU6ICdzdHJpbmcnLCBmb3JtYXQ6ICdpcy1ob3Rkb2cnIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKHZhbGlkYXRvciA9PiB2YWxpZGF0b3IoZGF0YSkpLFxuICAgICAgICBtYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICAgIH0pLFxuICAgICAgKVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4oZG9uZSwgZG9uZS5mYWlsKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIGRhdGFQYXRoIGFuZCBtZXNzYWdlIG9uIGVycm9yJywgZG9uZSA9PiB7XG4gICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgQ29yZVNjaGVtYVJlZ2lzdHJ5KCk7XG4gICAgY29uc3QgZGF0YSA9IHsgaG90ZG90OiAnaG90ZG9nJywgYmFuYW5hOiAnYmFuYW5hJyB9O1xuICAgIGNvbnN0IGZvcm1hdCA9IHtcbiAgICAgIG5hbWU6ICdpcy1ob3Rkb2cnLFxuICAgICAgZm9ybWF0dGVyOiB7XG4gICAgICAgIGFzeW5jOiBmYWxzZSxcbiAgICAgICAgdmFsaWRhdGU6IChzdHI6IHN0cmluZykgPT4gc3RyID09PSAnaG90ZG9nJyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHJlZ2lzdHJ5LmFkZEZvcm1hdChmb3JtYXQpO1xuXG4gICAgcmVnaXN0cnlcbiAgICAgIC5jb21waWxlKHtcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIGhvdGRvdDogeyB0eXBlOiAnc3RyaW5nJywgZm9ybWF0OiAnaXMtaG90ZG9nJyB9LFxuICAgICAgICAgIGJhbmFuYTogeyB0eXBlOiAnc3RyaW5nJywgZm9ybWF0OiAnaXMtaG90ZG9nJyB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtZXJnZU1hcCh2YWxpZGF0b3IgPT4gdmFsaWRhdG9yKGRhdGEpKSxcbiAgICAgICAgbWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKGZhbHNlKTtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LmVycm9ycyAmJiByZXN1bHQuZXJyb3JzWzBdKS50b0JlVHJ1dGh5KCk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcnMgJiYgcmVzdWx0LmVycm9yc1swXS5rZXl3b3JkKS50b0JlKCdmb3JtYXQnKTtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LmVycm9ycyAmJiByZXN1bHQuZXJyb3JzWzBdLmRhdGFQYXRoKS50b0JlKCcuYmFuYW5hJyk7XG4gICAgICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcnMgJiYgKHJlc3VsdC5lcnJvcnNbMF0ucGFyYW1zIGFzIGFueSkuZm9ybWF0KS50b0JlKCdpcy1ob3Rkb2cnKTtcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICAudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnc3VwcG9ydHMgc21hcnQgZGVmYXVsdHMnLCBkb25lID0+IHtcbiAgICBjb25zdCByZWdpc3RyeSA9IG5ldyBDb3JlU2NoZW1hUmVnaXN0cnkoKTtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSB7XG4gICAgICBhcnI6IFt7fV0sXG4gICAgfTtcblxuICAgIHJlZ2lzdHJ5LmFkZFNtYXJ0RGVmYXVsdFByb3ZpZGVyKCd0ZXN0JywgKHNjaGVtYSkgPT4ge1xuICAgICAgZXhwZWN0KHNjaGVtYSkudG9FcXVhbCh7XG4gICAgICAgICRzb3VyY2U6ICd0ZXN0JyxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcbiAgICByZWdpc3RyeS5hZGRTbWFydERlZmF1bHRQcm92aWRlcigndGVzdDInLCAoc2NoZW1hKSA9PiB7XG4gICAgICBleHBlY3Qoc2NoZW1hKS50b0VxdWFsKHtcbiAgICAgICAgJHNvdXJjZTogJ3Rlc3QyJyxcbiAgICAgICAgYmx1ZTogJ3llcCcsXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHNjaGVtYVsnYmx1ZSddO1xuICAgIH0pO1xuICAgIHJlZ2lzdHJ5LmFkZFNtYXJ0RGVmYXVsdFByb3ZpZGVyKCd0ZXN0MycsIChzY2hlbWEpID0+IHtcbiAgICAgIHJldHVybiBbIDEsIDIsIDMgXTtcbiAgICB9KTtcblxuICAgIHJlZ2lzdHJ5XG4gICAgICAuY29tcGlsZSh7XG4gICAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgICBib29sOiB7XG4gICAgICAgICAgICAkcmVmOiAnIy9kZWZpbml0aW9ucy9leGFtcGxlJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGFycjoge1xuICAgICAgICAgICAgaXRlbXM6IHtcbiAgICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgICd0ZXN0Jzoge1xuICAgICAgICAgICAgICAgICAgJHJlZjogJyMvZGVmaW5pdGlvbnMvb3RoZXInLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgYXJyMjoge1xuICAgICAgICAgICAgJHJlZjogJyMvZGVmaW5pdGlvbnMvdGVzdDMnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgb2JqOiB7XG4gICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAgIGRlZXA6IHtcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICAgICAgICBhcnI6IHtcbiAgICAgICAgICAgICAgICAgICAgJHJlZjogJyMvZGVmaW5pdGlvbnMvdGVzdDMnLFxuICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBkZWZpbml0aW9uczoge1xuICAgICAgICAgIGV4YW1wbGU6IHtcbiAgICAgICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgICAgICRkZWZhdWx0OiB7XG4gICAgICAgICAgICAgICRzb3VyY2U6ICd0ZXN0JyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBvdGhlcjoge1xuICAgICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgICAkZGVmYXVsdDoge1xuICAgICAgICAgICAgICAkc291cmNlOiAndGVzdDInLFxuICAgICAgICAgICAgICBibHVlOiAneWVwJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICB0ZXN0Mzoge1xuICAgICAgICAgICAgdHlwZTogJ2FycmF5JyxcbiAgICAgICAgICAgICRkZWZhdWx0OiB7XG4gICAgICAgICAgICAgICRzb3VyY2U6ICd0ZXN0MycsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKHZhbGlkYXRvciA9PiB2YWxpZGF0b3IoZGF0YSkpLFxuICAgICAgICBtYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgZXhwZWN0KGRhdGEuYm9vbCkudG9CZSh0cnVlKTtcbiAgICAgICAgICBleHBlY3QoZGF0YS5hcnJbMF0udGVzdCkudG9CZSgneWVwJyk7XG4gICAgICAgICAgZXhwZWN0KGRhdGEuYXJyMikudG9FcXVhbChbMSwgMiwgM10pO1xuICAgICAgICAgIGV4cGVjdChkYXRhLm9iai5kZWVwLmFycikudG9FcXVhbChbMSwgMiwgM10pO1xuICAgICAgICB9KSxcbiAgICAgIClcbiAgICAgIC50b1Byb21pc2UoKS50aGVuKGRvbmUsIGRvbmUuZmFpbCk7XG4gIH0pO1xufSk7XG4iXX0=