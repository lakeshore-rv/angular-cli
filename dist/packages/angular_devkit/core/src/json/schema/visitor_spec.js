"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const rxjs_1 = require("rxjs");
const visitor_1 = require("./visitor");
function syncObs(obs) {
    let value;
    let set = false;
    obs
        .forEach(x => {
        if (set) {
            throw new Error('Multiple value.');
        }
        value = x;
        set = true;
    })
        .catch(err => fail(err));
    if (!set) {
        throw new Error('Async observable.');
    }
    return value; // tslint:disable-line:non-null-operator
}
describe('visitJson', () => {
    it('works to replace the root', () => {
        const json = { a: 1 };
        const newJson = {};
        const result = syncObs(visitor_1.visitJson(json, () => newJson));
        expect(result).toBe(newJson);
    });
    it('goes through recursively if replacing root', () => {
        const json = { a: 1 };
        const newJson = { b: 'hello ' };
        const result = syncObs(visitor_1.visitJson(json, value => {
            if (typeof value == 'object') {
                return newJson;
            }
            else {
                return value + 'world';
            }
        }));
        expect(result).toEqual({ b: 'hello world' });
        expect(newJson).toEqual({ b: 'hello world' });
    });
    it('goes through all replacements recursively', () => {
        const json = { a: 1 };
        const newJson = { b: '' };
        const newJson2 = { c: [] };
        const newJson3 = [1, 2, 3];
        const result = syncObs(visitor_1.visitJson(json, (value, ptr) => {
            if (ptr.endsWith('a')) {
                return newJson;
            }
            else if (ptr.endsWith('b')) {
                return newJson2;
            }
            else if (ptr.endsWith('c')) {
                return newJson3;
            }
            else if (typeof value == 'number') {
                return '_' + value;
            }
            else if (ptr == '/') {
                return value;
            }
            else {
                return 'abc';
            }
        }));
        expect(result).toEqual({ a: { b: { c: ['_1', '_2', '_3'] } } });
    });
    it('goes through all replacements recursively (async)', done => {
        const json = { a: 1 };
        const newJson = { b: '' };
        const newJson2 = { c: [] };
        const newJson3 = [1, 2, 3];
        visitor_1.visitJson(json, (value, ptr) => {
            if (ptr.endsWith('a')) {
                return rxjs_1.from(Promise.resolve(newJson));
            }
            else if (ptr.endsWith('b')) {
                return rxjs_1.from(Promise.resolve(newJson2));
            }
            else if (ptr.endsWith('c')) {
                return rxjs_1.from(Promise.resolve(newJson3));
            }
            else if (typeof value == 'number') {
                return rxjs_1.from(Promise.resolve('_' + value));
            }
            else if (ptr == '/') {
                return rxjs_1.from(Promise.resolve(value));
            }
            else {
                return rxjs_1.from(Promise.resolve('abc'));
            }
        }).toPromise().then(result => {
            expect(result).toEqual({ a: { b: { c: ['_1', '_2', '_3'] } } });
            done();
        }, done.fail);
    });
    it('works with schema', () => {
        const schema = {
            properties: {
                bool: { type: 'boolean' },
                str: { type: 'string', default: 'someString' },
                obj: {
                    properties: {
                        num: { type: 'number' },
                        other: { type: 'number', default: 0 },
                    },
                },
            },
        };
        const allPointers = {};
        function visitor(value, ptr, schema) {
            expect(allPointers[ptr]).toBeUndefined();
            allPointers[ptr] = schema;
            return value;
        }
        const json = {
            bool: true,
            str: 'hello',
            obj: {
                num: 1,
            },
        };
        const result = syncObs(visitor_1.visitJson(json, visitor, schema));
        expect(result).toEqual({
            bool: true,
            str: 'hello',
            obj: { num: 1 },
        });
        expect(allPointers).toEqual({
            '/': schema,
            '/bool': schema.properties.bool,
            '/str': schema.properties.str,
            '/obj': schema.properties.obj,
            '/obj/num': schema.properties.obj.properties.num,
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaXRvcl9zcGVjLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9lcm5pZWRhdmlzL0NvZGUvYW5ndWxhci1jbGkvIiwic291cmNlcyI6WyJwYWNrYWdlcy9hbmd1bGFyX2RldmtpdC9jb3JlL3NyYy9qc29uL3NjaGVtYS92aXNpdG9yX3NwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7O0dBTUc7QUFDSCwrQkFBd0M7QUFFeEMsdUNBQXNDO0FBR3RDLGlCQUFvQixHQUFrQjtJQUNwQyxJQUFJLEtBQVEsQ0FBQztJQUNiLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQztJQUVoQixHQUFHO1NBQ0EsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ1gsSUFBSSxHQUFHLEVBQUU7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDcEM7UUFDRCxLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsR0FBRyxHQUFHLElBQUksQ0FBQztJQUNiLENBQUMsQ0FBQztTQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRTNCLElBQUksQ0FBQyxHQUFHLEVBQUU7UUFDUixNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7S0FDdEM7SUFFRCxPQUFPLEtBQU8sQ0FBQyxDQUFFLHdDQUF3QztBQUMzRCxDQUFDO0FBR0QsUUFBUSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7SUFDekIsRUFBRSxDQUFDLDJCQUEyQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUN0QixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFFbkIsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLG1CQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFD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LE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDMUIsR0FBRyxFQUFFLE1BQU07WUFDWCxPQUFPLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJO1lBQy9CLE1BQU0sRUFBRSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUc7WUFDN0IsTUFBTSxFQUFFLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRztZQUM3QixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUc7U0FDakQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEpzb25PYmplY3QsIEpzb25WYWx1ZSB9IGZyb20gJy4uJztcbmltcG9ydCB7IHZpc2l0SnNvbiB9IGZyb20gJy4vdmlzaXRvcic7XG5cblxuZnVuY3Rpb24gc3luY09iczxUPihvYnM6IE9ic2VydmFibGU8VD4pOiBUIHtcbiAgbGV0IHZhbHVlOiBUO1xuICBsZXQgc2V0ID0gZmFsc2U7XG5cbiAgb2JzXG4gICAgLmZvckVhY2goeCA9PiB7XG4gICAgICBpZiAoc2V0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTXVsdGlwbGUgdmFsdWUuJyk7XG4gICAgICB9XG4gICAgICB2YWx1ZSA9IHg7XG4gICAgICBzZXQgPSB0cnVlO1xuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiBmYWlsKGVycikpO1xuXG4gIGlmICghc2V0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdBc3luYyBvYnNlcnZhYmxlLicpO1xuICB9XG5cbiAgcmV0dXJuIHZhbHVlICE7ICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vbi1udWxsLW9wZXJhdG9yXG59XG5cblxuZGVzY3JpYmUoJ3Zpc2l0SnNvbicsICgpID0+IHtcbiAgaXQoJ3dvcmtzIHRvIHJlcGxhY2UgdGhlIHJvb3QnLCAoKSA9PiB7XG4gICAgY29uc3QganNvbiA9IHsgYTogMSB9O1xuICAgIGNvbnN0IG5ld0pzb24gPSB7fTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IHN5bmNPYnModmlzaXRKc29uKGpzb24sICgpID0+IG5ld0pzb24pKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKG5ld0pzb24pO1xuICB9KTtcblxuICBpdCgnZ29lcyB0aHJvdWdoIHJlY3Vyc2l2ZWx5IGlmIHJlcGxhY2luZyByb290JywgKCkgPT4ge1xuICAgIGNvbnN0IGpzb24gPSB7IGE6IDEgfTtcbiAgICBjb25zdCBuZXdKc29uID0geyBiOiAnaGVsbG8gJyB9O1xuXG4gICAgY29uc3QgcmVzdWx0ID0gc3luY09icyh2aXNpdEpzb24oanNvbiwgdmFsdWUgPT4ge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0Jykge1xuICAgICAgICByZXR1cm4gbmV3SnNvbjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB2YWx1ZSArICd3b3JsZCc7XG4gICAgICB9XG4gICAgfSkpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyBiOiAnaGVsbG8gd29ybGQnIH0pO1xuICAgIGV4cGVjdChuZXdKc29uKS50b0VxdWFsKHsgYjogJ2hlbGxvIHdvcmxkJyB9KTtcbiAgfSk7XG5cbiAgaXQoJ2dvZXMgdGhyb3VnaCBhbGwgcmVwbGFjZW1lbnRzIHJlY3Vyc2l2ZWx5JywgKCkgPT4ge1xuICAgIGNvbnN0IGpzb24gPSB7IGE6IDEgfTtcbiAgICBjb25zdCBuZXdKc29uID0geyBiOiAnJyB9O1xuICAgIGNvbnN0IG5ld0pzb24yID0geyBjOiBbXSB9O1xuICAgIGNvbnN0IG5ld0pzb24zID0gWzEsIDIsIDNdO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gc3luY09icyh2aXNpdEpzb24oanNvbiwgKHZhbHVlLCBwdHIpID0+IHtcbiAgICAgIGlmIChwdHIuZW5kc1dpdGgoJ2EnKSkge1xuICAgICAgICByZXR1cm4gbmV3SnNvbjtcbiAgICAgIH0gZWxzZSBpZiAocHRyLmVuZHNXaXRoKCdiJykpIHtcbiAgICAgICAgcmV0dXJuIG5ld0pzb24yO1xuICAgICAgfSBlbHNlIGlmIChwdHIuZW5kc1dpdGgoJ2MnKSkge1xuICAgICAgICByZXR1cm4gbmV3SnNvbjM7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJykge1xuICAgICAgICByZXR1cm4gJ18nICsgdmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKHB0ciA9PSAnLycpIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuICdhYmMnO1xuICAgICAgfVxuICAgIH0pKTtcblxuICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyBhOiB7IGI6IHsgYzogWydfMScsICdfMicsICdfMyddIH0gfSB9KTtcbiAgfSk7XG5cbiAgaXQoJ2dvZXMgdGhyb3VnaCBhbGwgcmVwbGFjZW1lbnRzIHJlY3Vyc2l2ZWx5IChhc3luYyknLCBkb25lID0+IHtcbiAgICBjb25zdCBqc29uID0geyBhOiAxIH07XG4gICAgY29uc3QgbmV3SnNvbiA9IHsgYjogJycgfTtcbiAgICBjb25zdCBuZXdKc29uMiA9IHsgYzogW10gfTtcbiAgICBjb25zdCBuZXdKc29uMyA9IFsxLCAyLCAzXTtcblxuICAgIHZpc2l0SnNvbihqc29uLCAodmFsdWUsIHB0cikgPT4ge1xuICAgICAgaWYgKHB0ci5lbmRzV2l0aCgnYScpKSB7XG4gICAgICAgIHJldHVybiBmcm9tKFByb21pc2UucmVzb2x2ZShuZXdKc29uKSk7XG4gICAgICB9IGVsc2UgaWYgKHB0ci5lbmRzV2l0aCgnYicpKSB7XG4gICAgICAgIHJldHVybiBmcm9tKFByb21pc2UucmVzb2x2ZShuZXdKc29uMikpO1xuICAgICAgfSBlbHNlIGlmIChwdHIuZW5kc1dpdGgoJ2MnKSkge1xuICAgICAgICByZXR1cm4gZnJvbShQcm9taXNlLnJlc29sdmUobmV3SnNvbjMpKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICdudW1iZXInKSB7XG4gICAgICAgIHJldHVybiBmcm9tKFByb21pc2UucmVzb2x2ZSgnXycgKyB2YWx1ZSkpO1xuICAgICAgfSBlbHNlIGlmIChwdHIgPT0gJy8nKSB7XG4gICAgICAgIHJldHVybiBmcm9tKFByb21pc2UucmVzb2x2ZSh2YWx1ZSkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZyb20oUHJvbWlzZS5yZXNvbHZlKCdhYmMnKSk7XG4gICAgICB9XG4gICAgfSkudG9Qcm9taXNlKCkudGhlbihcbiAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoeyBhOiB7IGI6IHsgYzogWydfMScsICdfMicsICdfMyddIH0gfSB9KTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSxcbiAgICAgIGRvbmUuZmFpbCxcbiAgICApO1xuICB9KTtcblxuICBpdCgnd29ya3Mgd2l0aCBzY2hlbWEnLCAoKSA9PiB7XG4gICAgY29uc3Qgc2NoZW1hID0ge1xuICAgICAgcHJvcGVydGllczoge1xuICAgICAgICBib29sOiB7IHR5cGU6ICdib29sZWFuJyB9LFxuICAgICAgICBzdHI6IHsgdHlwZTogJ3N0cmluZycsIGRlZmF1bHQ6ICdzb21lU3RyaW5nJyB9LFxuICAgICAgICBvYmo6IHtcbiAgICAgICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBudW06IHsgdHlwZTogJ251bWJlcicgfSxcbiAgICAgICAgICAgIG90aGVyOiB7IHR5cGU6ICdudW1iZXInLCBkZWZhdWx0OiAwIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IGFsbFBvaW50ZXJzOiB7IFtwdHI6IHN0cmluZ106IEpzb25PYmplY3QgfCB1bmRlZmluZWQgfSA9IHt9O1xuICAgIGZ1bmN0aW9uIHZpc2l0b3IodmFsdWU6IEpzb25WYWx1ZSwgcHRyOiBzdHJpbmcsIHNjaGVtYT86IEpzb25PYmplY3QpIHtcbiAgICAgIGV4cGVjdChhbGxQb2ludGVyc1twdHJdKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBhbGxQb2ludGVyc1twdHJdID0gc2NoZW1hO1xuXG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuXG4gICAgY29uc3QganNvbiA9IHtcbiAgICAgIGJvb2w6IHRydWUsXG4gICAgICBzdHI6ICdoZWxsbycsXG4gICAgICBvYmo6IHtcbiAgICAgICAgbnVtOiAxLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzdWx0ID0gc3luY09icyh2aXNpdEpzb24oanNvbiwgdmlzaXRvciwgc2NoZW1hKSk7XG5cbiAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHtcbiAgICAgIGJvb2w6IHRydWUsXG4gICAgICBzdHI6ICdoZWxsbycsXG4gICAgICBvYmo6IHsgbnVtOiAxIH0sXG4gICAgfSk7XG4gICAgZXhwZWN0KGFsbFBvaW50ZXJzKS50b0VxdWFsKHtcbiAgICAgICcvJzogc2NoZW1hLFxuICAgICAgJy9ib29sJzogc2NoZW1hLnByb3BlcnRpZXMuYm9vbCxcbiAgICAgICcvc3RyJzogc2NoZW1hLnByb3BlcnRpZXMuc3RyLFxuICAgICAgJy9vYmonOiBzY2hlbWEucHJvcGVydGllcy5vYmosXG4gICAgICAnL29iai9udW0nOiBzY2hlbWEucHJvcGVydGllcy5vYmoucHJvcGVydGllcy5udW0sXG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=