"use strict";
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@angular-devkit/architect/testing");
const core_1 = require("@angular-devkit/core");
const operators_1 = require("rxjs/operators");
const utils_1 = require("../utils");
describe('Browser Builder build optimizer', () => {
    const outputPath = core_1.normalize('dist');
    const fileName = core_1.join(outputPath, 'main.js');
    beforeEach(done => utils_1.host.initialize().toPromise().then(done, done.fail));
    afterEach(done => utils_1.host.restore().toPromise().then(done, done.fail));
    it('works', (done) => {
        const overrides = { aot: true, buildOptimizer: true };
        testing_1.runTargetSpec(utils_1.host, utils_1.browserTargetSpec, overrides).pipe(operators_1.tap((buildEvent) => expect(buildEvent.success).toBe(true)), operators_1.tap(() => {
            const content = core_1.virtualFs.fileBufferToString(utils_1.host.scopedSync().read(core_1.normalize(fileName)));
            expect(content).not.toMatch(/\.decorators =/);
        })).toPromise().then(done, done.fail);
    });
    it('fails if AOT is disabled', (done) => {
        const overrides = { aot: false, buildOptimizer: true };
        testing_1.runTargetSpec(utils_1.host, utils_1.browserTargetSpec, overrides)
            .toPromise().then(() => done.fail(), () => done());
    });
    it('reduces bundle size', (done) => {
        const noBoOverrides = { aot: true, optimization: true, vendorChunk: false };
        const boOverrides = Object.assign({}, noBoOverrides, { buildOptimizer: true });
        let noBoSize;
        let boSize;
        testing_1.runTargetSpec(utils_1.host, utils_1.browserTargetSpec, noBoOverrides, testing_1.DefaultTimeout * 3).pipe(operators_1.tap((buildEvent) => expect(buildEvent.success).toBe(true)), operators_1.tap(() => {
            const noBoStats = utils_1.host.scopedSync().stat(core_1.normalize(fileName));
            if (!noBoStats) {
                throw new Error('Main file has no stats');
            }
            noBoSize = noBoStats.size;
        }), operators_1.concatMap(() => testing_1.runTargetSpec(utils_1.host, utils_1.browserTargetSpec, boOverrides, testing_1.DefaultTimeout * 3)), operators_1.tap((buildEvent) => expect(buildEvent.success).toBe(true)), operators_1.tap(() => {
            const boStats = utils_1.host.scopedSync().stat(core_1.normalize(fileName));
            if (!boStats) {
                throw new Error('Main file has no stats');
            }
            boSize = boStats.size;
        }), operators_1.tap(() => {
            const sizeDiff = Math.round(((boSize - noBoSize) / noBoSize) * 10000) / 100;
            if (sizeDiff > -1 && sizeDiff < 0) {
                throw new Error('Total size difference is too small, '
                    + 'build optimizer does not seem to have made any optimizations.');
            }
            if (sizeDiff > 1) {
                throw new Error('Total size difference is positive, '
                    + 'build optimizer made the bundle bigger.');
            }
        })).toPromise().then(done, done.fail);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQtb3B0aW1pemVyX3NwZWNfbGFyZ2UuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2VybmllZGF2aXMvQ29kZS9hbmd1bGFyLWNsaS8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L2J1aWxkX2FuZ3VsYXIvdGVzdC9icm93c2VyL2J1aWxkLW9wdGltaXplcl9zcGVjX2xhcmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7O0FBRUgsK0RBQWtGO0FBQ2xGLCtDQUFrRTtBQUNsRSw4Q0FBZ0Q7QUFDaEQsb0NBQW1EO0FBR25ELFFBQVEsQ0FBQyxpQ0FBaUMsRUFBRSxHQUFHLEVBQUU7SUFDL0MsTUFBTSxVQUFVLEdBQUcsZ0JBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNyQyxNQUFNLFFBQVEsR0FBRyxXQUFJLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBRTdDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFlBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFlBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRXBFLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUNuQixNQUFNLFNBQVMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3RELHVCQUFhLENBQUMsWUFBSSxFQUFFLHlCQUFpQixFQUFFLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FDcEQsZUFBRyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxN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QUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUM1RSxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsSUFBSSxRQUFRLEdBQUcsQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQztzQkFDbEQsK0RBQStELENBQUMsQ0FBQzthQUN0RTtZQUVELElBQUksUUFBUSxHQUFHLENBQUMsRUFBRTtnQkFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUM7c0JBQ2pELHlDQUF5QyxDQUFDLENBQUM7YUFDaEQ7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7IERlZmF1bHRUaW1lb3V0LCBydW5UYXJnZXRTcGVjIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdC90ZXN0aW5nJztcbmltcG9ydCB7IGpvaW4sIG5vcm1hbGl6ZSwgdmlydHVhbEZzIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBicm93c2VyVGFyZ2V0U3BlYywgaG9zdCB9IGZyb20gJy4uL3V0aWxzJztcblxuXG5kZXNjcmliZSgnQnJvd3NlciBCdWlsZGVyIGJ1aWxkIG9wdGltaXplcicsICgpID0+IHtcbiAgY29uc3Qgb3V0cHV0UGF0aCA9IG5vcm1hbGl6ZSgnZGlzdCcpO1xuICBjb25zdCBmaWxlTmFtZSA9IGpvaW4ob3V0cHV0UGF0aCwgJ21haW4uanMnKTtcblxuICBiZWZvcmVFYWNoKGRvbmUgPT4gaG9zdC5pbml0aWFsaXplKCkudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpKTtcbiAgYWZ0ZXJFYWNoKGRvbmUgPT4gaG9zdC5yZXN0b3JlKCkudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpKTtcblxuICBpdCgnd29ya3MnLCAoZG9uZSkgPT4ge1xuICAgIGNvbnN0IG92ZXJyaWRlcyA9IHsgYW90OiB0cnVlLCBidWlsZE9wdGltaXplcjogdHJ1ZSB9O1xuICAgIHJ1blRhcmdldFNwZWMoaG9zdCwgYnJvd3NlclRhcmdldFNwZWMsIG92ZXJyaWRlcykucGlwZShcbiAgICAgIHRhcCgoYnVpbGRFdmVudCkgPT4gZXhwZWN0KGJ1aWxkRXZlbnQuc3VjY2VzcykudG9CZSh0cnVlKSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gdmlydHVhbEZzLmZpbGVCdWZmZXJUb1N0cmluZyhob3N0LnNjb3BlZFN5bmMoKS5yZWFkKG5vcm1hbGl6ZShmaWxlTmFtZSkpKTtcbiAgICAgICAgZXhwZWN0KGNvbnRlbnQpLm5vdC50b01hdGNoKC9cXC5kZWNvcmF0b3JzID0vKTtcbiAgICAgIH0pLFxuICAgICkudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnZmFpbHMgaWYgQU9UIGlzIGRpc2FibGVkJywgKGRvbmUpID0+IHtcbiAgICBjb25zdCBvdmVycmlkZXMgPSB7IGFvdDogZmFsc2UsIGJ1aWxkT3B0aW1pemVyOiB0cnVlIH07XG4gICAgcnVuVGFyZ2V0U3BlYyhob3N0LCBicm93c2VyVGFyZ2V0U3BlYywgb3ZlcnJpZGVzKVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4oKCkgPT4gZG9uZS5mYWlsKCksICgpID0+IGRvbmUoKSk7XG4gIH0pO1xuXG4gIGl0KCdyZWR1Y2VzIGJ1bmRsZSBzaXplJywgKGRvbmUpID0+IHtcbiAgICBjb25zdCBub0JvT3ZlcnJpZGVzID0geyBhb3Q6IHRydWUsIG9wdGltaXphdGlvbjogdHJ1ZSwgdmVuZG9yQ2h1bms6IGZhbHNlIH07XG4gICAgY29uc3QgYm9PdmVycmlkZXMgPSB7IC4uLm5vQm9PdmVycmlkZXMsIGJ1aWxkT3B0aW1pemVyOiB0cnVlIH07XG5cbiAgICBsZXQgbm9Cb1NpemU6IG51bWJlcjtcbiAgICBsZXQgYm9TaXplOiBudW1iZXI7XG5cbiAgICBydW5UYXJnZXRTcGVjKGhvc3QsIGJyb3dzZXJUYXJnZXRTcGVjLCBub0JvT3ZlcnJpZGVzLCBEZWZhdWx0VGltZW91dCAqIDMpLnBpcGUoXG4gICAgICB0YXAoKGJ1aWxkRXZlbnQpID0+IGV4cGVjdChidWlsZEV2ZW50LnN1Y2Nlc3MpLnRvQmUodHJ1ZSkpLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgY29uc3Qgbm9Cb1N0YXRzID0gaG9zdC5zY29wZWRTeW5jKCkuc3RhdChub3JtYWxpemUoZmlsZU5hbWUpKTtcbiAgICAgICAgaWYgKCFub0JvU3RhdHMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01haW4gZmlsZSBoYXMgbm8gc3RhdHMnKTtcbiAgICAgICAgfVxuICAgICAgICBub0JvU2l6ZSA9IG5vQm9TdGF0cy5zaXplO1xuICAgICAgfSksXG4gICAgICBjb25jYXRNYXAoKCkgPT4gcnVuVGFyZ2V0U3BlYyhob3N0LCBicm93c2VyVGFyZ2V0U3BlYywgYm9PdmVycmlkZXMsIERlZmF1bHRUaW1lb3V0ICogMykpLFxuICAgICAgdGFwKChidWlsZEV2ZW50KSA9PiBleHBlY3QoYnVpbGRFdmVudC5zdWNjZXNzKS50b0JlKHRydWUpKSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IGJvU3RhdHMgPSBob3N0LnNjb3BlZFN5bmMoKS5zdGF0KG5vcm1hbGl6ZShmaWxlTmFtZSkpO1xuICAgICAgICBpZiAoIWJvU3RhdHMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01haW4gZmlsZSBoYXMgbm8gc3RhdHMnKTtcbiAgICAgICAgfVxuICAgICAgICBib1NpemUgPSBib1N0YXRzLnNpemU7XG4gICAgICB9KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHNpemVEaWZmID0gTWF0aC5yb3VuZCgoKGJvU2l6ZSAtIG5vQm9TaXplKSAvIG5vQm9TaXplKSAqIDEwMDAwKSAvIDEwMDtcbiAgICAgICAgaWYgKHNpemVEaWZmID4gLTEgJiYgc2l6ZURpZmYgPCAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb3RhbCBzaXplIGRpZmZlcmVuY2UgaXMgdG9vIHNtYWxsLCAnXG4gICAgICAgICAgICArICdidWlsZCBvcHRpbWl6ZXIgZG9lcyBub3Qgc2VlbSB0byBoYXZlIG1hZGUgYW55IG9wdGltaXphdGlvbnMuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoc2l6ZURpZmYgPiAxKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUb3RhbCBzaXplIGRpZmZlcmVuY2UgaXMgcG9zaXRpdmUsICdcbiAgICAgICAgICAgICsgJ2J1aWxkIG9wdGltaXplciBtYWRlIHRoZSBidW5kbGUgYmlnZ2VyLicpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApLnRvUHJvbWlzZSgpLnRoZW4oZG9uZSwgZG9uZS5mYWlsKTtcbiAgfSk7XG59KTtcbiJdfQ==