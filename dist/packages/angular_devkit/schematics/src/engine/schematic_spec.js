"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// tslint:disable:non-null-operator
const core_1 = require("@angular-devkit/core");
const rxjs_1 = require("rxjs");
const base_1 = require("../rules/base");
const interface_1 = require("../tree/interface");
const static_1 = require("../tree/static");
const schematic_1 = require("./schematic");
const context = {
    debug: false,
    logger: new core_1.logging.NullLogger(),
    strategy: interface_1.MergeStrategy.Default,
};
const engine = {
    createContext: (schematic) => (Object.assign({ engine, schematic }, context)),
    transformOptions: (_, options) => rxjs_1.of(options),
    defaultMergeStrategy: interface_1.MergeStrategy.Default,
};
const collection = {
    name: 'collection',
    description: 'description',
};
function files(tree) {
    const files = [];
    tree.visit(x => files.push(x));
    return files;
}
describe('Schematic', () => {
    it('works with a rule', done => {
        let inner = null;
        const desc = {
            collection,
            name: 'test',
            description: '',
            path: '/a/b/c',
            factory: () => (tree) => {
                inner = static_1.branch(tree);
                tree.create('a/b/c', 'some content');
                return tree;
            },
        };
        const schematic = new schematic_1.SchematicImpl(desc, desc.factory, null, engine);
        schematic.call({}, rxjs_1.of(static_1.empty()))
            .toPromise()
            .then(x => {
            expect(files(inner)).toEqual([]);
            expect(files(x)).toEqual(['/a/b/c']);
        })
            .then(done, done.fail);
    });
    it('works with a rule that returns an observable', done => {
        let inner = null;
        const desc = {
            collection,
            name: 'test',
            description: '',
            path: 'a/b/c',
            factory: () => (fem) => {
                inner = fem;
                return rxjs_1.of(static_1.empty());
            },
        };
        const schematic = new schematic_1.SchematicImpl(desc, desc.factory, null, engine);
        schematic.call({}, rxjs_1.of(static_1.empty()))
            .toPromise()
            .then(x => {
            expect(files(inner)).toEqual([]);
            expect(files(x)).toEqual([]);
            expect(inner).not.toBe(x);
        })
            .then(done, done.fail);
    });
    it('works with nested chained function rules', done => {
        let chainCount = 0;
        let oneCount = 0;
        let twoCount = 0;
        let threeCount = 0;
        const one = () => {
            return base_1.chain([
                () => { oneCount++; },
            ]);
        };
        const two = () => {
            return base_1.chain([
                () => { twoCount++; },
            ]);
        };
        const three = () => {
            threeCount++;
        };
        const desc = {
            collection,
            name: 'test',
            description: '',
            path: '/a/b/c',
            factory: () => {
                return base_1.chain([
                    () => { chainCount++; },
                    one,
                    two,
                    three,
                ]);
            },
        };
        const schematic = new schematic_1.SchematicImpl(desc, desc.factory, null, engine);
        schematic.call({}, rxjs_1.of(static_1.empty()))
            .toPromise()
            .then(_x => {
            expect(chainCount).toBe(1);
            expect(oneCount).toBe(1);
            expect(twoCount).toBe(1);
            expect(threeCount).toBe(1);
        })
            .then(done, done.fail);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZW1hdGljX3NwZWMuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2VybmllZGF2aXMvQ29kZS9hbmd1bGFyLWNsaS8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXJfZGV2a2l0L3NjaGVtYXRpY3Mvc3JjL2VuZ2luZS9zY2hlbWF0aWNfc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOzs7Ozs7R0FNRztBQUNILG1DQUFtQztBQUNuQywrQ0FBK0M7QUFDL0MsK0JBQTBDO0FBQzFDLHdDQUFzQztBQUN0QyxpREFBd0Q7QUFDeEQsMkNBQStDO0FBRS9DLDJDQUE0QztBQWE1QyxNQUFNLE9BQU8sR0FBRztJQUNkLEtBQUssRUFBRSxLQUFLO0lBQ1osTUFBTSxFQUFFLElBQUksY0FBTyxDQUFDLFVBQVUsRUFBRTtJQUNoQyxRQUFRLEVBQUUseUJBQWEsQ0FBQyxPQUFPO0NBQ2hDLENBQUM7QUFDRixNQUFNLE1BQU0sR0FBb0M7SUFDOUMsYUFBYSxFQUFFLENBQUMsU0FBNEIsRUFBRSxFQUFFLENBQUMsaUJBQUcsTUFBTSxFQUFFLFNBQVMsSUFBSyxPQUFPLEVBQUc7SUFDcEYsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFLLEVBQUUsT0FBVyxFQUFFLEVBQUUsQ0FBQyxTQUFZLENBQUMsT0FBTyxDQUFDO0lBQy9ELG9CQUFvQixFQUFFLHlCQUFhLENBQUMsT0FBTztDQUNILENBQUM7QUFDM0MsTUFBTSxVQUFVLEdBQUc7SUFDakIsSUFBSSxFQUFFLFlBQVk7SUFDbEIsV0FBVyxFQUFFLGFBQWE7Q0FDVyxDQUFDO0FBR3hDLGVBQWUsSUFBVTtJQUN2QixNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7SUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUUvQixPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFHRCxRQUFRLENBQUMsV0FBVyxFQUFF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Q0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQzthQUNELElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0FBRUwsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG4vLyB0c2xpbnQ6ZGlzYWJsZTpub24tbnVsbC1vcGVyYXRvclxuaW1wb3J0IHsgbG9nZ2luZyB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCB7IG9mIGFzIG9ic2VydmFibGVPZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2hhaW4gfSBmcm9tICcuLi9ydWxlcy9iYXNlJztcbmltcG9ydCB7IE1lcmdlU3RyYXRlZ3ksIFRyZWUgfSBmcm9tICcuLi90cmVlL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBicmFuY2gsIGVtcHR5IH0gZnJvbSAnLi4vdHJlZS9zdGF0aWMnO1xuaW1wb3J0IHsgQ29sbGVjdGlvbkRlc2NyaXB0aW9uLCBFbmdpbmUsIFJ1bGUsIFNjaGVtYXRpYywgU2NoZW1hdGljRGVzY3JpcHRpb24gfSBmcm9tICcuL2ludGVyZmFjZSc7XG5pbXBvcnQgeyBTY2hlbWF0aWNJbXBsIH0gZnJvbSAnLi9zY2hlbWF0aWMnO1xuXG5cbnR5cGUgQ29sbGVjdGlvblQgPSB7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG59O1xudHlwZSBTY2hlbWF0aWNUID0ge1xuICBjb2xsZWN0aW9uOiBDb2xsZWN0aW9uVDtcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgcGF0aDogc3RyaW5nO1xuICBmYWN0b3J5OiA8VD4ob3B0aW9uczogVCkgPT4gUnVsZTtcbn07XG5cbmNvbnN0IGNvbnRleHQgPSB7XG4gIGRlYnVnOiBmYWxzZSxcbiAgbG9nZ2VyOiBuZXcgbG9nZ2luZy5OdWxsTG9nZ2VyKCksXG4gIHN0cmF0ZWd5OiBNZXJnZVN0cmF0ZWd5LkRlZmF1bHQsXG59O1xuY29uc3QgZW5naW5lOiBFbmdpbmU8Q29sbGVjdGlvblQsIFNjaGVtYXRpY1Q+ID0ge1xuICBjcmVhdGVDb250ZXh0OiAoc2NoZW1hdGljOiBTY2hlbWF0aWM8e30sIHt9PikgPT4gKHsgZW5naW5lLCBzY2hlbWF0aWMsIC4uLmNvbnRleHQgfSksXG4gIHRyYW5zZm9ybU9wdGlvbnM6IChfOiB7fSwgb3B0aW9uczoge30pID0+IG9ic2VydmFibGVPZihvcHRpb25zKSxcbiAgZGVmYXVsdE1lcmdlU3RyYXRlZ3k6IE1lcmdlU3RyYXRlZ3kuRGVmYXVsdCxcbn0gYXMge30gYXMgRW5naW5lPENvbGxlY3Rpb25ULCBTY2hlbWF0aWNUPjtcbmNvbnN0IGNvbGxlY3Rpb24gPSB7XG4gIG5hbWU6ICdjb2xsZWN0aW9uJyxcbiAgZGVzY3JpcHRpb246ICdkZXNjcmlwdGlvbicsXG59IGFzIENvbGxlY3Rpb25EZXNjcmlwdGlvbjxDb2xsZWN0aW9uVD47XG5cblxuZnVuY3Rpb24gZmlsZXModHJlZTogVHJlZSkge1xuICBjb25zdCBmaWxlczogc3RyaW5nW10gPSBbXTtcbiAgdHJlZS52aXNpdCh4ID0+IGZpbGVzLnB1c2goeCkpO1xuXG4gIHJldHVybiBmaWxlcztcbn1cblxuXG5kZXNjcmliZSgnU2NoZW1hdGljJywgKCkgPT4ge1xuICBpdCgnd29ya3Mgd2l0aCBhIHJ1bGUnLCBkb25lID0+IHtcbiAgICBsZXQgaW5uZXI6IFRyZWUgfCBudWxsID0gbnVsbDtcbiAgICBjb25zdCBkZXNjOiBTY2hlbWF0aWNEZXNjcmlwdGlvbjxDb2xsZWN0aW9uVCwgU2NoZW1hdGljVD4gPSB7XG4gICAgICBjb2xsZWN0aW9uLFxuICAgICAgbmFtZTogJ3Rlc3QnLFxuICAgICAgZGVzY3JpcHRpb246ICcnLFxuICAgICAgcGF0aDogJy9hL2IvYycsXG4gICAgICBmYWN0b3J5OiAoKSA9PiAodHJlZTogVHJlZSkgPT4ge1xuICAgICAgICBpbm5lciA9IGJyYW5jaCh0cmVlKTtcbiAgICAgICAgdHJlZS5jcmVhdGUoJ2EvYi9jJywgJ3NvbWUgY29udGVudCcpO1xuXG4gICAgICAgIHJldHVybiB0cmVlO1xuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3Qgc2NoZW1hdGljID0gbmV3IFNjaGVtYXRpY0ltcGwoZGVzYywgZGVzYy5mYWN0b3J5LCBudWxsICEsIGVuZ2luZSk7XG4gICAgc2NoZW1hdGljLmNhbGwoe30sIG9ic2VydmFibGVPZihlbXB0eSgpKSlcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4oeCA9PiB7XG4gICAgICAgIGV4cGVjdChmaWxlcyhpbm5lciAhKSkudG9FcXVhbChbXSk7XG4gICAgICAgIGV4cGVjdChmaWxlcyh4KSkudG9FcXVhbChbJy9hL2IvYyddKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnd29ya3Mgd2l0aCBhIHJ1bGUgdGhhdCByZXR1cm5zIGFuIG9ic2VydmFibGUnLCBkb25lID0+IHtcbiAgICBsZXQgaW5uZXI6IFRyZWUgfCBudWxsID0gbnVsbDtcbiAgICBjb25zdCBkZXNjOiBTY2hlbWF0aWNEZXNjcmlwdGlvbjxDb2xsZWN0aW9uVCwgU2NoZW1hdGljVD4gPSB7XG4gICAgICBjb2xsZWN0aW9uLFxuICAgICAgbmFtZTogJ3Rlc3QnLFxuICAgICAgZGVzY3JpcHRpb246ICcnLFxuICAgICAgcGF0aDogJ2EvYi9jJyxcbiAgICAgIGZhY3Rvcnk6ICgpID0+IChmZW06IFRyZWUpID0+IHtcbiAgICAgICAgaW5uZXIgPSBmZW07XG5cbiAgICAgICAgcmV0dXJuIG9ic2VydmFibGVPZihlbXB0eSgpKTtcbiAgICAgIH0sXG4gICAgfTtcblxuXG4gICAgY29uc3Qgc2NoZW1hdGljID0gbmV3IFNjaGVtYXRpY0ltcGwoZGVzYywgZGVzYy5mYWN0b3J5LCBudWxsICEsIGVuZ2luZSk7XG4gICAgc2NoZW1hdGljLmNhbGwoe30sIG9ic2VydmFibGVPZihlbXB0eSgpKSlcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4oeCA9PiB7XG4gICAgICAgIGV4cGVjdChmaWxlcyhpbm5lciAhKSkudG9FcXVhbChbXSk7XG4gICAgICAgIGV4cGVjdChmaWxlcyh4KSkudG9FcXVhbChbXSk7XG4gICAgICAgIGV4cGVjdChpbm5lcikubm90LnRvQmUoeCk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oZG9uZSwgZG9uZS5mYWlsKTtcbiAgfSk7XG5cbiAgaXQoJ3dvcmtzIHdpdGggbmVzdGVkIGNoYWluZWQgZnVuY3Rpb24gcnVsZXMnLCBkb25lID0+IHtcbiAgICBsZXQgY2hhaW5Db3VudCA9IDA7XG4gICAgbGV0IG9uZUNvdW50ID0gMDtcbiAgICBsZXQgdHdvQ291bnQgPSAwO1xuICAgIGxldCB0aHJlZUNvdW50ID0gMDtcbiAgICBjb25zdCBvbmUgPSAoKSA9PiB7XG4gICAgICByZXR1cm4gY2hhaW4oW1xuICAgICAgICAoKSA9PiB7IG9uZUNvdW50Kys7IH0sXG4gICAgICBdKTtcbiAgICB9O1xuICAgIGNvbnN0IHR3byA9ICgpID0+IHtcbiAgICAgIHJldHVybiBjaGFpbihbXG4gICAgICAgICgpID0+IHsgdHdvQ291bnQrKzsgfSxcbiAgICAgIF0pO1xuICAgIH07XG4gICAgY29uc3QgdGhyZWUgPSAoKSA9PiB7XG4gICAgICB0aHJlZUNvdW50Kys7XG4gICAgfTtcblxuICAgIGNvbnN0IGRlc2M6IFNjaGVtYXRpY0Rlc2NyaXB0aW9uPENvbGxlY3Rpb25ULCBTY2hlbWF0aWNUPiA9IHtcbiAgICAgIGNvbGxlY3Rpb24sXG4gICAgICBuYW1lOiAndGVzdCcsXG4gICAgICBkZXNjcmlwdGlvbjogJycsXG4gICAgICBwYXRoOiAnL2EvYi9jJyxcbiAgICAgIGZhY3Rvcnk6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNoYWluKFtcbiAgICAgICAgICAoKSA9PiB7IGNoYWluQ291bnQrKzsgfSxcbiAgICAgICAgICBvbmUsXG4gICAgICAgICAgdHdvLFxuICAgICAgICAgIHRocmVlLFxuICAgICAgICBdKTtcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHNjaGVtYXRpYyA9IG5ldyBTY2hlbWF0aWNJbXBsKGRlc2MsIGRlc2MuZmFjdG9yeSwgbnVsbCAhLCBlbmdpbmUpO1xuICAgIHNjaGVtYXRpYy5jYWxsKHt9LCBvYnNlcnZhYmxlT2YoZW1wdHkoKSkpXG4gICAgICAudG9Qcm9taXNlKClcbiAgICAgIC50aGVuKF94ID0+IHtcbiAgICAgICAgZXhwZWN0KGNoYWluQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdChvbmVDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHR3b0NvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3QodGhyZWVDb3VudCkudG9CZSgxKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxufSk7XG4iXX0=