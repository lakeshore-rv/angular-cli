"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
// tslint:disable:no-implicit-dependencies
const core_1 = require("@angular-devkit/core");
const testing_1 = require("@angular-devkit/core/node/testing");
const schematics_1 = require("@angular-devkit/schematics");
const testing_2 = require("@angular-devkit/schematics/testing");
const path = require("path");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
describe('TsLintTaskExecutor', () => {
    it('works with config object', done => {
        const testRunner = new testing_2.SchematicTestRunner('@_/test', path.join(__dirname, 'test/collection.json'));
        const host = new testing_1.TempScopedNodeJsSyncHost();
        host.write(core_1.normalize('/file.ts'), core_1.virtualFs.stringToFileBuffer(`
      export function() { console.log(1); }
    `)).subscribe();
        const tree = new testing_2.UnitTestTree(new schematics_1.HostTree(host));
        testRunner.runSchematicAsync('run-task', null, tree)
            .toPromise().then(done, done.fail);
    });
    it('shows errors with config object', done => {
        const testRunner = new testing_2.SchematicTestRunner('@_/test', path.join(__dirname, 'test/collection.json'));
        const host = new testing_1.TempScopedNodeJsSyncHost();
        host.write(core_1.normalize('/file.ts'), core_1.virtualFs.stringToFileBuffer(`
      // ${'...MORE_THAN_100'.repeat(10)}
      export function() { console.log(1); }
    `)).subscribe();
        const tree = new testing_2.UnitTestTree(new schematics_1.HostTree(host));
        const messages = [];
        let error = false;
        rxjs_1.concat(testRunner.runSchematicAsync('run-task', null, tree), new rxjs_1.Observable(obs => {
            process.chdir(core_1.getSystemPath(host.root));
            testRunner.logger.subscribe(x => messages.push(x.message));
            testRunner.engine.executePostTasks().subscribe(obs);
        }).pipe(operators_1.catchError(() => {
            error = true;
            return [];
        })), new rxjs_1.Observable(obs => {
            expect(messages.find(msg => /\b80\b/.test(msg))).not.toBeUndefined();
            expect(error).toBe(true);
            obs.complete();
        })).toPromise().then(done, done.fail);
    });
    it('supports custom rules in the project (pass)', done => {
        const testRunner = new testing_2.SchematicTestRunner('@_/test', path.join(__dirname, 'test/collection.json'));
        const host = new testing_1.TempScopedNodeJsSyncHost();
        host.write(core_1.normalize('/file.ts'), core_1.virtualFs.stringToFileBuffer(`
      console.log('hello world');
    `)).subscribe();
        const tree = new testing_2.UnitTestTree(new schematics_1.HostTree(host));
        const messages = [];
        rxjs_1.concat(testRunner.runSchematicAsync('custom-rule', { shouldPass: true }, tree), new rxjs_1.Observable(obs => {
            process.chdir(core_1.getSystemPath(host.root));
            testRunner.logger.subscribe(x => messages.push(x.message));
            testRunner.engine.executePostTasks().subscribe(obs);
        })).toPromise().then(done, done.fail);
    });
    it('supports custom rules in the project (fail)', done => {
        const testRunner = new testing_2.SchematicTestRunner('@_/test', path.join(__dirname, 'test/collection.json'));
        const host = new testing_1.TempScopedNodeJsSyncHost();
        host.write(core_1.normalize('/file.ts'), core_1.virtualFs.stringToFileBuffer(`
      console.log('hello world');
    `)).subscribe();
        const tree = new testing_2.UnitTestTree(new schematics_1.HostTree(host));
        const messages = [];
        let error = false;
        rxjs_1.concat(testRunner.runSchematicAsync('custom-rule', { shouldPass: false }, tree), new rxjs_1.Observable(obs => {
            process.chdir(core_1.getSystemPath(host.root));
            testRunner.logger.subscribe(x => messages.push(x.message));
            testRunner.engine.executePostTasks().subscribe(obs);
        }).pipe(operators_1.catchError(() => {
            error = true;
            return [];
        })), new rxjs_1.Observable(obs => {
            expect(messages.find(msg => /\bcustom-rule fail\b/.test(msg))).not.toBeUndefined();
            expect(error).toBe(true);
            obs.complete();
        })).toPromise().then(done, done.fail);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlY3V0b3Jfc3BlYy5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvZXJuaWVkYXZpcy9Db2RlL2FuZ3VsYXItY2xpLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvc2NoZW1hdGljcy90YXNrcy90c2xpbnQtZml4L2V4ZWN1dG9yX3NwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7O0dBTUc7QUFDSCwwQ0FBMEM7QUFDMUMsK0NBQTJFO0FBQzNFLCtEQUE2RTtBQUM3RSwyREFBc0Q7QUFDdEQsZ0VBQXVGO0FBQ3ZGLDZCQUE2QjtBQUM3QiwrQkFBMEM7QUFDMUMsOENBQTRDO0FBRTVDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7SUFFbEMsRUFBRSxDQUFDLDBCQUEwQixFQUFFLElBQUksQ0FBQyxFQUFFO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksNkJBQW1CLENBQ3hDLFNBQVMsRUFDVCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxzQkFBc0IsQ0FBQyxDQUM3QyxDQUFDO1FBRUYsTUFBTSxJQUFJLEdBQUcsSUFBSSxrQ0FBd0IsRUFBRSxDQUFDO1FBQzVDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRSxnQkFBUyxDQUFDLGtCQUFrQixDQUFDOztLQUU5RCxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNoQixNQUFNLElBQUksR0FBRyxJQUFJLHNCQUFZLENBQUMsSUFBSSxxQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFbEQsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDO2FBQ2pELFNBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLGlDQUFpQyxFQUFFLElB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T0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLFVBQVUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUMzRCxVQUFVLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDTCxzQkFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLEtBQUssR0FBRyxJQUFJLENBQUM7WUFFYixPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUMsQ0FBQyxDQUNILEVBQ0QsSUFBSSxpQkFBVSxDQUFPLEdBQUcsQ0FBQyxFQUFFO1lBQ3pCLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDbkYsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV6QixHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDLENBQUMsQ0FBQztBQUVMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLy8gdHNsaW50OmRpc2FibGU6bm8taW1wbGljaXQtZGVwZW5kZW5jaWVzXG5pbXBvcnQgeyBnZXRTeXN0ZW1QYXRoLCBub3JtYWxpemUsIHZpcnR1YWxGcyB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCB7IFRlbXBTY29wZWROb2RlSnNTeW5jSG9zdCB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlL25vZGUvdGVzdGluZyc7XG5pbXBvcnQgeyBIb3N0VHJlZSB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcbmltcG9ydCB7IFNjaGVtYXRpY1Rlc3RSdW5uZXIsIFVuaXRUZXN0VHJlZSB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzL3Rlc3RpbmcnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGNvbmNhdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZGVzY3JpYmUoJ1RzTGludFRhc2tFeGVjdXRvcicsICgpID0+IHtcblxuICBpdCgnd29ya3Mgd2l0aCBjb25maWcgb2JqZWN0JywgZG9uZSA9PiB7XG4gICAgY29uc3QgdGVzdFJ1bm5lciA9IG5ldyBTY2hlbWF0aWNUZXN0UnVubmVyKFxuICAgICAgJ0BfL3Rlc3QnLFxuICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3Rlc3QvY29sbGVjdGlvbi5qc29uJyksXG4gICAgKTtcblxuICAgIGNvbnN0IGhvc3QgPSBuZXcgVGVtcFNjb3BlZE5vZGVKc1N5bmNIb3N0KCk7XG4gICAgaG9zdC53cml0ZShub3JtYWxpemUoJy9maWxlLnRzJyksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIoYFxuICAgICAgZXhwb3J0IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygxKTsgfVxuICAgIGApKS5zdWJzY3JpYmUoKTtcbiAgICBjb25zdCB0cmVlID0gbmV3IFVuaXRUZXN0VHJlZShuZXcgSG9zdFRyZWUoaG9zdCkpO1xuXG4gICAgdGVzdFJ1bm5lci5ydW5TY2hlbWF0aWNBc3luYygncnVuLXRhc2snLCBudWxsLCB0cmVlKVxuICAgICAgLnRvUHJvbWlzZSgpLnRoZW4oZG9uZSwgZG9uZS5mYWlsKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3dzIGVycm9ycyB3aXRoIGNvbmZpZyBvYmplY3QnLCBkb25lID0+IHtcbiAgICBjb25zdCB0ZXN0UnVubmVyID0gbmV3IFNjaGVtYXRpY1Rlc3RSdW5uZXIoXG4gICAgICAnQF8vdGVzdCcsXG4gICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdC9jb2xsZWN0aW9uLmpzb24nKSxcbiAgICApO1xuXG4gICAgY29uc3QgaG9zdCA9IG5ldyBUZW1wU2NvcGVkTm9kZUpzU3luY0hvc3QoKTtcbiAgICBob3N0LndyaXRlKG5vcm1hbGl6ZSgnL2ZpbGUudHMnKSwgdmlydHVhbEZzLnN0cmluZ1RvRmlsZUJ1ZmZlcihgXG4gICAgICAvLyAkeycuLi5NT1JFX1RIQU5fMTAwJy5yZXBlYXQoMTApfVxuICAgICAgZXhwb3J0IGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygxKTsgfVxuICAgIGApKS5zdWJzY3JpYmUoKTtcbiAgICBjb25zdCB0cmVlID0gbmV3IFVuaXRUZXN0VHJlZShuZXcgSG9zdFRyZWUoaG9zdCkpO1xuXG4gICAgY29uc3QgbWVzc2FnZXM6IHN0cmluZ1tdID0gW107XG4gICAgbGV0IGVycm9yID0gZmFsc2U7XG5cbiAgICBjb25jYXQoXG4gICAgICB0ZXN0UnVubmVyLnJ1blNjaGVtYXRpY0FzeW5jKCdydW4tdGFzaycsIG51bGwsIHRyZWUpLFxuICAgICAgbmV3IE9ic2VydmFibGU8dm9pZD4ob2JzID0+IHtcbiAgICAgICAgcHJvY2Vzcy5jaGRpcihnZXRTeXN0ZW1QYXRoKGhvc3Qucm9vdCkpO1xuICAgICAgICB0ZXN0UnVubmVyLmxvZ2dlci5zdWJzY3JpYmUoeCA9PiBtZXNzYWdlcy5wdXNoKHgubWVzc2FnZSkpO1xuICAgICAgICB0ZXN0UnVubmVyLmVuZ2luZS5leGVjdXRlUG9zdFRhc2tzKCkuc3Vic2NyaWJlKG9icyk7XG4gICAgICB9KS5waXBlKFxuICAgICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgICBlcnJvciA9IHRydWU7XG5cbiAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH0pLFxuICAgICAgKSxcbiAgICAgIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KG9icyA9PiB7XG4gICAgICAgIGV4cGVjdChtZXNzYWdlcy5maW5kKG1zZyA9PiAvXFxiODBcXGIvLnRlc3QobXNnKSkpLm5vdC50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIGV4cGVjdChlcnJvcikudG9CZSh0cnVlKTtcblxuICAgICAgICBvYnMuY29tcGxldGUoKTtcbiAgICAgIH0pLFxuICAgICkudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxuICBpdCgnc3VwcG9ydHMgY3VzdG9tIHJ1bGVzIGluIHRoZSBwcm9qZWN0IChwYXNzKScsIGRvbmUgPT4ge1xuICAgIGNvbnN0IHRlc3RSdW5uZXIgPSBuZXcgU2NoZW1hdGljVGVzdFJ1bm5lcihcbiAgICAgICdAXy90ZXN0JyxcbiAgICAgIHBhdGguam9pbihfX2Rpcm5hbWUsICd0ZXN0L2NvbGxlY3Rpb24uanNvbicpLFxuICAgICk7XG5cbiAgICBjb25zdCBob3N0ID0gbmV3IFRlbXBTY29wZWROb2RlSnNTeW5jSG9zdCgpO1xuICAgIGhvc3Qud3JpdGUobm9ybWFsaXplKCcvZmlsZS50cycpLCB2aXJ0dWFsRnMuc3RyaW5nVG9GaWxlQnVmZmVyKGBcbiAgICAgIGNvbnNvbGUubG9nKCdoZWxsbyB3b3JsZCcpO1xuICAgIGApKS5zdWJzY3JpYmUoKTtcbiAgICBjb25zdCB0cmVlID0gbmV3IFVuaXRUZXN0VHJlZShuZXcgSG9zdFRyZWUoaG9zdCkpO1xuXG4gICAgY29uc3QgbWVzc2FnZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBjb25jYXQoXG4gICAgICB0ZXN0UnVubmVyLnJ1blNjaGVtYXRpY0FzeW5jKCdjdXN0b20tcnVsZScsIHsgc2hvdWxkUGFzczogdHJ1ZSB9LCB0cmVlKSxcbiAgICAgIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KG9icyA9PiB7XG4gICAgICAgIHByb2Nlc3MuY2hkaXIoZ2V0U3lzdGVtUGF0aChob3N0LnJvb3QpKTtcbiAgICAgICAgdGVzdFJ1bm5lci5sb2dnZXIuc3Vic2NyaWJlKHggPT4gbWVzc2FnZXMucHVzaCh4Lm1lc3NhZ2UpKTtcbiAgICAgICAgdGVzdFJ1bm5lci5lbmdpbmUuZXhlY3V0ZVBvc3RUYXNrcygpLnN1YnNjcmliZShvYnMpO1xuICAgICAgfSksXG4gICAgKS50b1Byb21pc2UoKS50aGVuKGRvbmUsIGRvbmUuZmFpbCk7XG4gIH0pO1xuXG4gIGl0KCdzdXBwb3J0cyBjdXN0b20gcnVsZXMgaW4gdGhlIHByb2plY3QgKGZhaWwpJywgZG9uZSA9PiB7XG4gICAgY29uc3QgdGVzdFJ1bm5lciA9IG5ldyBTY2hlbWF0aWNUZXN0UnVubmVyKFxuICAgICAgJ0BfL3Rlc3QnLFxuICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3Rlc3QvY29sbGVjdGlvbi5qc29uJyksXG4gICAgKTtcblxuICAgIGNvbnN0IGhvc3QgPSBuZXcgVGVtcFNjb3BlZE5vZGVKc1N5bmNIb3N0KCk7XG4gICAgaG9zdC53cml0ZShub3JtYWxpemUoJy9maWxlLnRzJyksIHZpcnR1YWxGcy5zdHJpbmdUb0ZpbGVCdWZmZXIoYFxuICAgICAgY29uc29sZS5sb2coJ2hlbGxvIHdvcmxkJyk7XG4gICAgYCkpLnN1YnNjcmliZSgpO1xuICAgIGNvbnN0IHRyZWUgPSBuZXcgVW5pdFRlc3RUcmVlKG5ldyBIb3N0VHJlZShob3N0KSk7XG5cbiAgICBjb25zdCBtZXNzYWdlczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgZXJyb3IgPSBmYWxzZTtcblxuICAgIGNvbmNhdChcbiAgICAgIHRlc3RSdW5uZXIucnVuU2NoZW1hdGljQXN5bmMoJ2N1c3RvbS1ydWxlJywgeyBzaG91bGRQYXNzOiBmYWxzZSB9LCB0cmVlKSxcbiAgICAgIG5ldyBPYnNlcnZhYmxlPHZvaWQ+KG9icyA9PiB7XG4gICAgICAgIHByb2Nlc3MuY2hkaXIoZ2V0U3lzdGVtUGF0aChob3N0LnJvb3QpKTtcbiAgICAgICAgdGVzdFJ1bm5lci5sb2dnZXIuc3Vic2NyaWJlKHggPT4gbWVzc2FnZXMucHVzaCh4Lm1lc3NhZ2UpKTtcbiAgICAgICAgdGVzdFJ1bm5lci5lbmdpbmUuZXhlY3V0ZVBvc3RUYXNrcygpLnN1YnNjcmliZShvYnMpO1xuICAgICAgfSkucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiB7XG4gICAgICAgICAgZXJyb3IgPSB0cnVlO1xuXG4gICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9KSxcbiAgICAgICksXG4gICAgICBuZXcgT2JzZXJ2YWJsZTx2b2lkPihvYnMgPT4ge1xuICAgICAgICBleHBlY3QobWVzc2FnZXMuZmluZChtc2cgPT4gL1xcYmN1c3RvbS1ydWxlIGZhaWxcXGIvLnRlc3QobXNnKSkpLm5vdC50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIGV4cGVjdChlcnJvcikudG9CZSh0cnVlKTtcblxuICAgICAgICBvYnMuY29tcGxldGUoKTtcbiAgICAgIH0pLFxuICAgICkudG9Qcm9taXNlKCkudGhlbihkb25lLCBkb25lLmZhaWwpO1xuICB9KTtcblxufSk7XG4iXX0=