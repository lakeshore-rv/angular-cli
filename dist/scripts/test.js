"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const glob = require("glob");
const Istanbul = require("istanbul");
require("jasmine");
const jasmine_spec_reporter_1 = require("jasmine-spec-reporter");
const path_1 = require("path");
const ts = require("typescript");
const packages_1 = require("../lib/packages");
const codeMap = require('../lib/istanbul-local').codeMap;
const Jasmine = require('jasmine');
const projectBaseDir = path_1.join(__dirname, '..');
require('source-map-support').install({
    hookRequire: true,
});
// Add the Istanbul (not Constantinople) reporter.
const istanbulCollector = new Istanbul.Collector({});
const istanbulReporter = new Istanbul.Reporter(undefined, 'coverage/');
istanbulReporter.addAll(['json', 'lcov']);
class IstanbulReporter {
    // Update a location object from a SourceMap. Will ignore the location if the sourcemap does
    // not have a valid mapping.
    _updateLocation(consumer, location) {
        const start = consumer.originalPositionFor(location.start);
        const end = consumer.originalPositionFor(location.end);
        // Filter invalid original positions.
        if (start.line !== null && start.column !== null) {
            // Filter unwanted properties.
            location.start = { line: start.line, column: start.column };
        }
        if (end.line !== null && end.column !== null) {
            location.end = { line: end.line, column: end.column };
        }
    }
    _updateCoverageJsonSourceMap(coverageJson) {
        // Update the coverageJson with the SourceMap.
        for (const path of Object.keys(coverageJson)) {
            const entry = codeMap.get(path);
            if (!entry) {
                continue;
            }
            const consumer = entry.map;
            const coverage = coverageJson[path];
            // Update statement maps.
            for (const branchId of Object.keys(coverage.branchMap)) {
                const branch = coverage.branchMap[branchId];
                let line = null;
                let column = 0;
                do {
                    line = consumer.originalPositionFor({ line: branch.line, column: column++ }).line;
                } while (line === null && column < 100);
                branch.line = line;
                for (const location of branch.locations) {
                    this._updateLocation(consumer, location);
                }
            }
            for (const id of Object.keys(coverage.statementMap)) {
                const location = coverage.statementMap[id];
                this._updateLocation(consumer, location);
            }
            for (const id of Object.keys(coverage.fnMap)) {
                const fn = coverage.fnMap[id];
                fn.line = consumer.originalPositionFor({ line: fn.line, column: 0 }).line;
                this._updateLocation(consumer, fn.loc);
            }
        }
    }
    jasmineDone(_runDetails) {
        if (global.__coverage__) {
            this._updateCoverageJsonSourceMap(global.__coverage__);
            istanbulCollector.add(global.__coverage__);
            istanbulReporter.write(istanbulCollector, true, () => { });
        }
    }
}
// Create a Jasmine runner and configure it.
const runner = new Jasmine({ projectBaseDir: projectBaseDir });
if (process.argv.indexOf('--spec-reporter') != -1) {
    runner.env.clearReporters();
    runner.env.addReporter(new jasmine_spec_reporter_1.SpecReporter({
        stacktrace: {
            // Filter all JavaScript files that appear after a TypeScript file (callers) from the stack
            // trace.
            filter: (x) => {
                return x.substr(0, x.indexOf('\n', x.indexOf('\n', x.lastIndexOf('.ts:')) + 1));
            },
        },
        spec: {
            displayDuration: true,
        },
        suite: {
            displayNumber: true,
        },
        summary: {
            displayStacktrace: true,
            displayErrorMessages: true,
            displayDuration: true,
        },
    }));
}
// Manually set exit code (needed with custom reporters)
runner.onComplete((success) => {
    process.exitCode = success ? 0 : 1;
    if (process.platform.startsWith('win')) {
        // TODO(filipesilva): finish figuring out why this happens.
        // We should not need to force exit here, but when:
        // - on windows
        // - running webpack-dev-server
        // - with ngtools/webpack on the compilation
        // Something seems to hang and the process never exists.
        // This does not happen on linux, nor with webpack on watch mode.
        // Until this is figured out, we need to exit the process manually after tests finish
        // otherwise appveyor will hang until it timeouts.
        process.exit();
    }
});
glob.sync('packages/**/*.spec.ts')
    .filter(p => !/\/schematics\/.*\/(other-)?files\//.test(p))
    .forEach(path => {
    console.error(`Invalid spec file name: ${path}. You're using the old convention.`);
});
function default_1(args, logger) {
    const specGlob = args.large ? '*_spec_large.ts' : '*_spec.ts';
    const regex = args.glob ? args.glob : `packages/**/${specGlob}`;
    if (args['code-coverage']) {
        runner.env.addReporter(new IstanbulReporter());
    }
    if (args.large) {
        // Default timeout for large specs is 2.5 minutes.
        jasmine.DEFAULT_TIMEOUT_INTERVAL = 150000;
    }
    // Run the tests.
    const allTests = glob.sync(regex)
        .map(p => path_1.relative(projectBaseDir, p));
    const tsConfigPath = path_1.join(__dirname, '../tsconfig.json');
    const tsConfig = ts.readConfigFile(tsConfigPath, ts.sys.readFile);
    const pattern = '^('
        + tsConfig.config.exclude
            .map(ex => '('
            + ex.split(/[\/\\]/g).map(f => f
                .replace(/[\-\[\]{}()+?.^$|]/g, '\\$&')
                .replace(/^\*\*/g, '(.+?)?')
                .replace(/\*/g, '[^/\\\\]*'))
                .join('[\/\\\\]')
            + ')')
            .join('|')
        + ')($|/|\\\\)';
    const excludeRe = new RegExp(pattern);
    let tests = allTests.filter(x => !excludeRe.test(x));
    if (!args.full) {
        // Remove the tests from packages that haven't changed.
        tests = tests
            .filter(p => Object.keys(packages_1.packages).some(name => {
            const relativeRoot = path_1.relative(projectBaseDir, packages_1.packages[name].root);
            return p.startsWith(relativeRoot) && packages_1.packages[name].dirty;
        }));
        logger.info(`Found ${tests.length} spec files, out of ${allTests.length}.`);
    }
    if (args.shard !== undefined) {
        // Remove tests that are not part of this shard.
        const shardId = args['shard'];
        const nbShards = args['nb-shards'] || 2;
        tests = tests.filter((name, i) => (i % nbShards) == shardId);
    }
    return new Promise(resolve => {
        runner.onComplete((passed) => resolve(passed ? 0 : 1));
        runner.execute(tests);
    });
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5qcyIsInNvdXJjZVJvb3QiOiIvVXNlcnMvZXJuaWVkYXZpcy9Db2RlL2FuZ3VsYXItY2xpLyIsInNvdXJjZXMiOlsic2NyaXB0cy90ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBU0EsNkJBQTZCO0FBQzdCLHFDQUFxQztBQUNyQyxtQkFBaUI7QUFDakIsaUVBQTRFO0FBRTVFLCtCQUFzQztBQUV0QyxpQ0FBaUM7QUFDakMsOENBQTJDO0FBRTNDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUN6RCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFbkMsTUFBTSxjQUFjLEdBQUcsV0FBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM3QyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLENBQUM7SUFDcEMsV0FBVyxFQUFFLElBQUk7Q0FDbEIsQ0FBQyxDQUFDO0FBY0gsa0RBQWtEO0FBQ2xELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUN2RSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUcxQztJQUNFLDRGQUE0RjtJQUM1Riw0QkFBNEI7SUFDcEIsZUFBZSxDQUFDLFFBQTJCLEVBQUUsUUFBMEI7UUFDN0UsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzRCxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZELHFDQUFxQztRQUNyQyxJQUFJ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O0FBekRELDRCQXlEQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbi8vIHRzbGludDpkaXNhYmxlOm5vLWltcGxpY2l0LWRlcGVuZGVuY2llc1xuaW1wb3J0IHsgbG9nZ2luZyB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCAqIGFzIGdsb2IgZnJvbSAnZ2xvYic7XG5pbXBvcnQgKiBhcyBJc3RhbmJ1bCBmcm9tICdpc3RhbmJ1bCc7XG5pbXBvcnQgJ2phc21pbmUnO1xuaW1wb3J0IHsgU3BlY1JlcG9ydGVyIGFzIEphc21pbmVTcGVjUmVwb3J0ZXIgfSBmcm9tICdqYXNtaW5lLXNwZWMtcmVwb3J0ZXInO1xuaW1wb3J0IHsgUGFyc2VkQXJncyB9IGZyb20gJ21pbmltaXN0JztcbmltcG9ydCB7IGpvaW4sIHJlbGF0aXZlIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBQb3NpdGlvbiwgU291cmNlTWFwQ29uc3VtZXIgfSBmcm9tICdzb3VyY2UtbWFwJztcbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuaW1wb3J0IHsgcGFja2FnZXMgfSBmcm9tICcuLi9saWIvcGFja2FnZXMnO1xuXG5jb25zdCBjb2RlTWFwID0gcmVxdWlyZSgnLi4vbGliL2lzdGFuYnVsLWxvY2FsJykuY29kZU1hcDtcbmNvbnN0IEphc21pbmUgPSByZXF1aXJlKCdqYXNtaW5lJyk7XG5cbmNvbnN0IHByb2plY3RCYXNlRGlyID0gam9pbihfX2Rpcm5hbWUsICcuLicpO1xucmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0JykuaW5zdGFsbCh7XG4gIGhvb2tSZXF1aXJlOiB0cnVlLFxufSk7XG5cblxuaW50ZXJmYWNlIENvdmVyYWdlTG9jYXRpb24ge1xuICBzdGFydDogUG9zaXRpb247XG4gIGVuZDogUG9zaXRpb247XG59XG5cbnR5cGUgQ292ZXJhZ2VUeXBlID0gYW55OyAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1hbnlcbmRlY2xhcmUgY29uc3QgZ2xvYmFsOiB7XG4gIF9fY292ZXJhZ2VfXzogQ292ZXJhZ2VUeXBlO1xufTtcblxuXG4vLyBBZGQgdGhlIElzdGFuYnVsIChub3QgQ29uc3RhbnRpbm9wbGUpIHJlcG9ydGVyLlxuY29uc3QgaXN0YW5idWxDb2xsZWN0b3IgPSBuZXcgSXN0YW5idWwuQ29sbGVjdG9yKHt9KTtcbmNvbnN0IGlzdGFuYnVsUmVwb3J0ZXIgPSBuZXcgSXN0YW5idWwuUmVwb3J0ZXIodW5kZWZpbmVkLCAnY292ZXJhZ2UvJyk7XG5pc3RhbmJ1bFJlcG9ydGVyLmFkZEFsbChbJ2pzb24nLCAnbGNvdiddKTtcblxuXG5jbGFzcyBJc3RhbmJ1bFJlcG9ydGVyIGltcGxlbWVudHMgamFzbWluZS5DdXN0b21SZXBvcnRlciB7XG4gIC8vIFVwZGF0ZSBhIGxvY2F0aW9uIG9iamVjdCBmcm9tIGEgU291cmNlTWFwLiBXaWxsIGlnbm9yZSB0aGUgbG9jYXRpb24gaWYgdGhlIHNvdXJjZW1hcCBkb2VzXG4gIC8vIG5vdCBoYXZlIGEgdmFsaWQgbWFwcGluZy5cbiAgcHJpdmF0ZSBfdXBkYXRlTG9jYXRpb24oY29uc3VtZXI6IFNvdXJjZU1hcENvbnN1bWVyLCBsb2NhdGlvbjogQ292ZXJhZ2VMb2NhdGlvbikge1xuICAgIGNvbnN0IHN0YXJ0ID0gY29uc3VtZXIub3JpZ2luYWxQb3NpdGlvbkZvcihsb2NhdGlvbi5zdGFydCk7XG4gICAgY29uc3QgZW5kID0gY29uc3VtZXIub3JpZ2luYWxQb3NpdGlvbkZvcihsb2NhdGlvbi5lbmQpO1xuXG4gICAgLy8gRmlsdGVyIGludmFsaWQgb3JpZ2luYWwgcG9zaXRpb25zLlxuICAgIGlmIChzdGFydC5saW5lICE9PSBudWxsICYmIHN0YXJ0LmNvbHVtbiAhPT0gbnVsbCkge1xuICAgICAgLy8gRmlsdGVyIHVud2FudGVkIHByb3BlcnRpZXMuXG4gICAgICBsb2NhdGlvbi5zdGFydCA9IHsgbGluZTogc3RhcnQubGluZSwgY29sdW1uOiBzdGFydC5jb2x1bW4gfTtcbiAgICB9XG4gICAgaWYgKGVuZC5saW5lICE9PSBudWxsICYmIGVuZC5jb2x1bW4gIT09IG51bGwpIHtcbiAgICAgIGxvY2F0aW9uLmVuZCA9IHsgbGluZTogZW5kLmxpbmUsIGNvbHVtbjogZW5kLmNvbHVtbiB9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3VwZGF0ZUNvdmVyYWdlSnNvblNvdXJjZU1hcChjb3ZlcmFnZUpzb246IENvdmVyYWdlVHlwZSkge1xuICAgIC8vIFVwZGF0ZSB0aGUgY292ZXJhZ2VKc29uIHdpdGggdGhlIFNvdXJjZU1hcC5cbiAgICBmb3IgKGNvbnN0IHBhdGggb2YgT2JqZWN0LmtleXMoY292ZXJhZ2VKc29uKSkge1xuICAgICAgY29uc3QgZW50cnkgPSBjb2RlTWFwLmdldChwYXRoKTtcbiAgICAgIGlmICghZW50cnkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnN1bWVyID0gZW50cnkubWFwO1xuICAgICAgY29uc3QgY292ZXJhZ2UgPSBjb3ZlcmFnZUpzb25bcGF0aF07XG5cbiAgICAgIC8vIFVwZGF0ZSBzdGF0ZW1lbnQgbWFwcy5cbiAgICAgIGZvciAoY29uc3QgYnJhbmNoSWQgb2YgT2JqZWN0LmtleXMoY292ZXJhZ2UuYnJhbmNoTWFwKSkge1xuICAgICAgICBjb25zdCBicmFuY2ggPSBjb3ZlcmFnZS5icmFuY2hNYXBbYnJhbmNoSWRdO1xuICAgICAgICBsZXQgbGluZTogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gICAgICAgIGxldCBjb2x1bW4gPSAwO1xuICAgICAgICBkbyB7XG4gICAgICAgICAgbGluZSA9IGNvbnN1bWVyLm9yaWdpbmFsUG9zaXRpb25Gb3IoeyBsaW5lOiBicmFuY2gubGluZSwgY29sdW1uOiBjb2x1bW4rKyB9KS5saW5lO1xuICAgICAgICB9IHdoaWxlIChsaW5lID09PSBudWxsICYmIGNvbHVtbiA8IDEwMCk7XG5cbiAgICAgICAgYnJhbmNoLmxpbmUgPSBsaW5lO1xuXG4gICAgICAgIGZvciAoY29uc3QgbG9jYXRpb24gb2YgYnJhbmNoLmxvY2F0aW9ucykge1xuICAgICAgICAgIHRoaXMuX3VwZGF0ZUxvY2F0aW9uKGNvbnN1bWVyLCBsb2NhdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBpZCBvZiBPYmplY3Qua2V5cyhjb3ZlcmFnZS5zdGF0ZW1lbnRNYXApKSB7XG4gICAgICAgIGNvbnN0IGxvY2F0aW9uID0gY292ZXJhZ2Uuc3RhdGVtZW50TWFwW2lkXTtcbiAgICAgICAgdGhpcy5fdXBkYXRlTG9jYXRpb24oY29uc3VtZXIsIGxvY2F0aW9uKTtcbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBpZCBvZiBPYmplY3Qua2V5cyhjb3ZlcmFnZS5mbk1hcCkpIHtcbiAgICAgICAgY29uc3QgZm4gPSBjb3ZlcmFnZS5mbk1hcFtpZF07XG4gICAgICAgIGZuLmxpbmUgPSBjb25zdW1lci5vcmlnaW5hbFBvc2l0aW9uRm9yKHsgbGluZTogZm4ubGluZSwgY29sdW1uOiAwIH0pLmxpbmU7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUxvY2F0aW9uKGNvbnN1bWVyLCBmbi5sb2MpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGphc21pbmVEb25lKF9ydW5EZXRhaWxzOiBqYXNtaW5lLlJ1bkRldGFpbHMpOiB2b2lkIHtcbiAgICBpZiAoZ2xvYmFsLl9fY292ZXJhZ2VfXykge1xuICAgICAgdGhpcy5fdXBkYXRlQ292ZXJhZ2VKc29uU291cmNlTWFwKGdsb2JhbC5fX2NvdmVyYWdlX18pO1xuICAgICAgaXN0YW5idWxDb2xsZWN0b3IuYWRkKGdsb2JhbC5fX2NvdmVyYWdlX18pO1xuXG4gICAgICBpc3RhbmJ1bFJlcG9ydGVyLndyaXRlKGlzdGFuYnVsQ29sbGVjdG9yLCB0cnVlLCAoKSA9PiB7fSk7XG4gICAgfVxuICB9XG59XG5cblxuLy8gQ3JlYXRlIGEgSmFzbWluZSBydW5uZXIgYW5kIGNvbmZpZ3VyZSBpdC5cbmNvbnN0IHJ1bm5lciA9IG5ldyBKYXNtaW5lKHsgcHJvamVjdEJhc2VEaXI6IHByb2plY3RCYXNlRGlyIH0pO1xuXG5pZiAocHJvY2Vzcy5hcmd2LmluZGV4T2YoJy0tc3BlYy1yZXBvcnRlcicpICE9IC0xKSB7XG4gIHJ1bm5lci5lbnYuY2xlYXJSZXBvcnRlcnMoKTtcbiAgcnVubmVyLmVudi5hZGRSZXBvcnRlcihuZXcgSmFzbWluZVNwZWNSZXBvcnRlcih7XG4gICAgc3RhY2t0cmFjZToge1xuICAgICAgLy8gRmlsdGVyIGFsbCBKYXZhU2NyaXB0IGZpbGVzIHRoYXQgYXBwZWFyIGFmdGVyIGEgVHlwZVNjcmlwdCBmaWxlIChjYWxsZXJzKSBmcm9tIHRoZSBzdGFja1xuICAgICAgLy8gdHJhY2UuXG4gICAgICBmaWx0ZXI6ICh4OiBzdHJpbmcpID0+IHtcbiAgICAgICAgcmV0dXJuIHguc3Vic3RyKDAsIHguaW5kZXhPZignXFxuJywgeC5pbmRleE9mKCdcXG4nLCB4Lmxhc3RJbmRleE9mKCcudHM6JykpICsgMSkpO1xuICAgICAgfSxcbiAgICB9LFxuICAgIHNwZWM6IHtcbiAgICAgIGRpc3BsYXlEdXJhdGlvbjogdHJ1ZSxcbiAgICB9LFxuICAgIHN1aXRlOiB7XG4gICAgICBkaXNwbGF5TnVtYmVyOiB0cnVlLFxuICAgIH0sXG4gICAgc3VtbWFyeToge1xuICAgICAgZGlzcGxheVN0YWNrdHJhY2U6IHRydWUsXG4gICAgICBkaXNwbGF5RXJyb3JNZXNzYWdlczogdHJ1ZSxcbiAgICAgIGRpc3BsYXlEdXJhdGlvbjogdHJ1ZSxcbiAgICB9LFxuICB9KSk7XG59XG5cblxuLy8gTWFudWFsbHkgc2V0IGV4aXQgY29kZSAobmVlZGVkIHdpdGggY3VzdG9tIHJlcG9ydGVycylcbnJ1bm5lci5vbkNvbXBsZXRlKChzdWNjZXNzOiBib29sZWFuKSA9PiB7XG4gIHByb2Nlc3MuZXhpdENvZGUgPSBzdWNjZXNzID8gMCA6IDE7XG4gIGlmIChwcm9jZXNzLnBsYXRmb3JtLnN0YXJ0c1dpdGgoJ3dpbicpKSB7XG4gICAgLy8gVE9ETyhmaWxpcGVzaWx2YSk6IGZpbmlzaCBmaWd1cmluZyBvdXQgd2h5IHRoaXMgaGFwcGVucy5cbiAgICAvLyBXZSBzaG91bGQgbm90IG5lZWQgdG8gZm9yY2UgZXhpdCBoZXJlLCBidXQgd2hlbjpcbiAgICAvLyAtIG9uIHdpbmRvd3NcbiAgICAvLyAtIHJ1bm5pbmcgd2VicGFjay1kZXYtc2VydmVyXG4gICAgLy8gLSB3aXRoIG5ndG9vbHMvd2VicGFjayBvbiB0aGUgY29tcGlsYXRpb25cbiAgICAvLyBTb21ldGhpbmcgc2VlbXMgdG8gaGFuZyBhbmQgdGhlIHByb2Nlc3MgbmV2ZXIgZXhpc3RzLlxuICAgIC8vIFRoaXMgZG9lcyBub3QgaGFwcGVuIG9uIGxpbnV4LCBub3Igd2l0aCB3ZWJwYWNrIG9uIHdhdGNoIG1vZGUuXG4gICAgLy8gVW50aWwgdGhpcyBpcyBmaWd1cmVkIG91dCwgd2UgbmVlZCB0byBleGl0IHRoZSBwcm9jZXNzIG1hbnVhbGx5IGFmdGVyIHRlc3RzIGZpbmlzaFxuICAgIC8vIG90aGVyd2lzZSBhcHB2ZXlvciB3aWxsIGhhbmcgdW50aWwgaXQgdGltZW91dHMuXG4gICAgcHJvY2Vzcy5leGl0KCk7XG4gIH1cbn0pO1xuXG5cbmdsb2Iuc3luYygncGFja2FnZXMvKiovKi5zcGVjLnRzJylcbiAgLmZpbHRlcihwID0+ICEvXFwvc2NoZW1hdGljc1xcLy4qXFwvKG90aGVyLSk/ZmlsZXNcXC8vLnRlc3QocCkpXG4gIC5mb3JFYWNoKHBhdGggPT4ge1xuICAgIGNvbnNvbGUuZXJyb3IoYEludmFsaWQgc3BlYyBmaWxlIG5hbWU6ICR7cGF0aH0uIFlvdSdyZSB1c2luZyB0aGUgb2xkIGNvbnZlbnRpb24uYCk7XG4gIH0pO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoYXJnczogUGFyc2VkQXJncywgbG9nZ2VyOiBsb2dnaW5nLkxvZ2dlcikge1xuICBjb25zdCBzcGVjR2xvYiA9IGFyZ3MubGFyZ2UgPyAnKl9zcGVjX2xhcmdlLnRzJyA6ICcqX3NwZWMudHMnO1xuICBjb25zdCByZWdleCA9IGFyZ3MuZ2xvYiA/IGFyZ3MuZ2xvYiA6IGBwYWNrYWdlcy8qKi8ke3NwZWNHbG9ifWA7XG5cbiAgaWYgKGFyZ3NbJ2NvZGUtY292ZXJhZ2UnXSkge1xuICAgIHJ1bm5lci5lbnYuYWRkUmVwb3J0ZXIobmV3IElzdGFuYnVsUmVwb3J0ZXIoKSk7XG4gIH1cblxuICBpZiAoYXJncy5sYXJnZSkge1xuICAgIC8vIERlZmF1bHQgdGltZW91dCBmb3IgbGFyZ2Ugc3BlY3MgaXMgMi41IG1pbnV0ZXMuXG4gICAgamFzbWluZS5ERUZBVUxUX1RJTUVPVVRfSU5URVJWQUwgPSAxNTAwMDA7XG4gIH1cblxuICAvLyBSdW4gdGhlIHRlc3RzLlxuICBjb25zdCBhbGxUZXN0cyA9XG4gICAgZ2xvYi5zeW5jKHJlZ2V4KVxuICAgICAgLm1hcChwID0+IHJlbGF0aXZlKHByb2plY3RCYXNlRGlyLCBwKSk7XG5cbiAgY29uc3QgdHNDb25maWdQYXRoID0gam9pbihfX2Rpcm5hbWUsICcuLi90c2NvbmZpZy5qc29uJyk7XG4gIGNvbnN0IHRzQ29uZmlnID0gdHMucmVhZENvbmZpZ0ZpbGUodHNDb25maWdQYXRoLCB0cy5zeXMucmVhZEZpbGUpO1xuICBjb25zdCBwYXR0ZXJuID0gJ14oJ1xuICAgICAgICAgICAgICAgICAgKyAodHNDb25maWcuY29uZmlnLmV4Y2x1ZGUgYXMgc3RyaW5nW10pXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoZXggPT4gJygnXG4gICAgICAgICAgICAgICAgICAgICAgKyBleC5zcGxpdCgvW1xcL1xcXFxdL2cpLm1hcChmID0+IGZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcXC1cXFtcXF17fSgpKz8uXiR8XS9nLCAnXFxcXCQmJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL15cXCpcXCovZywgJyguKz8pPycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCovZywgJ1teL1xcXFxcXFxcXSonKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5qb2luKCdbXFwvXFxcXFxcXFxdJylcbiAgICAgICAgICAgICAgICAgICAgICArICcpJylcbiAgICAgICAgICAgICAgICAgICAgLmpvaW4oJ3wnKVxuICAgICAgICAgICAgICAgICAgKyAnKSgkfC98XFxcXFxcXFwpJztcbiAgY29uc3QgZXhjbHVkZVJlID0gbmV3IFJlZ0V4cChwYXR0ZXJuKTtcbiAgbGV0IHRlc3RzID0gYWxsVGVzdHMuZmlsdGVyKHggPT4gIWV4Y2x1ZGVSZS50ZXN0KHgpKTtcblxuICBpZiAoIWFyZ3MuZnVsbCkge1xuICAgIC8vIFJlbW92ZSB0aGUgdGVzdHMgZnJvbSBwYWNrYWdlcyB0aGF0IGhhdmVuJ3QgY2hhbmdlZC5cbiAgICB0ZXN0cyA9IHRlc3RzXG4gICAgICAuZmlsdGVyKHAgPT4gT2JqZWN0LmtleXMocGFja2FnZXMpLnNvbWUobmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IHJlbGF0aXZlUm9vdCA9IHJlbGF0aXZlKHByb2plY3RCYXNlRGlyLCBwYWNrYWdlc1tuYW1lXS5yb290KTtcblxuICAgICAgICByZXR1cm4gcC5zdGFydHNXaXRoKHJlbGF0aXZlUm9vdCkgJiYgcGFja2FnZXNbbmFtZV0uZGlydHk7XG4gICAgICB9KSk7XG5cbiAgICBsb2dnZXIuaW5mbyhgRm91bmQgJHt0ZXN0cy5sZW5ndGh9IHNwZWMgZmlsZXMsIG91dCBvZiAke2FsbFRlc3RzLmxlbmd0aH0uYCk7XG4gIH1cblxuICBpZiAoYXJncy5zaGFyZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgLy8gUmVtb3ZlIHRlc3RzIHRoYXQgYXJlIG5vdCBwYXJ0IG9mIHRoaXMgc2hhcmQuXG4gICAgY29uc3Qgc2hhcmRJZCA9IGFyZ3NbJ3NoYXJkJ107XG4gICAgY29uc3QgbmJTaGFyZHMgPSBhcmdzWyduYi1zaGFyZHMnXSB8fCAyO1xuICAgIHRlc3RzID0gdGVzdHMuZmlsdGVyKChuYW1lLCBpKSA9PiAoaSAlIG5iU2hhcmRzKSA9PSBzaGFyZElkKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBydW5uZXIub25Db21wbGV0ZSgocGFzc2VkOiBib29sZWFuKSA9PiByZXNvbHZlKHBhc3NlZCA/IDAgOiAxKSk7XG4gICAgcnVubmVyLmV4ZWN1dGUodGVzdHMpO1xuICB9KTtcbn1cbiJdfQ==