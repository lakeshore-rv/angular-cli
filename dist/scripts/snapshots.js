"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const fs = require("fs");
const os = require("os");
const path = require("path");
const packages_1 = require("../lib/packages");
const build_1 = require("./build");
function _copy(from, to) {
    fs.readdirSync(from)
        .forEach(name => {
        const fromPath = path.join(from, name);
        const toPath = path.join(to, name);
        if (fs.statSync(fromPath).isDirectory()) {
            if (!fs.existsSync(toPath)) {
                fs.mkdirSync(toPath);
            }
            _copy(fromPath, toPath);
        }
        else {
            fs.writeFileSync(toPath, fs.readFileSync(fromPath));
        }
    });
}
function _exec(command, args, opts, logger) {
    const { status, error, stderr } = child_process_1.spawnSync(command, args, Object.assign({}, opts));
    if (status != 0) {
        logger.error(`Command failed: ${command} ${args.map(x => JSON.stringify(x)).join(', ')}`);
        if (error) {
            logger.error('Error: ' + (error ? error.message : 'undefined'));
        }
        else {
            logger.error(`STDERR:\n${stderr}`);
        }
        throw error;
    }
}
function default_1(opts, logger) {
    // Get the SHA.
    if (child_process_1.execSync(`git status --porcelain`).toString() && !opts.force) {
        logger.error('You cannot run snapshots with local changes.');
        process.exit(1);
    }
    const root = fs.mkdtempSync(path.join(os.tmpdir(), 'angular-cli-publish-'));
    const message = child_process_1.execSync(`git log --format="%h %s" -n1`).toString().trim();
    const githubToken = (opts.githubToken
        || (opts.githubTokenFile && fs.readFileSync(opts.githubTokenFile, 'utf-8'))
        || '').trim();
    logger.info('Setting up global git name.');
    if (githubToken) {
        _exec('git', ['config', '--global', 'user.email', 'circleci@angular.io'], {}, logger);
        _exec('git', ['config', '--global', 'user.name', 'Angular Builds'], {}, logger);
        _exec('git', ['config', '--global', 'push.default', 'simple'], {}, logger);
    }
    // Run build.
    logger.info('Building...');
    build_1.default({ snapshot: true }, logger.createChild('build'));
    for (const packageName of Object.keys(packages_1.packages)) {
        const pkg = packages_1.packages[packageName];
        if (!pkg.snapshot) {
            logger.warn(`Skipping ${pkg.name}.`);
            continue;
        }
        logger.info(`Publishing ${pkg.name} to repo ${JSON.stringify(pkg.snapshotRepo)}.`);
        const publishLogger = logger.createChild('publish');
        publishLogger.debug('Temporary directory: ' + root);
        const url = `https://${githubToken ? githubToken + '@' : ''}github.com/${pkg.snapshotRepo}.git`;
        _exec('git', ['clone', url], { cwd: root }, publishLogger);
        const destPath = path.join(root, path.basename(pkg.snapshotRepo));
        // Clear snapshot directory before publishing to remove deleted build files.
        try {
            _exec('git', ['rm', '-rf', './'], { cwd: destPath }, publishLogger);
        }
        catch (_a) {
            // Ignore errors on delete. :shrug:
        }
        _copy(pkg.dist, destPath);
        if (githubToken) {
            _exec('git', ['config', 'commit.gpgSign', 'false'], { cwd: destPath }, publishLogger);
        }
        // Make sure that every snapshots is unique.
        fs.writeFileSync(path.join(destPath, 'uniqueId'), '' + new Date());
        // Commit and push.
        _exec('git', ['add', '.'], { cwd: destPath }, publishLogger);
        _exec('git', ['commit', '-a', '-m', message], { cwd: destPath }, publishLogger);
        _exec('git', ['tag', pkg.snapshotHash], { cwd: destPath }, publishLogger);
        _exec('git', ['push', 'origin'], { cwd: destPath }, publishLogger);
        _exec('git', ['push', '--tags', 'origin'], { cwd: destPath }, publishLogger);
    }
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hcHNob3RzLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9lcm5pZWRhdmlzL0NvZGUvYW5ndWxhci1jbGkvIiwic291cmNlcyI6WyJzY3JpcHRzL3NuYXBzaG90cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVNBLGlEQUFvRDtBQUNwRCx5QkFBeUI7QUFDekIseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUM3Qiw4Q0FBMkM7QUFDM0MsbUNBQTRCO0FBRzVCLGVBQWUsSUFBWSxFQUFFLEVBQVU7SUFDckMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7U0FDakIsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkMsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUMxQixFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3RCO1lBQ0QsS0FBSyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUN6QjthQUFNO1lBQ0wsRUFBRSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBR0QsZUFBZSxPQUFlLEVBQUUsSUFBYyxFQUFFLElBQXNCLEVBQUUsTUFBc0I7SUFDNUYsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcseUJBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxvQkFBTyxJQUFJLEVBQUcsQ0FBQztJQUV4RSxJQUFJLE1BQU0sSUFBSSxDQUFDLEVBQUU7UUFDZixNQUFNLENBQUMsS0FBSyxDQUFDLG1CQUFtQixPQUFPLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFGLElBQUksS0FBSyxFQUFFO1lBQ1QsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7U0FDakU7YUFBTTtZQUNMLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1NBQ3BDO1FBQ0QsTUFBTSxLQUFLLENBQUM7S0FDYjtBQUNILENBQUM7QUFTRCxtQkFBd0IsSUFBc0IsRUFBRSxNQUFzQjtJQUNwRSxlQUFlO0lBQ2YsSUFBSSx3QkFBUSxDQUFDLHdCQUF3QixDQUFDLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ2hFLE1BQU0sQ0FBQyxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQztRQUM3RCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2pCO0lBRUQsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7SUFDNUUsTUFBTSxPQUFPLEdBQUcsd0JBQVEsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBRTNFLE1BQU0sV0FBVyxHQUFHLENBQ2xCLElBQUksQ0FBQyxXQUFXO1dBQ2IsQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQztXQUN4RSxFQUFFLENBQ04sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVULE1BQU0sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQztJQUMzQyxJQUFJLFdBQVcsRUFBRTtRQUNmLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxxQkFBcUIsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN0RixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLENBQUMsRUFBRSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDaEYsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztLQUM1RTtJQUVELGFBQWE7SUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzNCLGVBQUssQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFFdkQsS0FBSyxNQUFNLFdBQVcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFRLENBQUMsRUFBRTtRQUMvQyxNQUFNLEdBQUcsR0FBRyxtQkFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFO1lBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNyQyxTQUFTO1NBQ1Y7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLElBQUksWUFBWSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbkYsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNwRCxhQUFhLENBQUMsS0FBSyxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxDQUFDO1FBRXBELE1BQU0sR0FBRyxHQUFHLFdBQVcsV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLGNBQWMsR0FBRyxDQUFDLFlBQVksTUFBTSxDQUFDO1FBQ2hHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFFM0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNsRSw0RUFBNEU7UUFDNUUsSUFBSTtZQUNGLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ25FO1FBQUMsV0FBTTtZQUNOLG1DQUFtQztTQUNwQztRQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTFCLElBQUksV0FBVyxFQUFFO1lBQ2YsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLFFBQVEsRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsRUFBRSxhQUFhLENBQUMsQ0FBQztTQUN2RjtRQUVELDRDQUE0QztRQUM1QyxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7UUFFbkUsbUJBQW1CO1FBQ25CLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDN0QsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ2hGLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbkUsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUUsYUFBYSxDQUFDLENBQUM7S0FDOUU7QUFDSCxDQUFDO0FBbEVELDRCQWtFQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbi8vIHRzbGludDpkaXNhYmxlOm5vLWltcGxpY2l0LWRlcGVuZGVuY2llc1xuaW1wb3J0IHsgbG9nZ2luZyB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCB7IGV4ZWNTeW5jLCBzcGF3blN5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBwYWNrYWdlcyB9IGZyb20gJy4uL2xpYi9wYWNrYWdlcyc7XG5pbXBvcnQgYnVpbGQgZnJvbSAnLi9idWlsZCc7XG5cblxuZnVuY3Rpb24gX2NvcHkoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nKSB7XG4gIGZzLnJlYWRkaXJTeW5jKGZyb20pXG4gICAgLmZvckVhY2gobmFtZSA9PiB7XG4gICAgICBjb25zdCBmcm9tUGF0aCA9IHBhdGguam9pbihmcm9tLCBuYW1lKTtcbiAgICAgIGNvbnN0IHRvUGF0aCA9IHBhdGguam9pbih0bywgbmFtZSk7XG4gICAgICBpZiAoZnMuc3RhdFN5bmMoZnJvbVBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRvUGF0aCkpIHtcbiAgICAgICAgICBmcy5ta2RpclN5bmModG9QYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBfY29weShmcm9tUGF0aCwgdG9QYXRoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmModG9QYXRoLCBmcy5yZWFkRmlsZVN5bmMoZnJvbVBhdGgpKTtcbiAgICAgIH1cbiAgICB9KTtcbn1cblxuXG5mdW5jdGlvbiBfZXhlYyhjb21tYW5kOiBzdHJpbmcsIGFyZ3M6IHN0cmluZ1tdLCBvcHRzOiB7IGN3ZD86IHN0cmluZyB9LCBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyKSB7XG4gIGNvbnN0IHsgc3RhdHVzLCBlcnJvciwgc3RkZXJyIH0gPSBzcGF3blN5bmMoY29tbWFuZCwgYXJncywgeyAuLi5vcHRzIH0pO1xuXG4gIGlmIChzdGF0dXMgIT0gMCkge1xuICAgIGxvZ2dlci5lcnJvcihgQ29tbWFuZCBmYWlsZWQ6ICR7Y29tbWFuZH0gJHthcmdzLm1hcCh4ID0+IEpTT04uc3RyaW5naWZ5KHgpKS5qb2luKCcsICcpfWApO1xuICAgIGlmIChlcnJvcikge1xuICAgICAgbG9nZ2VyLmVycm9yKCdFcnJvcjogJyArIChlcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAndW5kZWZpbmVkJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYFNUREVSUjpcXG4ke3N0ZGVycn1gKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIFNuYXBzaG90c09wdGlvbnMge1xuICBmb3JjZT86IGJvb2xlYW47XG4gIGdpdGh1YlRva2VuRmlsZT86IHN0cmluZztcbiAgZ2l0aHViVG9rZW4/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKG9wdHM6IFNuYXBzaG90c09wdGlvbnMsIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXIpIHtcbiAgLy8gR2V0IHRoZSBTSEEuXG4gIGlmIChleGVjU3luYyhgZ2l0IHN0YXR1cyAtLXBvcmNlbGFpbmApLnRvU3RyaW5nKCkgJiYgIW9wdHMuZm9yY2UpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ1lvdSBjYW5ub3QgcnVuIHNuYXBzaG90cyB3aXRoIGxvY2FsIGNoYW5nZXMuJyk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG5cbiAgY29uc3Qgcm9vdCA9IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2FuZ3VsYXItY2xpLXB1Ymxpc2gtJykpO1xuICBjb25zdCBtZXNzYWdlID0gZXhlY1N5bmMoYGdpdCBsb2cgLS1mb3JtYXQ9XCIlaCAlc1wiIC1uMWApLnRvU3RyaW5nKCkudHJpbSgpO1xuXG4gIGNvbnN0IGdpdGh1YlRva2VuID0gKFxuICAgIG9wdHMuZ2l0aHViVG9rZW5cbiAgICB8fCAob3B0cy5naXRodWJUb2tlbkZpbGUgJiYgZnMucmVhZEZpbGVTeW5jKG9wdHMuZ2l0aHViVG9rZW5GaWxlLCAndXRmLTgnKSlcbiAgICB8fCAnJ1xuICApLnRyaW0oKTtcblxuICBsb2dnZXIuaW5mbygnU2V0dGluZyB1cCBnbG9iYWwgZ2l0IG5hbWUuJyk7XG4gIGlmIChnaXRodWJUb2tlbikge1xuICAgIF9leGVjKCdnaXQnLCBbJ2NvbmZpZycsICctLWdsb2JhbCcsICd1c2VyLmVtYWlsJywgJ2NpcmNsZWNpQGFuZ3VsYXIuaW8nXSwge30sIGxvZ2dlcik7XG4gICAgX2V4ZWMoJ2dpdCcsIFsnY29uZmlnJywgJy0tZ2xvYmFsJywgJ3VzZXIubmFtZScsICdBbmd1bGFyIEJ1aWxkcyddLCB7fSwgbG9nZ2VyKTtcbiAgICBfZXhlYygnZ2l0JywgWydjb25maWcnLCAnLS1nbG9iYWwnLCAncHVzaC5kZWZhdWx0JywgJ3NpbXBsZSddLCB7fSwgbG9nZ2VyKTtcbiAgfVxuXG4gIC8vIFJ1biBidWlsZC5cbiAgbG9nZ2VyLmluZm8oJ0J1aWxkaW5nLi4uJyk7XG4gIGJ1aWxkKHsgc25hcHNob3Q6IHRydWUgfSwgbG9nZ2VyLmNyZWF0ZUNoaWxkKCdidWlsZCcpKTtcblxuICBmb3IgKGNvbnN0IHBhY2thZ2VOYW1lIG9mIE9iamVjdC5rZXlzKHBhY2thZ2VzKSkge1xuICAgIGNvbnN0IHBrZyA9IHBhY2thZ2VzW3BhY2thZ2VOYW1lXTtcblxuICAgIGlmICghcGtnLnNuYXBzaG90KSB7XG4gICAgICBsb2dnZXIud2FybihgU2tpcHBpbmcgJHtwa2cubmFtZX0uYCk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhgUHVibGlzaGluZyAke3BrZy5uYW1lfSB0byByZXBvICR7SlNPTi5zdHJpbmdpZnkocGtnLnNuYXBzaG90UmVwbyl9LmApO1xuXG4gICAgY29uc3QgcHVibGlzaExvZ2dlciA9IGxvZ2dlci5jcmVhdGVDaGlsZCgncHVibGlzaCcpO1xuICAgIHB1Ymxpc2hMb2dnZXIuZGVidWcoJ1RlbXBvcmFyeSBkaXJlY3Rvcnk6ICcgKyByb290KTtcblxuICAgIGNvbnN0IHVybCA9IGBodHRwczovLyR7Z2l0aHViVG9rZW4gPyBnaXRodWJUb2tlbiArICdAJyA6ICcnfWdpdGh1Yi5jb20vJHtwa2cuc25hcHNob3RSZXBvfS5naXRgO1xuICAgIF9leGVjKCdnaXQnLCBbJ2Nsb25lJywgdXJsXSwgeyBjd2Q6IHJvb3QgfSwgcHVibGlzaExvZ2dlcik7XG5cbiAgICBjb25zdCBkZXN0UGF0aCA9IHBhdGguam9pbihyb290LCBwYXRoLmJhc2VuYW1lKHBrZy5zbmFwc2hvdFJlcG8pKTtcbiAgICAvLyBDbGVhciBzbmFwc2hvdCBkaXJlY3RvcnkgYmVmb3JlIHB1Ymxpc2hpbmcgdG8gcmVtb3ZlIGRlbGV0ZWQgYnVpbGQgZmlsZXMuXG4gICAgdHJ5IHtcbiAgICAgIF9leGVjKCdnaXQnLCBbJ3JtJywgJy1yZicsICcuLyddLCB7Y3dkOiBkZXN0UGF0aH0sIHB1Ymxpc2hMb2dnZXIpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgLy8gSWdub3JlIGVycm9ycyBvbiBkZWxldGUuIDpzaHJ1ZzpcbiAgICB9XG4gICAgX2NvcHkocGtnLmRpc3QsIGRlc3RQYXRoKTtcblxuICAgIGlmIChnaXRodWJUb2tlbikge1xuICAgICAgX2V4ZWMoJ2dpdCcsIFsnY29uZmlnJywgJ2NvbW1pdC5ncGdTaWduJywgJ2ZhbHNlJ10sIHsgY3dkOiBkZXN0UGF0aCB9LCBwdWJsaXNoTG9nZ2VyKTtcbiAgICB9XG5cbiAgICAvLyBNYWtlIHN1cmUgdGhhdCBldmVyeSBzbmFwc2hvdHMgaXMgdW5pcXVlLlxuICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aC5qb2luKGRlc3RQYXRoLCAndW5pcXVlSWQnKSwgJycgKyBuZXcgRGF0ZSgpKTtcblxuICAgIC8vIENvbW1pdCBhbmQgcHVzaC5cbiAgICBfZXhlYygnZ2l0JywgWydhZGQnLCAnLiddLCB7IGN3ZDogZGVzdFBhdGggfSwgcHVibGlzaExvZ2dlcik7XG4gICAgX2V4ZWMoJ2dpdCcsIFsnY29tbWl0JywgJy1hJywgJy1tJywgbWVzc2FnZV0sIHsgY3dkOiBkZXN0UGF0aCB9LCBwdWJsaXNoTG9nZ2VyKTtcbiAgICBfZXhlYygnZ2l0JywgWyd0YWcnLCBwa2cuc25hcHNob3RIYXNoXSwgeyBjd2Q6IGRlc3RQYXRoIH0sIHB1Ymxpc2hMb2dnZXIpO1xuICAgIF9leGVjKCdnaXQnLCBbJ3B1c2gnLCAnb3JpZ2luJ10sIHsgY3dkOiBkZXN0UGF0aCB9LCBwdWJsaXNoTG9nZ2VyKTtcbiAgICBfZXhlYygnZ2l0JywgWydwdXNoJywgJy0tdGFncycsICdvcmlnaW4nXSwgeyBjd2Q6IGRlc3RQYXRoIH0sIHB1Ymxpc2hMb2dnZXIpO1xuICB9XG59XG4iXX0=