"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const glob = require("glob");
const path = require("path");
const ts = require("typescript");
const packages_1 = require("../lib/packages");
const minimatch = require('minimatch');
const tar = require('tar');
const gitIgnore = fs.readFileSync(path.join(__dirname, '../.gitignore'), 'utf-8')
    .split('\n')
    .map(line => line.replace(/#.*/, ''))
    .filter(line => !line.match(/^\s*$/));
function _gitIgnoreMatch(p) {
    p = path.relative(path.dirname(__dirname), p);
    return gitIgnore.some(line => minimatch(p, line));
}
function _mkdirp(p) {
    // Create parent folder if necessary.
    if (!fs.existsSync(path.dirname(p))) {
        _mkdirp(path.dirname(p));
    }
    fs.mkdirSync(p);
}
function _tar(out, dir) {
    return tar.create({
        gzip: true,
        strict: true,
        portable: true,
        cwd: dir,
        file: out,
        sync: true,
    }, ['.']);
}
function _copy(from, to) {
    // Create parent folder if necessary.
    if (!fs.existsSync(path.dirname(to))) {
        _mkdirp(path.dirname(to));
    }
    from = path.relative(process.cwd(), from);
    to = path.relative(process.cwd(), to);
    const buffer = fs.readFileSync(from);
    fs.writeFileSync(to, buffer);
}
function _recursiveCopy(from, to, logger) {
    if (!fs.existsSync(from)) {
        logger.error(`File "${from}" does not exist.`);
        process.exit(4);
    }
    if (fs.statSync(from).isDirectory()) {
        fs.readdirSync(from).forEach(fileName => {
            _recursiveCopy(path.join(from, fileName), path.join(to, fileName), logger);
        });
    }
    else {
        _copy(from, to);
    }
}
function _rm(p) {
    p = path.relative(process.cwd(), p);
    fs.unlinkSync(p);
}
function _rimraf(p) {
    glob.sync(path.join(p, '**/*'), { dot: true, nodir: true })
        .forEach(p => fs.unlinkSync(p));
    glob.sync(path.join(p, '**/*'), { dot: true })
        .sort((a, b) => b.length - a.length)
        .forEach(p => fs.rmdirSync(p));
}
function _clean(logger) {
    logger.info('Cleaning...');
    logger.info('  Removing dist/...');
    _rimraf(path.join(__dirname, '../dist'));
}
function _sortPackages() {
    // Order packages in order of dependency.
    // We use bubble sort because we need a full topological sort but adding another dependency
    // or implementing a full topo sort would be too much work and I'm lazy. We don't anticipate
    // any large number of
    const sortedPackages = Object.keys(packages_1.packages);
    let swapped = false;
    do {
        swapped = false;
        for (let i = 0; i < sortedPackages.length - 1; i++) {
            for (let j = i + 1; j < sortedPackages.length; j++) {
                const a = sortedPackages[i];
                const b = sortedPackages[j];
                if (packages_1.packages[a].dependencies.indexOf(b) != -1) {
                    // Swap them.
                    [sortedPackages[i], sortedPackages[i + 1]]
                        = [sortedPackages[i + 1], sortedPackages[i]];
                    swapped = true;
                }
            }
        }
    } while (swapped);
    return sortedPackages;
}
function _build(logger) {
    logger.info('Building...');
    const tsConfigPath = path.relative(process.cwd(), path.join(__dirname, '../tsconfig.json'));
    // Load the Compiler Options.
    const tsConfig = ts.readConfigFile(tsConfigPath, ts.sys.readFile);
    const parsedTsConfig = ts.parseJsonConfigFileContent(tsConfig.config, ts.sys, '.');
    // Create the program and emit.
    const program = ts.createProgram(parsedTsConfig.fileNames, parsedTsConfig.options);
    const result = program.emit();
    if (result.emitSkipped) {
        logger.error(`TypeScript compiler failed:`);
        const diagLogger = logger.createChild('diagnostics');
        result.diagnostics.forEach(diagnostic => {
            const messageText = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
            if (diagnostic.file) {
                const position = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start || 0);
                const fileName = diagnostic.file.fileName;
                const { line, character } = position;
                diagLogger.error(`${fileName} (${line + 1},${character + 1}): ${messageText}`);
            }
            else {
                diagLogger.error(messageText);
            }
        });
        process.exit(1);
    }
}
function default_1(argv, logger) {
    _clean(logger);
    const sortedPackages = _sortPackages();
    _build(logger);
    logger.info('Moving packages to dist/');
    const packageLogger = logger.createChild('packages');
    for (const packageName of sortedPackages) {
        packageLogger.info(packageName);
        const pkg = packages_1.packages[packageName];
        _recursiveCopy(pkg.build, pkg.dist, logger);
        _rimraf(pkg.build);
    }
    logger.info('Copying resources...');
    const resourceLogger = logger.createChild('resources');
    for (const packageName of sortedPackages) {
        resourceLogger.info(packageName);
        const pkg = packages_1.packages[packageName];
        const pkgJson = pkg.packageJson;
        const files = glob.sync(path.join(pkg.root, '**/*'), { dot: true, nodir: true });
        const subSubLogger = resourceLogger.createChild(packageName);
        subSubLogger.info(`${files.length} files total...`);
        const resources = files
            .map((fileName) => path.relative(pkg.root, fileName))
            .filter(fileName => {
            // Schematics template files.
            if (pkgJson['schematics'] &&
                (fileName.match(/(\/|\\)files(\/|\\)/) || fileName.match(/(\/|\\)\w+-files(\/|\\)/))) {
                return true;
            }
            if (fileName.endsWith('package.json')) {
                return true;
            }
            // Remove Bazel files from NPM.
            if (fileName.endsWith('BUILD')) {
                return false;
            }
            // Skip sources.
            if (fileName.endsWith('.ts') && !fileName.endsWith('.d.ts')) {
                // Verify that it was actually built.
                if (!fs.existsSync(path.join(pkg.dist, fileName).replace(/ts$/, 'js'))) {
                    subSubLogger.error(`\nSource found but compiled file not found: "${fileName}".`);
                    process.exit(2);
                }
                // Skip all sources.
                return false;
            }
            // Skip tsconfig only.
            if (fileName.endsWith('tsconfig.json')) {
                return false;
            }
            // Skip files from gitignore.
            if (_gitIgnoreMatch(fileName)) {
                return false;
            }
            return true;
        });
        subSubLogger.info(`${resources.length} resources...`);
        resources.forEach(fileName => {
            _copy(path.join(pkg.root, fileName), path.join(pkg.dist, fileName));
        });
    }
    logger.info('Copying extra resources...');
    for (const packageName of sortedPackages) {
        const pkg = packages_1.packages[packageName];
        _copy(path.join(__dirname, '../LICENSE'), path.join(pkg.dist, 'LICENSE'));
    }
    logger.info('Removing spec files...');
    const specLogger = logger.createChild('specfiles');
    for (const packageName of sortedPackages) {
        specLogger.info(packageName);
        const pkg = packages_1.packages[packageName];
        const files = glob.sync(path.join(pkg.dist, '**/*_spec?(_large).@(js|d.ts)'));
        specLogger.info(`  ${files.length} spec files found...`);
        files.forEach(fileName => _rm(fileName));
    }
    logger.info('Building ejs templates...');
    const templateLogger = logger.createChild('templates');
    const templateCompiler = require('@angular-devkit/core').template;
    for (const packageName of sortedPackages) {
        templateLogger.info(packageName);
        const pkg = packages_1.packages[packageName];
        const files = glob.sync(path.join(pkg.dist, '**/*.ejs'));
        templateLogger.info(`  ${files.length} ejs files found...`);
        files.forEach(fileName => {
            const p = path.relative(path.dirname(__dirname), path.join(pkg.root, path.relative(pkg.dist, fileName)));
            const fn = templateCompiler(fs.readFileSync(fileName).toString(), {
                module: true,
                sourceURL: p,
                sourceMap: true,
                sourceRoot: path.join(__dirname, '..'),
                fileName: fileName.replace(/\.ejs$/, '.js'),
            });
            _rm(fileName);
            fs.writeFileSync(fileName.replace(/\.ejs$/, '.js'), fn.source);
        });
    }
    logger.info('Setting versions...');
    const versionLogger = logger.createChild('versions');
    for (const packageName of sortedPackages) {
        versionLogger.info(packageName);
        const pkg = packages_1.packages[packageName];
        const packageJsonPath = path.join(pkg.dist, 'package.json');
        const packageJson = pkg.packageJson;
        const version = pkg.version;
        if (version) {
            packageJson['version'] = version;
        }
        else {
            versionLogger.error('No version found... Only updating dependencies.');
        }
        for (const depName of Object.keys(packages_1.packages)) {
            const v = packages_1.packages[depName].version;
            for (const depKey of ['dependencies', 'peerDependencies', 'devDependencies']) {
                const obj = packageJson[depKey];
                if (obj && obj[depName]) {
                    if (argv.local) {
                        obj[depName] = packages_1.packages[depName].tar;
                    }
                    else if (argv.snapshot) {
                        const pkg = packages_1.packages[depName];
                        if (!pkg.snapshotRepo) {
                            versionLogger.error(`Package ${JSON.stringify(depName)} is not published as a snapshot. `
                                + `Fixing to current version ${v}.`);
                            obj[depName] = v;
                        }
                        else {
                            obj[depName] = `github:${pkg.snapshotRepo}#${pkg.snapshotHash}`;
                        }
                    }
                    else if (obj[depName].match(/\b0\.0\.0\b/)) {
                        obj[depName] = obj[depName].replace(/\b0\.0\.0\b/, v);
                    }
                }
            }
        }
        fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2) + '\n');
    }
    logger.info('Tarring all packages...');
    const tarLogger = logger.createChild('license');
    Object.keys(packages_1.packages).forEach(pkgName => {
        const pkg = packages_1.packages[pkgName];
        tarLogger.info(`${pkgName} => ${pkg.tar}`);
        _tar(pkg.tar, pkg.dist);
    });
    logger.info(`Done.`);
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGQuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL2VybmllZGF2aXMvQ29kZS9hbmd1bGFyLWNsaS8iLCJzb3VyY2VzIjpbInNjcmlwdHMvYnVpbGQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFTQSx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLDZCQUE2QjtBQUM3QixpQ0FBaUM7QUFDakMsOENBQTJDO0FBRTNDLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN2QyxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFFM0IsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsRUFBRSxPQUFPLENBQUM7S0FDOUUsS0FBSyxDQUFDLElBQUksQ0FBQztLQUNYLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBR3hDLHlCQUF5QixDQUFTO0lBQ2hDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFOUMsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ3BELENBQUM7QUFHRCxpQkFBaUIsQ0FBUztJQUN4QixxQ0FBcUM7SUFDckMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ25DLE9BQU8s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QUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ3RDLE1BQU0sR0FBRyxHQUFHLG1CQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUIsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sT0FBTyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUF2S0QsNEJBdUtDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuLy8gdHNsaW50OmRpc2FibGU6bm8taW1wbGljaXQtZGVwZW5kZW5jaWVzXG5pbXBvcnQgeyBKc29uT2JqZWN0LCBsb2dnaW5nIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcbmltcG9ydCB7IHBhY2thZ2VzIH0gZnJvbSAnLi4vbGliL3BhY2thZ2VzJztcblxuY29uc3QgbWluaW1hdGNoID0gcmVxdWlyZSgnbWluaW1hdGNoJyk7XG5jb25zdCB0YXIgPSByZXF1aXJlKCd0YXInKTtcblxuY29uc3QgZ2l0SWdub3JlID0gZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uZ2l0aWdub3JlJyksICd1dGYtOCcpXG4gIC5zcGxpdCgnXFxuJylcbiAgLm1hcChsaW5lID0+IGxpbmUucmVwbGFjZSgvIy4qLywgJycpKVxuICAuZmlsdGVyKGxpbmUgPT4gIWxpbmUubWF0Y2goL15cXHMqJC8pKTtcblxuXG5mdW5jdGlvbiBfZ2l0SWdub3JlTWF0Y2gocDogc3RyaW5nKSB7XG4gIHAgPSBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShfX2Rpcm5hbWUpLCBwKTtcblxuICByZXR1cm4gZ2l0SWdub3JlLnNvbWUobGluZSA9PiBtaW5pbWF0Y2gocCwgbGluZSkpO1xufVxuXG5cbmZ1bmN0aW9uIF9ta2RpcnAocDogc3RyaW5nKSB7XG4gIC8vIENyZWF0ZSBwYXJlbnQgZm9sZGVyIGlmIG5lY2Vzc2FyeS5cbiAgaWYgKCFmcy5leGlzdHNTeW5jKHBhdGguZGlybmFtZShwKSkpIHtcbiAgICBfbWtkaXJwKHBhdGguZGlybmFtZShwKSk7XG4gIH1cbiAgZnMubWtkaXJTeW5jKHApO1xufVxuXG5cbmZ1bmN0aW9uIF90YXIob3V0OiBzdHJpbmcsIGRpcjogc3RyaW5nKSB7XG4gIHJldHVybiB0YXIuY3JlYXRlKHtcbiAgICBnemlwOiB0cnVlLFxuICAgIHN0cmljdDogdHJ1ZSxcbiAgICBwb3J0YWJsZTogdHJ1ZSxcbiAgICBjd2Q6IGRpcixcbiAgICBmaWxlOiBvdXQsXG4gICAgc3luYzogdHJ1ZSxcbiAgfSwgWycuJ10pO1xufVxuXG5cbmZ1bmN0aW9uIF9jb3B5KGZyb206IHN0cmluZywgdG86IHN0cmluZykge1xuICAvLyBDcmVhdGUgcGFyZW50IGZvbGRlciBpZiBuZWNlc3NhcnkuXG4gIGlmICghZnMuZXhpc3RzU3luYyhwYXRoLmRpcm5hbWUodG8pKSkge1xuICAgIF9ta2RpcnAocGF0aC5kaXJuYW1lKHRvKSk7XG4gIH1cblxuICBmcm9tID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBmcm9tKTtcbiAgdG8gPSBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIHRvKTtcblxuICBjb25zdCBidWZmZXIgPSBmcy5yZWFkRmlsZVN5bmMoZnJvbSk7XG4gIGZzLndyaXRlRmlsZVN5bmModG8sIGJ1ZmZlcik7XG59XG5cblxuZnVuY3Rpb24gX3JlY3Vyc2l2ZUNvcHkoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyKSB7XG4gIGlmICghZnMuZXhpc3RzU3luYyhmcm9tKSkge1xuICAgIGxvZ2dlci5lcnJvcihgRmlsZSBcIiR7ZnJvbX1cIiBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICBwcm9jZXNzLmV4aXQoNCk7XG4gIH1cbiAgaWYgKGZzLnN0YXRTeW5jKGZyb20pLmlzRGlyZWN0b3J5KCkpIHtcbiAgICBmcy5yZWFkZGlyU3luYyhmcm9tKS5mb3JFYWNoKGZpbGVOYW1lID0+IHtcbiAgICAgIF9yZWN1cnNpdmVDb3B5KHBhdGguam9pbihmcm9tLCBmaWxlTmFtZSksIHBhdGguam9pbih0bywgZmlsZU5hbWUpLCBsb2dnZXIpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIF9jb3B5KGZyb20sIHRvKTtcbiAgfVxufVxuXG5cbmZ1bmN0aW9uIF9ybShwOiBzdHJpbmcpIHtcbiAgcCA9IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgcCk7XG4gIGZzLnVubGlua1N5bmMocCk7XG59XG5cblxuZnVuY3Rpb24gX3JpbXJhZihwOiBzdHJpbmcpIHtcbiAgZ2xvYi5zeW5jKHBhdGguam9pbihwLCAnKiovKicpLCB7IGRvdDogdHJ1ZSwgbm9kaXI6IHRydWUgfSlcbiAgICAuZm9yRWFjaChwID0+IGZzLnVubGlua1N5bmMocCkpO1xuICBnbG9iLnN5bmMocGF0aC5qb2luKHAsICcqKi8qJyksIHsgZG90OiB0cnVlIH0pXG4gICAgLnNvcnQoKGEsIGIpID0+IGIubGVuZ3RoIC0gYS5sZW5ndGgpXG4gICAgLmZvckVhY2gocCA9PiBmcy5ybWRpclN5bmMocCkpO1xufVxuXG5cbmZ1bmN0aW9uIF9jbGVhbihsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyKSB7XG4gIGxvZ2dlci5pbmZvKCdDbGVhbmluZy4uLicpO1xuICBsb2dnZXIuaW5mbygnICBSZW1vdmluZyBkaXN0Ly4uLicpO1xuICBfcmltcmFmKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9kaXN0JykpO1xufVxuXG5cbmZ1bmN0aW9uIF9zb3J0UGFja2FnZXMoKSB7XG4gIC8vIE9yZGVyIHBhY2thZ2VzIGluIG9yZGVyIG9mIGRlcGVuZGVuY3kuXG4gIC8vIFdlIHVzZSBidWJibGUgc29ydCBiZWNhdXNlIHdlIG5lZWQgYSBmdWxsIHRvcG9sb2dpY2FsIHNvcnQgYnV0IGFkZGluZyBhbm90aGVyIGRlcGVuZGVuY3lcbiAgLy8gb3IgaW1wbGVtZW50aW5nIGEgZnVsbCB0b3BvIHNvcnQgd291bGQgYmUgdG9vIG11Y2ggd29yayBhbmQgSSdtIGxhenkuIFdlIGRvbid0IGFudGljaXBhdGVcbiAgLy8gYW55IGxhcmdlIG51bWJlciBvZlxuICBjb25zdCBzb3J0ZWRQYWNrYWdlcyA9IE9iamVjdC5rZXlzKHBhY2thZ2VzKTtcbiAgbGV0IHN3YXBwZWQgPSBmYWxzZTtcbiAgZG8ge1xuICAgIHN3YXBwZWQgPSBmYWxzZTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRlZFBhY2thZ2VzLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwgc29ydGVkUGFja2FnZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgY29uc3QgYSA9IHNvcnRlZFBhY2thZ2VzW2ldO1xuICAgICAgICBjb25zdCBiID0gc29ydGVkUGFja2FnZXNbal07XG5cbiAgICAgICAgaWYgKHBhY2thZ2VzW2FdLmRlcGVuZGVuY2llcy5pbmRleE9mKGIpICE9IC0xKSB7XG4gICAgICAgICAgLy8gU3dhcCB0aGVtLlxuICAgICAgICAgIFtzb3J0ZWRQYWNrYWdlc1tpXSwgc29ydGVkUGFja2FnZXNbaSArIDFdXVxuICAgICAgICAgICAgPSBbc29ydGVkUGFja2FnZXNbaSArIDFdLCBzb3J0ZWRQYWNrYWdlc1tpXV07XG4gICAgICAgICAgc3dhcHBlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0gd2hpbGUgKHN3YXBwZWQpO1xuXG4gIHJldHVybiBzb3J0ZWRQYWNrYWdlcztcbn1cblxuXG5mdW5jdGlvbiBfYnVpbGQobG9nZ2VyOiBsb2dnaW5nLkxvZ2dlcikge1xuICBsb2dnZXIuaW5mbygnQnVpbGRpbmcuLi4nKTtcbiAgY29uc3QgdHNDb25maWdQYXRoID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vdHNjb25maWcuanNvbicpKTtcbiAgLy8gTG9hZCB0aGUgQ29tcGlsZXIgT3B0aW9ucy5cbiAgY29uc3QgdHNDb25maWcgPSB0cy5yZWFkQ29uZmlnRmlsZSh0c0NvbmZpZ1BhdGgsIHRzLnN5cy5yZWFkRmlsZSk7XG4gIGNvbnN0IHBhcnNlZFRzQ29uZmlnID0gdHMucGFyc2VKc29uQ29uZmlnRmlsZUNvbnRlbnQodHNDb25maWcuY29uZmlnLCB0cy5zeXMsICcuJyk7XG5cbiAgLy8gQ3JlYXRlIHRoZSBwcm9ncmFtIGFuZCBlbWl0LlxuICBjb25zdCBwcm9ncmFtID0gdHMuY3JlYXRlUHJvZ3JhbShwYXJzZWRUc0NvbmZpZy5maWxlTmFtZXMsIHBhcnNlZFRzQ29uZmlnLm9wdGlvbnMpO1xuICBjb25zdCByZXN1bHQgPSBwcm9ncmFtLmVtaXQoKTtcbiAgaWYgKHJlc3VsdC5lbWl0U2tpcHBlZCkge1xuICAgIGxvZ2dlci5lcnJvcihgVHlwZVNjcmlwdCBjb21waWxlciBmYWlsZWQ6YCk7XG4gICAgY29uc3QgZGlhZ0xvZ2dlciA9IGxvZ2dlci5jcmVhdGVDaGlsZCgnZGlhZ25vc3RpY3MnKTtcbiAgICByZXN1bHQuZGlhZ25vc3RpY3MuZm9yRWFjaChkaWFnbm9zdGljID0+IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2VUZXh0ID0gdHMuZmxhdHRlbkRpYWdub3N0aWNNZXNzYWdlVGV4dChkaWFnbm9zdGljLm1lc3NhZ2VUZXh0LCAnXFxuJyk7XG5cbiAgICAgIGlmIChkaWFnbm9zdGljLmZpbGUpIHtcbiAgICAgICAgY29uc3QgcG9zaXRpb24gPSBkaWFnbm9zdGljLmZpbGUuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24oZGlhZ25vc3RpYy5zdGFydCB8fCAwKTtcbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBkaWFnbm9zdGljLmZpbGUuZmlsZU5hbWU7XG4gICAgICAgIGNvbnN0IHsgbGluZSwgY2hhcmFjdGVyIH0gPSBwb3NpdGlvbjtcbiAgICAgICAgZGlhZ0xvZ2dlci5lcnJvcihgJHtmaWxlTmFtZX0gKCR7bGluZSArIDF9LCR7Y2hhcmFjdGVyICsgMX0pOiAke21lc3NhZ2VUZXh0fWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGlhZ0xvZ2dlci5lcnJvcihtZXNzYWdlVGV4dCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcHJvY2Vzcy5leGl0KDEpO1xuICB9XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24oYXJndjogeyBsb2NhbD86IGJvb2xlYW4sIHNuYXBzaG90PzogYm9vbGVhbiB9LCBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyKSB7XG4gIF9jbGVhbihsb2dnZXIpO1xuXG4gIGNvbnN0IHNvcnRlZFBhY2thZ2VzID0gX3NvcnRQYWNrYWdlcygpO1xuICBfYnVpbGQobG9nZ2VyKTtcblxuICBsb2dnZXIuaW5mbygnTW92aW5nIHBhY2thZ2VzIHRvIGRpc3QvJyk7XG4gIGNvbnN0IHBhY2thZ2VMb2dnZXIgPSBsb2dnZXIuY3JlYXRlQ2hpbGQoJ3BhY2thZ2VzJyk7XG4gIGZvciAoY29uc3QgcGFja2FnZU5hbWUgb2Ygc29ydGVkUGFja2FnZXMpIHtcbiAgICBwYWNrYWdlTG9nZ2VyLmluZm8ocGFja2FnZU5hbWUpO1xuICAgIGNvbnN0IHBrZyA9IHBhY2thZ2VzW3BhY2thZ2VOYW1lXTtcbiAgICBfcmVjdXJzaXZlQ29weShwa2cuYnVpbGQsIHBrZy5kaXN0LCBsb2dnZXIpO1xuICAgIF9yaW1yYWYocGtnLmJ1aWxkKTtcbiAgfVxuXG4gIGxvZ2dlci5pbmZvKCdDb3B5aW5nIHJlc291cmNlcy4uLicpO1xuICBjb25zdCByZXNvdXJjZUxvZ2dlciA9IGxvZ2dlci5jcmVhdGVDaGlsZCgncmVzb3VyY2VzJyk7XG4gIGZvciAoY29uc3QgcGFja2FnZU5hbWUgb2Ygc29ydGVkUGFja2FnZXMpIHtcbiAgICByZXNvdXJjZUxvZ2dlci5pbmZvKHBhY2thZ2VOYW1lKTtcbiAgICBjb25zdCBwa2cgPSBwYWNrYWdlc1twYWNrYWdlTmFtZV07XG4gICAgY29uc3QgcGtnSnNvbiA9IHBrZy5wYWNrYWdlSnNvbjtcbiAgICBjb25zdCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLmpvaW4ocGtnLnJvb3QsICcqKi8qJyksIHsgZG90OiB0cnVlLCBub2RpcjogdHJ1ZSB9KTtcbiAgICBjb25zdCBzdWJTdWJMb2dnZXIgPSByZXNvdXJjZUxvZ2dlci5jcmVhdGVDaGlsZChwYWNrYWdlTmFtZSk7XG4gICAgc3ViU3ViTG9nZ2VyLmluZm8oYCR7ZmlsZXMubGVuZ3RofSBmaWxlcyB0b3RhbC4uLmApO1xuICAgIGNvbnN0IHJlc291cmNlcyA9IGZpbGVzXG4gICAgICAubWFwKChmaWxlTmFtZSkgPT4gcGF0aC5yZWxhdGl2ZShwa2cucm9vdCwgZmlsZU5hbWUpKVxuICAgICAgLmZpbHRlcihmaWxlTmFtZSA9PiB7XG4gICAgICAgIC8vIFNjaGVtYXRpY3MgdGVtcGxhdGUgZmlsZXMuXG4gICAgICAgIGlmIChwa2dKc29uWydzY2hlbWF0aWNzJ10gJiZcbiAgICAgICAgIChmaWxlTmFtZS5tYXRjaCgvKFxcL3xcXFxcKWZpbGVzKFxcL3xcXFxcKS8pIHx8IGZpbGVOYW1lLm1hdGNoKC8oXFwvfFxcXFwpXFx3Ky1maWxlcyhcXC98XFxcXCkvKSkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChmaWxlTmFtZS5lbmRzV2l0aCgncGFja2FnZS5qc29uJykpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlbW92ZSBCYXplbCBmaWxlcyBmcm9tIE5QTS5cbiAgICAgICAgaWYgKGZpbGVOYW1lLmVuZHNXaXRoKCdCVUlMRCcpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2tpcCBzb3VyY2VzLlxuICAgICAgICBpZiAoZmlsZU5hbWUuZW5kc1dpdGgoJy50cycpICYmICFmaWxlTmFtZS5lbmRzV2l0aCgnLmQudHMnKSkge1xuICAgICAgICAgIC8vIFZlcmlmeSB0aGF0IGl0IHdhcyBhY3R1YWxseSBidWlsdC5cbiAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMocGF0aC5qb2luKHBrZy5kaXN0LCBmaWxlTmFtZSkucmVwbGFjZSgvdHMkLywgJ2pzJykpKSB7XG4gICAgICAgICAgICBzdWJTdWJMb2dnZXIuZXJyb3IoYFxcblNvdXJjZSBmb3VuZCBidXQgY29tcGlsZWQgZmlsZSBub3QgZm91bmQ6IFwiJHtmaWxlTmFtZX1cIi5gKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgyKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBTa2lwIGFsbCBzb3VyY2VzLlxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNraXAgdHNjb25maWcgb25seS5cbiAgICAgICAgaWYgKGZpbGVOYW1lLmVuZHNXaXRoKCd0c2NvbmZpZy5qc29uJykpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTa2lwIGZpbGVzIGZyb20gZ2l0aWdub3JlLlxuICAgICAgICBpZiAoX2dpdElnbm9yZU1hdGNoKGZpbGVOYW1lKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSk7XG5cbiAgICBzdWJTdWJMb2dnZXIuaW5mbyhgJHtyZXNvdXJjZXMubGVuZ3RofSByZXNvdXJjZXMuLi5gKTtcbiAgICByZXNvdXJjZXMuZm9yRWFjaChmaWxlTmFtZSA9PiB7XG4gICAgICBfY29weShwYXRoLmpvaW4ocGtnLnJvb3QsIGZpbGVOYW1lKSwgcGF0aC5qb2luKHBrZy5kaXN0LCBmaWxlTmFtZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgbG9nZ2VyLmluZm8oJ0NvcHlpbmcgZXh0cmEgcmVzb3VyY2VzLi4uJyk7XG4gIGZvciAoY29uc3QgcGFja2FnZU5hbWUgb2Ygc29ydGVkUGFja2FnZXMpIHtcbiAgICBjb25zdCBwa2cgPSBwYWNrYWdlc1twYWNrYWdlTmFtZV07XG4gICAgX2NvcHkocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL0xJQ0VOU0UnKSwgcGF0aC5qb2luKHBrZy5kaXN0LCAnTElDRU5TRScpKTtcbiAgfVxuXG4gIGxvZ2dlci5pbmZvKCdSZW1vdmluZyBzcGVjIGZpbGVzLi4uJyk7XG4gIGNvbnN0IHNwZWNMb2dnZXIgPSBsb2dnZXIuY3JlYXRlQ2hpbGQoJ3NwZWNmaWxlcycpO1xuICBmb3IgKGNvbnN0IHBhY2thZ2VOYW1lIG9mIHNvcnRlZFBhY2thZ2VzKSB7XG4gICAgc3BlY0xvZ2dlci5pbmZvKHBhY2thZ2VOYW1lKTtcbiAgICBjb25zdCBwa2cgPSBwYWNrYWdlc1twYWNrYWdlTmFtZV07XG4gICAgY29uc3QgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5qb2luKHBrZy5kaXN0LCAnKiovKl9zcGVjPyhfbGFyZ2UpLkAoanN8ZC50cyknKSk7XG4gICAgc3BlY0xvZ2dlci5pbmZvKGAgICR7ZmlsZXMubGVuZ3RofSBzcGVjIGZpbGVzIGZvdW5kLi4uYCk7XG4gICAgZmlsZXMuZm9yRWFjaChmaWxlTmFtZSA9PiBfcm0oZmlsZU5hbWUpKTtcbiAgfVxuXG4gIGxvZ2dlci5pbmZvKCdCdWlsZGluZyBlanMgdGVtcGxhdGVzLi4uJyk7XG4gIGNvbnN0IHRlbXBsYXRlTG9nZ2VyID0gbG9nZ2VyLmNyZWF0ZUNoaWxkKCd0ZW1wbGF0ZXMnKTtcbiAgY29uc3QgdGVtcGxhdGVDb21waWxlciA9IHJlcXVpcmUoJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJykudGVtcGxhdGU7XG4gIGZvciAoY29uc3QgcGFja2FnZU5hbWUgb2Ygc29ydGVkUGFja2FnZXMpIHtcbiAgICB0ZW1wbGF0ZUxvZ2dlci5pbmZvKHBhY2thZ2VOYW1lKTtcbiAgICBjb25zdCBwa2cgPSBwYWNrYWdlc1twYWNrYWdlTmFtZV07XG4gICAgY29uc3QgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5qb2luKHBrZy5kaXN0LCAnKiovKi5lanMnKSk7XG4gICAgdGVtcGxhdGVMb2dnZXIuaW5mbyhgICAke2ZpbGVzLmxlbmd0aH0gZWpzIGZpbGVzIGZvdW5kLi4uYCk7XG4gICAgZmlsZXMuZm9yRWFjaChmaWxlTmFtZSA9PiB7XG4gICAgICBjb25zdCBwID0gcGF0aC5yZWxhdGl2ZShcbiAgICAgICAgcGF0aC5kaXJuYW1lKF9fZGlybmFtZSksXG4gICAgICAgIHBhdGguam9pbihwa2cucm9vdCwgcGF0aC5yZWxhdGl2ZShwa2cuZGlzdCwgZmlsZU5hbWUpKSxcbiAgICAgICk7XG4gICAgICBjb25zdCBmbiA9IHRlbXBsYXRlQ29tcGlsZXIoZnMucmVhZEZpbGVTeW5jKGZpbGVOYW1lKS50b1N0cmluZygpLCB7XG4gICAgICAgIG1vZHVsZTogdHJ1ZSxcbiAgICAgICAgc291cmNlVVJMOiBwLFxuICAgICAgICBzb3VyY2VNYXA6IHRydWUsXG4gICAgICAgIHNvdXJjZVJvb3Q6IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicpLFxuICAgICAgICBmaWxlTmFtZTogZmlsZU5hbWUucmVwbGFjZSgvXFwuZWpzJC8sICcuanMnKSxcbiAgICAgIH0pO1xuICAgICAgX3JtKGZpbGVOYW1lKTtcbiAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZU5hbWUucmVwbGFjZSgvXFwuZWpzJC8sICcuanMnKSwgZm4uc291cmNlKTtcbiAgICB9KTtcbiAgfVxuXG4gIGxvZ2dlci5pbmZvKCdTZXR0aW5nIHZlcnNpb25zLi4uJyk7XG5cbiAgY29uc3QgdmVyc2lvbkxvZ2dlciA9IGxvZ2dlci5jcmVhdGVDaGlsZCgndmVyc2lvbnMnKTtcbiAgZm9yIChjb25zdCBwYWNrYWdlTmFtZSBvZiBzb3J0ZWRQYWNrYWdlcykge1xuICAgIHZlcnNpb25Mb2dnZXIuaW5mbyhwYWNrYWdlTmFtZSk7XG4gICAgY29uc3QgcGtnID0gcGFja2FnZXNbcGFja2FnZU5hbWVdO1xuICAgIGNvbnN0IHBhY2thZ2VKc29uUGF0aCA9IHBhdGguam9pbihwa2cuZGlzdCwgJ3BhY2thZ2UuanNvbicpO1xuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gcGtnLnBhY2thZ2VKc29uO1xuICAgIGNvbnN0IHZlcnNpb24gPSBwa2cudmVyc2lvbjtcblxuICAgIGlmICh2ZXJzaW9uKSB7XG4gICAgICBwYWNrYWdlSnNvblsndmVyc2lvbiddID0gdmVyc2lvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgdmVyc2lvbkxvZ2dlci5lcnJvcignTm8gdmVyc2lvbiBmb3VuZC4uLiBPbmx5IHVwZGF0aW5nIGRlcGVuZGVuY2llcy4nKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGRlcE5hbWUgb2YgT2JqZWN0LmtleXMocGFja2FnZXMpKSB7XG4gICAgICBjb25zdCB2ID0gcGFja2FnZXNbZGVwTmFtZV0udmVyc2lvbjtcbiAgICAgIGZvciAoY29uc3QgZGVwS2V5IG9mIFsnZGVwZW5kZW5jaWVzJywgJ3BlZXJEZXBlbmRlbmNpZXMnLCAnZGV2RGVwZW5kZW5jaWVzJ10pIHtcbiAgICAgICAgY29uc3Qgb2JqID0gcGFja2FnZUpzb25bZGVwS2V5XSBhcyBKc29uT2JqZWN0IHwgbnVsbDtcbiAgICAgICAgaWYgKG9iaiAmJiBvYmpbZGVwTmFtZV0pIHtcbiAgICAgICAgICBpZiAoYXJndi5sb2NhbCkge1xuICAgICAgICAgICAgb2JqW2RlcE5hbWVdID0gcGFja2FnZXNbZGVwTmFtZV0udGFyO1xuICAgICAgICAgIH0gZWxzZSBpZiAoYXJndi5zbmFwc2hvdCkge1xuICAgICAgICAgICAgY29uc3QgcGtnID0gcGFja2FnZXNbZGVwTmFtZV07XG4gICAgICAgICAgICBpZiAoIXBrZy5zbmFwc2hvdFJlcG8pIHtcbiAgICAgICAgICAgICAgdmVyc2lvbkxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgICAgICBgUGFja2FnZSAke0pTT04uc3RyaW5naWZ5KGRlcE5hbWUpfSBpcyBub3QgcHVibGlzaGVkIGFzIGEgc25hcHNob3QuIGBcbiAgICAgICAgICAgICAgICArIGBGaXhpbmcgdG8gY3VycmVudCB2ZXJzaW9uICR7dn0uYCxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgb2JqW2RlcE5hbWVdID0gdjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIG9ialtkZXBOYW1lXSA9IGBnaXRodWI6JHtwa2cuc25hcHNob3RSZXBvfSMke3BrZy5zbmFwc2hvdEhhc2h9YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKChvYmpbZGVwTmFtZV0gYXMgc3RyaW5nKS5tYXRjaCgvXFxiMFxcLjBcXC4wXFxiLykpIHtcbiAgICAgICAgICAgIG9ialtkZXBOYW1lXSA9IChvYmpbZGVwTmFtZV0gYXMgc3RyaW5nKS5yZXBsYWNlKC9cXGIwXFwuMFxcLjBcXGIvLCB2KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBmcy53cml0ZUZpbGVTeW5jKHBhY2thZ2VKc29uUGF0aCwgSlNPTi5zdHJpbmdpZnkocGFja2FnZUpzb24sIG51bGwsIDIpICsgJ1xcbicpO1xuICB9XG5cbiAgbG9nZ2VyLmluZm8oJ1RhcnJpbmcgYWxsIHBhY2thZ2VzLi4uJyk7XG4gIGNvbnN0IHRhckxvZ2dlciA9IGxvZ2dlci5jcmVhdGVDaGlsZCgnbGljZW5zZScpO1xuICBPYmplY3Qua2V5cyhwYWNrYWdlcykuZm9yRWFjaChwa2dOYW1lID0+IHtcbiAgICBjb25zdCBwa2cgPSBwYWNrYWdlc1twa2dOYW1lXTtcbiAgICB0YXJMb2dnZXIuaW5mbyhgJHtwa2dOYW1lfSA9PiAke3BrZy50YXJ9YCk7XG4gICAgX3Rhcihwa2cudGFyLCBwa2cuZGlzdCk7XG4gIH0pO1xuXG4gIGxvZ2dlci5pbmZvKGBEb25lLmApO1xufVxuIl19