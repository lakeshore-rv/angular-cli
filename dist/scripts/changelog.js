"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const semver = require("semver");
const packages_1 = require("../lib/packages");
const changelogTemplate = require('./templates/changelog').default;
const conventionalCommitsParser = require('conventional-commits-parser');
const gitRawCommits = require('git-raw-commits');
const ghGot = require('gh-got');
const through = require('through2');
function default_1(args, logger) {
    const commits = [];
    let toSha = null;
    const githubToken = (args.githubToken
        || (args.githubTokenFile && fs.readFileSync(args.githubTokenFile, 'utf-8'))
        || '').trim();
    return new Promise((resolve) => {
        gitRawCommits({
            from: args.from,
            to: args.to || 'HEAD',
            format: '%B%n-hash-%n%H%n-gitTags-%n%D%n-committerDate-%n%ci%n-authorName-%n%aN%n',
        })
            .on('error', err => {
            logger.fatal('An error happened: ' + err.message);
            process.exit(1);
        })
            .pipe(through((chunk, enc, callback) => {
            // Replace github URLs with `@XYZ#123`
            const commit = chunk.toString('utf-8')
                .replace(/https?:\/\/github.com\/(.*?)\/issues\/(\d+)/g, '@$1#$2');
            callback(undefined, new Buffer(commit));
        }))
            .pipe(conventionalCommitsParser({
            headerPattern: /^(\w*)(?:\(([^)]*)\))?: (.*)$/,
            headerCorrespondence: ['type', 'scope', 'subject'],
            noteKeywords: ['BREAKING CHANGE'],
            revertPattern: /^revert:\s([\s\S]*?)\s*This reverts commit (\w*)\./,
            revertCorrespondence: [`header`, `hash`],
        }))
            .pipe(through.obj((chunk, _, cb) => {
            try {
                const maybeTag = chunk.gitTags && chunk.gitTags.match(/tag: (.*)/);
                const tags = maybeTag && maybeTag[1].split(/,/g);
                chunk['tags'] = tags;
                if (tags && tags.find(x => x == args.to)) {
                    toSha = chunk.hash;
                }
                commits.push(chunk);
                cb();
            }
            catch (err) {
                cb(err);
            }
        }))
            .on('finish', resolve);
    })
        .then(() => {
        const markdown = changelogTemplate(Object.assign({}, args, { include: (x, v) => require('./' + path.join('templates', x)).default(v), commits,
            packages: packages_1.packages }));
        if (args.stdout || !githubToken) {
            console.log(markdown);
            process.exit(0);
        }
        // Check if we need to edit or create a new one.
        return ghGot('repos/angular/angular-cli/releases').then((x) => [x, markdown]);
    })
        .then(([body, markdown]) => {
        const json = body.body;
        const maybeRelease = json.find((x) => x.tag_name == args.to);
        const id = maybeRelease ? `/${maybeRelease.id}` : '';
        const semversion = (args.to && semver.parse(args.to)) || { prerelease: '' };
        return ghGot('repos/angular/angular-cli/releases' + id, {
            body: Object.assign({ body: markdown, draft: !maybeRelease, name: args.to, prerelease: semversion.prerelease.length > 0, tag_name: args.to }, (toSha ? { target_commitish: toSha } : {})),
            token: githubToken,
        });
    });
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlbG9nLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9lcm5pZWRhdmlzL0NvZGUvYW5ndWxhci1jbGkvIiwic291cmNlcyI6WyJzY3JpcHRzL2NoYW5nZWxvZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQVNBLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0IsaUNBQWlDO0FBQ2pDLDhDQUEyQztBQUUzQyxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUVuRSxNQUFNLHlCQUF5QixHQUFHLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3pFLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ2pELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNoQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFhcEMsbUJBQXdCLElBQXNCLEVBQUUsTUFBc0I7SUFDcEUsTUFBTSxPQUFPLEdBQWlCLEVBQUUsQ0FBQztJQUNqQyxJQUFJLEtBQUssR0FBa0IsSUFBSSxDQUFDO0lBRWhDLE1BQU0sV0FBVyxHQUFHLENBQ2xCLElBQUksQ0FBQyxXQUFXO1dBQ2IsQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQztXQUN4RSxFQUFFLENBQ04sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVULE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUM1QixhQUFhLENBQUM7WUFDYixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDZixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsSUFBSSxNQUFNO1lBQ3JCLE1BQU0sRUFBRSwwRUFBMEU7U0FDbkYsQ0FBdUI7YUFDckIsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFH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QUFDLEVBQUUsRUFBRTtRQUN6QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRXZCLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLE1BQU0sRUFBRSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxZQUFZLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUVyRCxNQUFNLFVBQVUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUU1RSxPQUFPLEtBQUssQ0FBQyxvQ0FBb0MsR0FBRyxFQUFFLEVBQUU7WUFDdEQsSUFBSSxrQkFDRixJQUFJLEVBQUUsUUFBUSxFQUNkLEtBQUssRUFBRSxDQUFDLFlBQVksRUFDcEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQ2IsVUFBVSxFQUFFLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDNUMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLElBQ2QsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUM5QztZQUNELEtBQUssRUFBRSxXQUFXO1NBQ25CLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQXhGRCw0QkF3RkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby1pbXBsaWNpdC1kZXBlbmRlbmNpZXNcbmltcG9ydCB7IEpzb25PYmplY3QsIGxvZ2dpbmcgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBwYWNrYWdlcyB9IGZyb20gJy4uL2xpYi9wYWNrYWdlcyc7XG5cbmNvbnN0IGNoYW5nZWxvZ1RlbXBsYXRlID0gcmVxdWlyZSgnLi90ZW1wbGF0ZXMvY2hhbmdlbG9nJykuZGVmYXVsdDtcblxuY29uc3QgY29udmVudGlvbmFsQ29tbWl0c1BhcnNlciA9IHJlcXVpcmUoJ2NvbnZlbnRpb25hbC1jb21taXRzLXBhcnNlcicpO1xuY29uc3QgZ2l0UmF3Q29tbWl0cyA9IHJlcXVpcmUoJ2dpdC1yYXctY29tbWl0cycpO1xuY29uc3QgZ2hHb3QgPSByZXF1aXJlKCdnaC1nb3QnKTtcbmNvbnN0IHRocm91Z2ggPSByZXF1aXJlKCd0aHJvdWdoMicpO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hhbmdlbG9nT3B0aW9ucyB7XG4gIGZyb206IHN0cmluZztcbiAgdG8/OiBzdHJpbmc7XG4gIGdpdGh1YlRva2VuRmlsZT86IHN0cmluZztcbiAgZ2l0aHViVG9rZW4/OiBzdHJpbmc7XG5cbiAgc3Rkb3V0PzogYm9vbGVhbjtcbn1cblxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbihhcmdzOiBDaGFuZ2Vsb2dPcHRpb25zLCBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyKSB7XG4gIGNvbnN0IGNvbW1pdHM6IEpzb25PYmplY3RbXSA9IFtdO1xuICBsZXQgdG9TaGE6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0IGdpdGh1YlRva2VuID0gKFxuICAgIGFyZ3MuZ2l0aHViVG9rZW5cbiAgICB8fCAoYXJncy5naXRodWJUb2tlbkZpbGUgJiYgZnMucmVhZEZpbGVTeW5jKGFyZ3MuZ2l0aHViVG9rZW5GaWxlLCAndXRmLTgnKSlcbiAgICB8fCAnJ1xuICApLnRyaW0oKTtcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAoZ2l0UmF3Q29tbWl0cyh7XG4gICAgICBmcm9tOiBhcmdzLmZyb20sXG4gICAgICB0bzogYXJncy50byB8fCAnSEVBRCcsXG4gICAgICBmb3JtYXQ6ICclQiVuLWhhc2gtJW4lSCVuLWdpdFRhZ3MtJW4lRCVuLWNvbW1pdHRlckRhdGUtJW4lY2klbi1hdXRob3JOYW1lLSVuJWFOJW4nLFxuICAgIH0pIGFzIE5vZGVKUy5SZWFkU3RyZWFtKVxuICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgICAgIGxvZ2dlci5mYXRhbCgnQW4gZXJyb3IgaGFwcGVuZWQ6ICcgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH0pXG4gICAgICAucGlwZSh0aHJvdWdoKChjaHVuazogQnVmZmVyLCBlbmM6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgIC8vIFJlcGxhY2UgZ2l0aHViIFVSTHMgd2l0aCBgQFhZWiMxMjNgXG4gICAgICAgIGNvbnN0IGNvbW1pdCA9IGNodW5rLnRvU3RyaW5nKCd1dGYtOCcpXG4gICAgICAgICAgLnJlcGxhY2UoL2h0dHBzPzpcXC9cXC9naXRodWIuY29tXFwvKC4qPylcXC9pc3N1ZXNcXC8oXFxkKykvZywgJ0AkMSMkMicpO1xuXG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgbmV3IEJ1ZmZlcihjb21taXQpKTtcbiAgICAgIH0pKVxuICAgICAgLnBpcGUoY29udmVudGlvbmFsQ29tbWl0c1BhcnNlcih7XG4gICAgICAgIGhlYWRlclBhdHRlcm46IC9eKFxcdyopKD86XFwoKFteKV0qKVxcKSk/OiAoLiopJC8sXG4gICAgICAgIGhlYWRlckNvcnJlc3BvbmRlbmNlOiBbJ3R5cGUnLCAnc2NvcGUnLCAnc3ViamVjdCddLFxuICAgICAgICBub3RlS2V5d29yZHM6IFsnQlJFQUtJTkcgQ0hBTkdFJ10sXG4gICAgICAgIHJldmVydFBhdHRlcm46IC9ecmV2ZXJ0OlxccyhbXFxzXFxTXSo/KVxccypUaGlzIHJldmVydHMgY29tbWl0IChcXHcqKVxcLi8sXG4gICAgICAgIHJldmVydENvcnJlc3BvbmRlbmNlOiBbYGhlYWRlcmAsIGBoYXNoYF0sXG4gICAgICB9KSlcbiAgICAgIC5waXBlKHRocm91Z2gub2JqKChjaHVuazogSnNvbk9iamVjdCwgXzogc3RyaW5nLCBjYjogRnVuY3Rpb24pID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBtYXliZVRhZyA9IGNodW5rLmdpdFRhZ3MgJiYgKGNodW5rLmdpdFRhZ3MgYXMgc3RyaW5nKS5tYXRjaCgvdGFnOiAoLiopLyk7XG4gICAgICAgICAgY29uc3QgdGFncyA9IG1heWJlVGFnICYmIG1heWJlVGFnWzFdLnNwbGl0KC8sL2cpO1xuICAgICAgICAgIGNodW5rWyd0YWdzJ10gPSB0YWdzO1xuXG4gICAgICAgICAgaWYgKHRhZ3MgJiYgdGFncy5maW5kKHggPT4geCA9PSBhcmdzLnRvKSkge1xuICAgICAgICAgICAgdG9TaGEgPSBjaHVuay5oYXNoIGFzIHN0cmluZztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb21taXRzLnB1c2goY2h1bmspO1xuICAgICAgICAgIGNiKCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGNiKGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pKVxuICAgICAgLm9uKCdmaW5pc2gnLCByZXNvbHZlKTtcbiAgfSlcbiAgICAudGhlbigoKSA9PiB7XG4gICAgICBjb25zdCBtYXJrZG93bjogc3RyaW5nID0gY2hhbmdlbG9nVGVtcGxhdGUoe1xuICAgICAgICAuLi5hcmdzLFxuICAgICAgICBpbmNsdWRlOiAoeDogc3RyaW5nLCB2OiB7fSkgPT4gcmVxdWlyZSgnLi8nICsgcGF0aC5qb2luKCd0ZW1wbGF0ZXMnLCB4KSkuZGVmYXVsdCh2KSxcbiAgICAgICAgY29tbWl0cyxcbiAgICAgICAgcGFja2FnZXMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGFyZ3Muc3Rkb3V0IHx8ICFnaXRodWJUb2tlbikge1xuICAgICAgICBjb25zb2xlLmxvZyhtYXJrZG93bik7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgd2UgbmVlZCB0byBlZGl0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuXG4gICAgICByZXR1cm4gZ2hHb3QoJ3JlcG9zL2FuZ3VsYXIvYW5ndWxhci1jbGkvcmVsZWFzZXMnKS50aGVuKCh4OiBKc29uT2JqZWN0KSA9PiBbeCwgbWFya2Rvd25dKTtcbiAgICB9KVxuICAgIC50aGVuKChbYm9keSwgbWFya2Rvd25dKSA9PiB7XG4gICAgICBjb25zdCBqc29uID0gYm9keS5ib2R5O1xuXG4gICAgICBjb25zdCBtYXliZVJlbGVhc2UgPSBqc29uLmZpbmQoKHg6IEpzb25PYmplY3QpID0+IHgudGFnX25hbWUgPT0gYXJncy50byk7XG4gICAgICBjb25zdCBpZCA9IG1heWJlUmVsZWFzZSA/IGAvJHttYXliZVJlbGVhc2UuaWR9YCA6ICcnO1xuXG4gICAgICBjb25zdCBzZW12ZXJzaW9uID0gKGFyZ3MudG8gJiYgc2VtdmVyLnBhcnNlKGFyZ3MudG8pKSB8fCB7IHByZXJlbGVhc2U6ICcnIH07XG5cbiAgICAgIHJldHVybiBnaEdvdCgncmVwb3MvYW5ndWxhci9hbmd1bGFyLWNsaS9yZWxlYXNlcycgKyBpZCwge1xuICAgICAgICBib2R5OiB7XG4gICAgICAgICAgYm9keTogbWFya2Rvd24sXG4gICAgICAgICAgZHJhZnQ6ICFtYXliZVJlbGVhc2UsXG4gICAgICAgICAgbmFtZTogYXJncy50byxcbiAgICAgICAgICBwcmVyZWxlYXNlOiBzZW12ZXJzaW9uLnByZXJlbGVhc2UubGVuZ3RoID4gMCxcbiAgICAgICAgICB0YWdfbmFtZTogYXJncy50byxcbiAgICAgICAgICAuLi4odG9TaGEgPyB7IHRhcmdldF9jb21taXRpc2g6IHRvU2hhIH0gOiB7fSksXG4gICAgICAgIH0sXG4gICAgICAgIHRva2VuOiBnaXRodWJUb2tlbixcbiAgICAgIH0pO1xuICAgIH0pO1xufVxuIl19